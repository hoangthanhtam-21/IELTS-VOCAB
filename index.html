<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Vocab Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .bg-main {
            background-image: url('https://static.vecteezy.com/system/resources/thumbnails/069/144/917/small/colorful-school-supplies-background-image-2023-vector.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        .animate-pop {
            animation: pop 0.3s ease-out;
        }

        @keyframes pop {
            0% { transform: scale(0.98); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .heart-beat {
            animation: beat 1s infinite;
        }

        @keyframes beat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
    </style>
</head>
<body class="bg-main min-h-screen flex items-center justify-center p-4 overflow-hidden">

    <div id="app" class="w-full flex justify-center items-center min-h-[600px] max-h-screen">
        <!-- Loading state -->
        <div class="bg-white p-12 rounded-3xl shadow-xl flex flex-col items-center gap-4">
            <i class="fas fa-circle-notch fa-spin text-4xl text-indigo-600"></i>
            <p class="font-bold text-slate-600">Loading resources...</p>
        </div>
    </div>

    <script>
        const apiKey = ""; 
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'ielts-vocab-master';

        let state = {
            view: 'topics',
            lastView: null,
            score: 0,
            timeLeft: 300,
            lives: 3,
            consecutiveWrong: 0,
            masteredWords: new Set(),
            currentQuizIndex: 0,
            quizPool: [],
            quizFeedback: null,
            selectedReadingId: null,
            readingSubmitted: false,
            readingAnswers: { summary: {}, comp: {}, word: {} },
            shuffledWordChoices: [],
            activeTooltip: null,
            timerInterval: null,
            vocabBank: [],
            readingLevels: [],
            isLoading: true,
            isGenerating: false
        };

        const loadExternalData = async () => {
            try {
                const response = await fetch('architecture.json');
                if (!response.ok) throw new Error('Could not find architecture.json');
                const data = await response.json();
                
                // MAP DATA FROM NEW JSON STRUCTURE (Word, Meaning, Synonym)
                state.vocabBank = data.vocab.map(item => ({
                    word: item.Word || item.word,
                    definition: item.Meaning || item.definition,
                    examples: item.Synonym || item.examples,
                    id: item.ID || item.id
                }));
                
                state.readingLevels = data.levels;
                state.isLoading = false;
                render();
            } catch (error) {
                console.error('Failed to load JSON:', error);
                document.getElementById('app').innerHTML = `
                    <div class="bg-white p-8 rounded-3xl shadow-xl text-center">
                        <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                        <p class="font-bold text-slate-800">External data not found</p>
                        <p class="text-sm text-slate-500 mb-4">Make sure architecture.json is in the same folder.</p>
                        <button onclick="location.reload()" class="bg-indigo-600 text-white px-6 py-2 rounded-xl font-bold">Retry</button>
                    </div>
                `;
            }
        };

        const generateAIReading = async () => {
            if (state.isGenerating) return;
            state.isGenerating = true;
            render();

            try {
                const wordList = state.vocabBank.map(v => v.word).join(', ');
                const prompt = `Create an IELTS Reading Level 2 passage about architecture. 
                Use at least 8 of these words: ${wordList}.
                Return ONLY a JSON object with this exact structure:
                {
                  "title": "String",
                  "wordCount": "String",
                  "genre": "String",
                  "content": "A 200-word passage",
                  "summary": "A 3-sentence summary with (1)__________, (2)__________ blanks",
                  "summaryAnswers": ["answer1", "answer2"],
                  "comprehension": [{"q": "Question", "type": "TF", "a": "True/False", "evidence": "sentence from text"}],
                  "wordChoice": [{"q": "Sentence with _____", "options": ["Option A", "Option B"], "a": "Option A"}]
                }`;

                const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await resp.json();
                const rawText = data.candidates[0].content.parts[0].text;
                const cleanedJson = rawText.replace(/```json|```/g, '').trim();
                const newLevel = JSON.parse(cleanedJson);
                
                newLevel.id = Date.now();
                state.readingLevels.push(newLevel);
                state.selectedReadingId = newLevel.id;
                state.readingAnswers = { summary: {}, comp: {}, word: {} };
                state.readingSubmitted = false;
                state.shuffledWordChoices = newLevel.wordChoice.map(q => ({
                    ...q,
                    shuffledOptions: shuffle([...q.options])
                }));
            } catch (err) {
                console.error("AI Generation failed:", err);
            } finally {
                state.isGenerating = false;
                render();
            }
        };

        const shuffle = (array) => [...array].sort(() => Math.random() - 0.5);

        const playSound = (type) => {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain); gain.connect(ctx.destination);
                if (type === 'correct') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(880, ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(440, ctx.currentTime + 0.1);
                    gain.gain.setValueAtTime(0.1, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
                } else {
                    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(220, ctx.currentTime);
                    osc.frequency.linearRampToValueAtTime(110, ctx.currentTime + 0.2);
                    gain.gain.setValueAtTime(0.1, ctx.currentTime);
                    gain.gain.linearRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                }
                osc.start(); osc.stop(ctx.currentTime + (type === 'correct' ? 0.1 : 0.2));
            } catch (e) {}
        };

        const render = () => {
            if (state.isLoading) return;
            const app = document.getElementById('app');
            let scrollPos = 0;
            const scrollContainer = document.getElementById('reading-scroll-container');
            if (scrollContainer) scrollPos = scrollContainer.scrollTop;
            const isNewView = state.view !== state.lastView;
            state.lastView = state.view;
            app.innerHTML = '';
            let content;
            switch (state.view) {
                case 'topics': content = createTopicSelection(); break;
                case 'menu': content = createMenu(); break;
                case 'quiz': content = createQuiz(); break;
                case 'reading': content = createReadingView(); break;
                case 'listening': content = createListeningView(); break;
                case 'result': content = createResultView(); break;
            }
            if (isNewView) content.classList.add('animate-pop');
            app.appendChild(content);
            const newScrollContainer = document.getElementById('reading-scroll-container');
            if (newScrollContainer) newScrollContainer.scrollTop = scrollPos;
        };

        const createTopicSelection = () => {
            const container = document.createElement('div');
            container.className = "flex flex-col gap-6 p-8 bg-white/90 backdrop-blur-md rounded-3xl shadow-2xl max-w-4xl w-full border border-white/20";
            container.innerHTML = `
                <div class="text-center mb-4">
                    <h1 class="text-4xl font-black text-slate-800 tracking-tighter mb-2">IELTS Vocab Master</h1>
                    <p class="text-slate-500 font-medium italic text-sm">Select a topic to start your vocabulary journey</p>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="topic-grid"></div>
            `;
            const topics = [
                { id: 'architecture', name: 'Architecture', active: true, icon: 'fa-city text-indigo-600' },
                { id: 'tech', name: 'Technology', active: false, icon: 'fa-microchip text-slate-400' },
                { id: 'nature', name: 'Environment', active: false, icon: 'fa-leaf text-slate-400' },
                { id: 'business', name: 'Business', active: false, icon: 'fa-briefcase text-slate-400' },
                { id: 'health', name: 'Health', active: false, icon: 'fa-heart text-slate-400' },
                { id: 'culture', name: 'Culture', active: false, icon: 'fa-landmark text-slate-400' },
                { id: 'education', name: 'Education', active: false, icon: 'fa-user-graduate text-slate-400' },
                { id: 'travel', name: 'Travel', active: false, icon: 'fa-plane text-slate-400' },
            ];
            const grid = container.querySelector('#topic-grid');
            topics.forEach(t => {
                const btn = document.createElement('button');
                btn.className = `group relative p-6 rounded-2xl border-2 transition-all duration-300 flex flex-col items-center gap-3 h-40 justify-center ${t.active ? 'bg-white border-indigo-100 shadow-lg hover:border-indigo-500 hover:shadow-indigo-200 hover:-translate-y-1' : 'bg-slate-50/50 border-slate-100 opacity-60 grayscale cursor-not-allowed'}`;
                btn.innerHTML = `
                    <div class="p-3 rounded-xl transition-colors ${t.active ? 'bg-indigo-50 group-hover:bg-indigo-100' : 'bg-slate-100'}">
                        <i class="fas ${t.icon} text-2xl"></i>
                    </div>
                    <span class="font-bold ${t.active ? 'text-slate-800' : 'text-slate-400'}">${t.name}</span>
                    ${!t.active ? '<div class="absolute top-2 right-2 text-slate-300"><i class="fas fa-lock text-xs"></i></div>' : ''}
                `;
                if (t.active) btn.onclick = () => { state.view = 'menu'; render(); };
                grid.appendChild(btn);
            });
            return container;
        };

        const createMenu = () => {
            const container = document.createElement('div');
            container.className = "flex flex-col gap-6 p-8 text-center bg-white rounded-3xl shadow-xl max-w-md w-full border border-slate-100";
            container.innerHTML = `
                <div class="flex items-center gap-2 mb-2">
                    <button onclick="state.view = 'topics'; render();" class="p-2 hover:bg-slate-100 rounded-xl text-slate-400 transition-colors">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span class="text-xs font-black text-indigo-400 uppercase tracking-widest">Topic: Architecture</span>
                </div>
                <div class="flex justify-center mb-2">
                    <div class="w-24 h-24 bg-white rounded-2xl overflow-hidden shadow-sm flex items-center justify-center p-1 border border-slate-50">
                        <img src="logo.jpg" onerror="this.src='https://via.placeholder.com/100/6366f1/ffffff?text=IELTS'" alt="Logo" class="w-full h-full object-contain">
                    </div>
                </div>
                <h2 class="text-3xl font-extrabold text-slate-800 tracking-tight">Architecture</h2>
                <button onclick="startQuiz()" class="py-4 px-6 bg-indigo-600 hover:bg-indigo-700 text-white rounded-2xl font-bold shadow-lg flex items-center justify-center gap-2 transition-all hover:scale-[1.02]">
                    <i class="fas fa-bolt"></i><span>Vocab Practice (5 Mins)</span>
                </button>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="state.view = 'reading'; render();" class="p-4 bg-emerald-50 text-emerald-700 border-2 border-emerald-100 rounded-2xl font-semibold hover:bg-emerald-100 flex flex-col items-center gap-2 transition-all hover:scale-[1.02]"><i class="fas fa-book"></i><span>Reading</span></button>
                    <button onclick="state.view = 'listening'; render();" class="p-4 bg-amber-50 text-amber-700 border-2 border-amber-100 rounded-2xl font-semibold hover:bg-amber-100 flex flex-col items-center gap-2 transition-all hover:scale-[1.02]"><i class="fas fa-headphones"></i><span>Listening</span></button>
                </div>
            `;
            return container;
        };

        const startQuiz = () => {
            state.quizPool = state.vocabBank.map(v => {
                const distractors = state.vocabBank.filter(x => x.word.toLowerCase() !== v.word.toLowerCase()).map(x => x.definition);
                return { ...v, streak: 0, fixedOptions: shuffle([...shuffle(distractors).slice(0, 3), v.definition]) };
            });
            state.quizPool = shuffle(state.quizPool);
            state.score = 0; state.timeLeft = 300; state.lives = 3; state.consecutiveWrong = 0;
            state.masteredWords = new Set(); state.currentQuizIndex = 0; state.view = 'quiz';
            startTimer(); render();
        };

        const startTimer = () => {
            if (state.timerInterval) clearInterval(state.timerInterval);
            state.timerInterval = setInterval(() => {
                state.timeLeft--;
                if (state.timeLeft <= 0) { clearInterval(state.timerInterval); finishGame(); }
                else {
                    const timerDisp = document.getElementById('timer-display');
                    if (timerDisp) timerDisp.innerText = `${Math.floor(state.timeLeft / 60)}:${(state.timeLeft % 60).toString().padStart(2, '0')}`;
                }
            }, 1000);
        };

        const createQuiz = () => {
            const item = state.quizPool[state.currentQuizIndex];
            const container = document.createElement('div');
            container.className = "bg-white rounded-3xl shadow-2xl p-6 max-w-md w-full h-[550px] flex flex-col justify-between relative";
            const timerPercent = (state.timeLeft / 300) * 100;
            container.innerHTML = `
                <div class="absolute top-0 left-0 h-1.5 bg-indigo-600 transition-all duration-1000" style="width: ${timerPercent}%"></div>
                <div>
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center gap-3">
                            <div class="flex flex-col"><span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Score</span><span class="text-indigo-600 text-xl font-black">${state.score}</span></div>
                            <div class="flex gap-1 ml-4" id="lives-container"></div>
                        </div>
                        <div id="timer-display" class="text-xl font-mono font-bold text-slate-600">${Math.floor(state.timeLeft / 60)}:${(state.timeLeft % 60).toString().padStart(2, '0')}</div>
                    </div>
                    <div class="text-center mb-8"><h2 class="text-4xl font-black text-slate-800 mb-3 capitalize tracking-tight">${item.word}</h2><div class="grid gap-2.5" id="options-container"></div></div>
                </div>
            `;
            const optsCont = container.querySelector('#options-container');
            item.fixedOptions.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = `p-3.5 rounded-2xl text-left font-medium border-2 transition-all duration-300 border-slate-100 hover:border-indigo-200 hover:bg-slate-50`;
                btn.innerText = opt;
                btn.onclick = () => handleQuizAnswer(idx);
                optsCont.appendChild(btn);
            });
            return container;
        };

        const handleQuizAnswer = (idx) => {
            const item = state.quizPool[state.currentQuizIndex];
            const correctIdx = item.fixedOptions.indexOf(item.definition);
            const isCorrect = idx === correctIdx;
            playSound(isCorrect ? 'correct' : 'wrong');
            if (isCorrect) { state.score += 10; item.streak++; if (item.streak >= 3) state.masteredWords.add(item.word); }
            else { state.lives--; item.streak = 0; }
            if (state.lives <= 0 || state.masteredWords.size === state.vocabBank.length) { clearInterval(state.timerInterval); finishGame(); return; }
            state.currentQuizIndex = (state.currentQuizIndex + 1) % state.quizPool.length;
            render();
        };

        const finishGame = () => { state.view = 'result'; render(); };

        const createResultView = () => {
            const container = document.createElement('div');
            container.className = "bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full text-center border border-slate-100 animate-pop";
            container.innerHTML = `
                <div class="flex justify-center mb-4"><i class="fas fa-award text-5xl text-amber-500"></i></div>
                <h2 class="text-xl font-bold text-slate-500 uppercase tracking-widest">Session Results</h2>
                <div class="text-5xl my-6 tracking-tighter">Done!</div>
                <button onclick="state.view = 'menu'; render();" class="w-full py-4 bg-slate-800 text-white rounded-2xl font-bold hover:bg-slate-900 transition-all shadow-lg">Back to Menu</button>
            `;
            return container;
        };

        const createReadingView = () => {
            if (!state.selectedReadingId) {
                const container = document.createElement('div');
                container.className = "bg-white rounded-3xl shadow-xl p-8 max-w-2xl w-full h-[600px] flex flex-col";
                container.innerHTML = `
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <button onclick="state.view = 'menu'; render();" class="p-2 hover:bg-slate-100 rounded-xl transition-colors"><i class="fas fa-chevron-left"></i></button>
                            <h2 class="text-2xl font-bold">Reading Practice</h2>
                        </div>
                        <button id="ai-gen-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-xs font-bold hover:bg-indigo-700 transition-all flex items-center gap-2">
                            ${state.isGenerating ? '<i class="fas fa-spinner fa-spin"></i> Generating...' : '<i class="fas fa-magic"></i> Generate AI Passage'}
                        </button>
                    </div>
                    <div class="flex-1 overflow-y-auto custom-scrollbar pr-2 grid gap-4" id="reading-levels-grid"></div>
                `;
                const grid = container.querySelector('#reading-levels-grid');
                state.readingLevels.forEach(l => {
                    const btn = document.createElement('button');
                    btn.className = "flex items-center justify-between p-6 border-2 border-slate-100 rounded-2xl hover:border-indigo-500 hover:bg-indigo-50 group transition-all";
                    btn.innerHTML = `
                        <div class="text-left"><div class="font-bold text-lg text-slate-800 group-hover:text-indigo-700">${l.title}</div><div class="text-xs text-slate-400 font-bold uppercase tracking-widest">${l.genre} • ${l.wordCount}</div></div><div class="text-indigo-600">→</div>
                    `;
                    btn.onclick = () => { state.selectedReadingId = l.id; state.readingSubmitted = false; state.shuffledWordChoices = l.wordChoice.map(q => ({ ...q, shuffledOptions: shuffle([...q.options]) })); render(); };
                    grid.appendChild(btn);
                });
                container.querySelector('#ai-gen-btn').onclick = generateAIReading;
                return container;
            }
            const level = state.readingLevels.find(l => l.id === state.selectedReadingId);
            const container = document.createElement('div');
            container.className = "bg-white rounded-3xl shadow-xl w-full max-w-7xl h-[95vh] flex flex-col overflow-hidden";
            container.innerHTML = `
                <div class="flex justify-between items-center px-8 py-4 border-b shrink-0 bg-white z-10">
                    <div class="flex items-center gap-4"><button onclick="state.selectedReadingId = null; render();" class="p-2 hover:bg-slate-100 rounded-xl transition-colors"><i class="fas fa-chevron-left"></i></button><div><h2 class="text-2xl font-black text-slate-800 uppercase tracking-tight">${level.title}</h2></div></div><button onclick="state.selectedReadingId = null; render();" class="text-slate-400 hover:text-red-500 font-bold px-4 py-2 hover:bg-red-50 rounded-xl transition-colors">Close ✕</button>
                </div>
                <div class="flex-1 overflow-y-auto custom-scrollbar p-6 space-y-8" id="reading-scroll-container">
                    <div class="bg-slate-50 rounded-3xl p-8 border border-slate-100 shadow-inner" id="article-content"><p class="text-slate-700 leading-relaxed text-lg font-serif select-none">${level.content}</p></div>
                    <div id="questions-content"></div>
                </div>
            `;
            return container;
        };

        const createListeningView = () => {
            const container = document.createElement('div');
            container.className = "bg-white rounded-3xl shadow-xl p-8 max-w-2xl w-full text-center";
            container.innerHTML = `<button onclick="state.view = 'menu'; render();" class="py-4 px-12 bg-slate-800 text-white rounded-2xl font-bold">Back</button>`;
            return container;
        };

        window.onload = loadExternalData;
    </script>
</body>
</html>
