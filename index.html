<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IELTS Vocab Master</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root{--bg:#0d0d0f;--surface:#16161a;--surface2:#1e1e24;--border:#2a2a35;--accent:#e8c547;--accent2:#7c6ee0;--accent3:#4ecdc4;--text:#f0eff4;--text2:#9d9daf;--danger:#ff6b6b;--success:#6bcb77;--radius:16px;}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");pointer-events:none;z-index:0;}
#app{position:relative;z-index:1;max-width:900px;margin:0 auto;padding:24px 20px 80px;}

/* â”€â”€ UTILITIES â”€â”€ */
input,textarea,select{background:var(--surface2);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;padding:10px 14px;width:100%;outline:none;transition:border .2s;}
input:focus,textarea:focus,select:focus{border-color:var(--accent2);}
label{font-size:12px;color:var(--text2);display:block;margin-bottom:6px;}
.btn{padding:10px 20px;border:none;border-radius:10px;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;transition:all .15s;display:inline-flex;align-items:center;gap:6px;}
.btn-p{background:var(--accent);color:#0d0d0f;}.btn-p:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(232,197,71,.3);}
.btn-s{background:transparent;color:var(--text2);border:1px solid var(--border);}.btn-s:hover{border-color:var(--text2);color:var(--text);}
.btn-d{background:#2a1010;color:var(--danger);border:1px solid var(--danger);}.btn-d:hover{background:#3a1010;}
.btn-sm{padding:6px 12px;font-size:12px;border-radius:8px;}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:24px;}
.section-title{font-family:'Playfair Display',serif;font-size:22px;font-weight:700;}
.screen{display:none;animation:fadeIn .25s ease;}.screen.active{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:none;}}
.toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(16px);background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:11px 22px;font-size:14px;opacity:0;pointer-events:none;transition:all .3s;z-index:9999;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
.spinner{display:inline-block;width:18px;height:18px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle;}
@keyframes spin{to{transform:rotate(360deg);}}

/* â”€â”€ LOADING â”€â”€ */
#overlay{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9998;gap:14px;}
#overlay.hidden{display:none;}
.ov-logo{font-family:'Playfair Display',serif;font-size:30px;font-weight:900;color:var(--accent);}
.ov-msg{font-size:13px;color:var(--text2);}

/* â”€â”€ SETUP â”€â”€ */
.setup-wrap{max-width:460px;margin:60px auto;}
.setup-wrap h2{font-family:'Playfair Display',serif;font-size:22px;margin-bottom:10px;}
.setup-wrap p{color:var(--text2);font-size:14px;line-height:1.7;margin-bottom:22px;}
.setup-field{margin-bottom:14px;}
.api-note{font-size:12px;color:var(--text2);margin-top:18px;line-height:1.7;padding:14px;background:var(--surface2);border-radius:10px;}
.api-note a{color:var(--accent3);text-decoration:none;}.api-note a:hover{text-decoration:underline;}

/* â”€â”€ HEADER â”€â”€ */
header{display:flex;align-items:center;justify-content:space-between;padding-bottom:26px;border-bottom:1px solid var(--border);margin-bottom:30px;flex-wrap:wrap;gap:10px;}
.logo-text{font-family:'Playfair Display',serif;font-size:26px;font-weight:900;color:var(--accent);letter-spacing:-1px;}
.logo-sub{font-size:11px;color:var(--text2);letter-spacing:3px;text-transform:uppercase;margin-left:8px;}
.hstats{display:flex;gap:18px;}
.hstat-num{font-family:'Playfair Display',serif;font-size:20px;font-weight:700;color:var(--accent);}
.hstat-lbl{font-size:10px;color:var(--text2);letter-spacing:2px;text-transform:uppercase;}
.admin-gear{font-size:18px;cursor:pointer;opacity:.35;transition:opacity .2s;border:none;background:none;color:var(--text);padding:4px;}
.admin-gear:hover{opacity:.8;}

/* â”€â”€ NAV â”€â”€ */
.nav-tabs{display:flex;gap:5px;background:var(--surface);border-radius:13px;padding:5px;margin-bottom:28px;}
.tab-btn{flex:1;padding:10px 6px;border:none;border-radius:9px;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;background:transparent;color:var(--text2);transition:all .2s;}
.tab-btn.active{background:var(--accent);color:#0d0d0f;font-weight:600;}
.tab-btn:hover:not(.active){color:var(--text);background:var(--surface2);}

/* â”€â”€ TOPIC GRID â”€â”€ */
.topic-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:14px;margin-bottom:20px;}
.topic-card{background:var(--surface);border-radius:var(--radius);padding:20px;border:1px solid var(--border);cursor:pointer;transition:all .2s;}
.topic-card:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.35);}
.t-emoji{font-size:28px;margin-bottom:10px;}
.t-name{font-family:'Playfair Display',serif;font-size:17px;font-weight:700;margin-bottom:4px;}
.t-meta{font-size:12px;color:var(--text2);}
.t-bar{height:3px;background:var(--border);border-radius:2px;margin-top:10px;overflow:hidden;}
.t-bar-fill{height:100%;border-radius:2px;transition:width .4s;}
.t-pct{font-size:11px;color:var(--success);margin-top:5px;}
.detail-hdr{display:flex;align-items:center;gap:10px;margin-bottom:18px;padding-bottom:14px;border-bottom:1px solid var(--border);flex-wrap:wrap;}
.back-btn{background:var(--surface2);border:1px solid var(--border);border-radius:9px;padding:7px 13px;cursor:pointer;font-size:13px;color:var(--text2);font-family:'DM Sans',sans-serif;transition:all .15s;}
.back-btn:hover{color:var(--text);border-color:var(--text2);}
.detail-title{font-family:'Playfair Display',serif;font-size:19px;font-weight:700;}
.detail-badge{background:var(--accent);color:#0d0d0f;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700;margin-left:auto;}
.chip-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(185px,1fr));gap:9px;margin-bottom:22px;}
.chip{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:10px 13px;cursor:pointer;transition:all .15s;}
.chip:hover{border-color:var(--accent2);}
.chip.done{border-color:var(--success);opacity:.6;}
.chip-word{font-weight:600;font-size:14px;display:flex;align-items:center;gap:6px;}
.chip-vn{font-size:12px;color:var(--text2);margin-top:2px;}
.dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.s-new{background:#7eb8f7;}.s-learning{background:var(--accent2);}.s-review{background:var(--accent);}.s-mastered{background:var(--success);}
.topic-actions{display:flex;gap:10px;flex-wrap:wrap;}

/* â”€â”€ STUDY â”€â”€ */
.study-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;}
.prg-wrap{flex:1;height:6px;background:var(--surface2);border-radius:3px;margin:0 14px;overflow:hidden;}
.prg-fill{height:100%;background:linear-gradient(90deg,var(--accent2),var(--accent));border-radius:3px;transition:width .4s;}
.study-cnt{font-size:13px;color:var(--text2);white-space:nowrap;}
.acc-row{display:flex;gap:6px;align-items:center;justify-content:center;margin-bottom:12px;}
.acc-btn{padding:5px 13px;border-radius:20px;border:1px solid var(--border);background:transparent;color:var(--text2);cursor:pointer;font-size:12px;font-family:'DM Sans',sans-serif;transition:all .15s;}
.acc-btn.active{background:var(--accent2);border-color:var(--accent2);color:#fff;}
.acc-lbl{font-size:11px;color:var(--text2);letter-spacing:1px;}
.card-wrap{perspective:1000px;margin:0 auto 22px;max-width:530px;}
.flashcard{position:relative;width:100%;padding-top:54%;transform-style:preserve-3d;transition:transform .5s cubic-bezier(.4,0,.2,1);cursor:pointer;}
.flashcard.flipped{transform:rotateY(180deg);}
.card-face{position:absolute;inset:0;border-radius:20px;padding:26px;display:flex;flex-direction:column;justify-content:center;align-items:center;backface-visibility:hidden;-webkit-backface-visibility:hidden;border:1px solid var(--border);}
.cf{background:linear-gradient(135deg,#1a1a22,#16161e);}
.cb{background:linear-gradient(135deg,#1a1e2a,#161822);transform:rotateY(180deg);}
.c-tag{font-size:11px;letter-spacing:2px;text-transform:uppercase;color:var(--text2);margin-bottom:12px;}
.c-word{font-family:'Playfair Display',serif;font-size:40px;font-weight:900;color:var(--accent);text-align:center;line-height:1.1;}
.c-ph{font-size:15px;color:var(--accent2);margin-top:7px;}
.c-type{font-size:12px;color:var(--text2);margin-top:4px;font-style:italic;}
.c-def{font-size:16px;color:var(--text);text-align:center;line-height:1.6;}
.c-ex{font-size:13px;color:var(--text2);font-style:italic;text-align:center;margin-top:9px;line-height:1.5;padding:0 10px;}
.c-vn{font-size:14px;color:var(--accent3);margin-top:8px;font-weight:500;}
.c-hint{font-size:11px;color:var(--border);margin-top:8px;}
.speak-btn{display:inline-flex;align-items:center;gap:6px;padding:6px 13px;border-radius:20px;border:1px solid var(--border);background:var(--surface2);color:var(--text2);cursor:pointer;font-size:12px;font-family:'DM Sans',sans-serif;transition:all .2s;margin-top:9px;}
.speak-btn:hover,.speak-btn.speaking{border-color:var(--accent3);color:var(--accent3);}
.speak-btn.speaking{animation:pls .8s ease infinite;}
@keyframes pls{0%,100%{box-shadow:0 0 0 0 rgba(78,205,196,.3);}50%{box-shadow:0 0 0 6px rgba(78,205,196,0);}}
.wave{display:flex;gap:2px;align-items:center;height:13px;}
.wave span{display:block;width:3px;background:currentColor;border-radius:2px;height:5px;}
.speaking .wave span:nth-child(1){animation:bar .6s 0s ease infinite;}
.speaking .wave span:nth-child(2){animation:bar .6s .15s ease infinite;}
.speaking .wave span:nth-child(3){animation:bar .6s .3s ease infinite;}
@keyframes bar{0%,100%{height:4px;}50%{height:12px;}}
.rating-area{display:none;}.rating-area.show{display:block;}
.r-lbl{font-size:12px;color:var(--text2);text-align:center;margin-bottom:11px;letter-spacing:1px;text-transform:uppercase;}
.r-btns{display:flex;gap:9px;justify-content:center;flex-wrap:wrap;}
.r-btn{flex:1;min-width:82px;max-width:135px;padding:12px 7px;border:2px solid transparent;border-radius:12px;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;transition:all .15s;text-align:center;}
.r-em{font-size:17px;display:block;margin-bottom:3px;}
.r-nx{display:block;font-size:10px;font-weight:400;margin-top:2px;opacity:.8;}
.r-again{background:#2a1010;border-color:var(--danger);color:var(--danger);}
.r-hard{background:#2a2010;border-color:#f0a500;color:#f0a500;}
.r-good{background:#10202a;border-color:var(--accent2);color:var(--accent2);}
.r-easy{background:#102a10;border-color:var(--success);color:var(--success);}
.done-box{text-align:center;padding:54px 20px;}
.done-box .big{font-size:50px;margin-bottom:13px;}
.done-box h3{font-family:'Playfair Display',serif;font-size:22px;margin-bottom:8px;color:var(--success);}
.done-box p{color:var(--text2);font-size:14px;line-height:1.7;}

/* â”€â”€ QUIZ â”€â”€ */
.quiz-stats{display:flex;gap:12px;margin-bottom:22px;}
.q-stat{flex:1;background:var(--surface);border-radius:12px;padding:13px;text-align:center;border:1px solid var(--border);}
.q-stat-num{font-family:'Playfair Display',serif;font-size:24px;font-weight:700;}
.q-stat-lbl{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:1.5px;}
.qtype-tabs{display:flex;gap:7px;margin-bottom:16px;}
.qtype-btn{flex:1;padding:9px 8px;border-radius:9px;border:1px solid var(--border);background:var(--surface);color:var(--text2);cursor:pointer;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:500;transition:all .15s;}
.qtype-btn.active{background:var(--accent2);border-color:var(--accent2);color:#fff;font-weight:600;}
.quiz-q-card{background:var(--surface);border-radius:var(--radius);padding:26px;border:1px solid var(--border);margin-bottom:16px;text-align:center;}
.q-type-lbl{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:2px;margin-bottom:12px;}
.q-word{font-family:'Playfair Display',serif;font-size:33px;font-weight:700;color:var(--accent);margin-bottom:6px;}
.q-ph{font-size:14px;color:var(--accent2);}
.blank-sent{font-size:17px;color:var(--text);line-height:1.8;text-align:center;padding:0 8px;margin-top:6px;}
.blank{display:inline-block;min-width:88px;border-bottom:2px solid var(--accent);color:var(--accent);font-weight:700;font-family:'Playfair Display',serif;font-size:19px;text-align:center;padding:0 5px;}
.quiz-opts{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:16px;}
.q-opt{padding:13px 16px;background:var(--surface);border:2px solid var(--border);border-radius:12px;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:14px;line-height:1.4;transition:all .15s;text-align:left;color:var(--text);}
.q-opt:hover:not(.disabled){border-color:var(--accent2);background:var(--surface2);}
.q-opt.correct{border-color:var(--success)!important;background:#102a10!important;color:var(--success)!important;font-weight:600;}
.q-opt.wrong{border-color:var(--danger)!important;background:#2a1010!important;color:var(--danger)!important;}
.q-opt.reveal{border-color:var(--success)!important;background:#0d2010!important;color:var(--success)!important;font-weight:600;animation:pc .4s ease;}
@keyframes pc{0%,100%{transform:scale(1);}50%{transform:scale(1.02);}}
.q-opt.disabled{cursor:default;opacity:.75;}
.quiz-next-btn{width:100%;padding:13px;background:var(--accent);color:#0d0d0f;border:none;border-radius:12px;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:15px;font-weight:600;display:none;}
.quiz-next-btn.show{display:block;}

/* â”€â”€ PROGRESS â”€â”€ */
.prog-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:13px;margin-bottom:26px;}
.prog-card{background:var(--surface);border-radius:var(--radius);padding:20px;border:1px solid var(--border);}
.prog-num{font-family:'Playfair Display',serif;font-size:36px;font-weight:900;line-height:1;}
.prog-lbl{font-size:12px;color:var(--text2);text-transform:uppercase;letter-spacing:1.5px;margin-top:5px;}
.pc1 .prog-num{color:#7eb8f7;}.pc2 .prog-num{color:var(--accent2);}.pc3 .prog-num{color:var(--accent);}.pc4 .prog-num{color:var(--success);}
.donut-wrap{display:flex;justify-content:center;margin:18px 0;}
svg.donut{transform:rotate(-90deg);}
.donut-ring{fill:none;stroke-width:18;}
.streak-box{background:var(--surface);border-radius:var(--radius);padding:20px;border:1px solid var(--border);}
.streak-lbl{font-size:13px;font-weight:600;margin-bottom:13px;color:var(--text2);text-transform:uppercase;letter-spacing:1px;}
.streak-days{display:flex;gap:5px;flex-wrap:wrap;}
.day{width:29px;height:29px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:10px;color:var(--text2);border:1px solid var(--border);}
.day.ok{background:var(--accent);color:#0d0d0f;border-color:var(--accent);font-weight:700;}

/* â”€â”€ ADMIN LOGIN â”€â”€ */
.login-wrap{max-width:340px;margin:80px auto;text-align:center;}
.login-wrap h2{font-family:'Playfair Display',serif;font-size:22px;margin-bottom:20px;}
.login-wrap input{margin-bottom:14px;text-align:center;letter-spacing:3px;font-size:17px;}
.login-err{color:var(--danger);font-size:13px;margin-top:8px;display:none;}

/* â”€â”€ ADMIN PANEL â”€â”€ */
.admin-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:10px;}
.admin-title{font-family:'Playfair Display',serif;font-size:20px;font-weight:700;color:var(--accent);}
.a-tabs{display:flex;gap:5px;background:var(--surface);border-radius:11px;padding:5px;margin-bottom:22px;}
.a-tab{flex:1;padding:9px 10px;border:none;border-radius:8px;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:13px;background:transparent;color:var(--text2);transition:all .2s;}
.a-tab.active{background:var(--accent2);color:#fff;font-weight:600;}
.a-screen{display:none;}.a-screen.active{display:block;}
.t-row{display:flex;align-items:center;gap:10px;background:var(--surface);border-radius:12px;padding:13px 15px;border:1px solid var(--border);margin-bottom:9px;}
.t-row-info{flex:1;}
.t-row-name{font-weight:600;font-size:14px;}
.t-row-count{font-size:12px;color:var(--text2);margin-top:2px;}
.form-2{display:grid;grid-template-columns:1fr 1fr;gap:11px;}
.form-3{display:grid;grid-template-columns:56px 1fr 90px;gap:11px;}
.w-table{width:100%;border-collapse:collapse;margin-top:14px;}
.w-table th{font-size:11px;letter-spacing:1.5px;text-transform:uppercase;color:var(--text2);padding:8px 11px;text-align:left;border-bottom:1px solid var(--border);}
.w-table td{padding:10px 11px;font-size:13px;border-bottom:1px solid var(--border);color:var(--text);}
.w-table tr:last-child td{border-bottom:none;}
.w-table tr:hover td{background:var(--surface2);}
.csv-drop{border:2px dashed var(--border);border-radius:12px;padding:26px;text-align:center;cursor:pointer;transition:all .2s;position:relative;background:var(--surface);}
.csv-drop:hover,.csv-drop.over{border-color:var(--accent);background:#1a1a10;}
.csv-drop input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}

/* â”€â”€ SPELLING STEP â”€â”€ */
#spelling-screen{display:none;}
.spell-tag{font-size:11px;letter-spacing:2px;text-transform:uppercase;color:var(--text2);margin-bottom:10px;text-align:center;}
.spell-listen{background:linear-gradient(135deg,#1a1a22,#16161e);border:1px solid var(--border);border-radius:20px;padding:32px 20px;text-align:center;margin-bottom:20px;}
.spell-listen-icon{font-size:52px;margin-bottom:10px;}
.spell-listen-lbl{font-size:14px;color:var(--text2);margin-bottom:16px;}
.spell-listen-ph{font-size:15px;color:var(--accent2);margin-top:6px;}
.spell-listen-type{font-size:12px;color:var(--text2);font-style:italic;margin-top:4px;}
.spell-opts{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;}
.spell-opt{padding:14px 12px;background:var(--surface);border:2px solid var(--border);border-radius:12px;cursor:pointer;font-family:'Playfair Display',serif;font-size:17px;font-weight:700;text-align:center;color:var(--text);transition:all .15s;letter-spacing:.5px;}
.spell-opt:hover:not(.disabled){border-color:var(--accent2);background:var(--surface2);}
.spell-opt.correct{border-color:var(--success)!important;background:#102a10!important;color:var(--success)!important;}
.spell-opt.wrong{border-color:var(--danger)!important;background:#2a1010!important;color:var(--danger)!important;animation:shake .3s ease;}
.spell-opt.disabled{cursor:default;}
@keyframes shake{0%,100%{transform:translateX(0);}25%{transform:translateX(-6px);}75%{transform:translateX(6px);}}
.chat-msg{max-width:82%;padding:11px 15px;border-radius:14px;font-size:14px;line-height:1.6;}
.chat-msg.user{background:var(--accent2);color:#fff;align-self:flex-end;border-bottom-right-radius:4px;}
.chat-msg.ai{background:var(--surface2);color:var(--text);align-self:flex-start;border-bottom-left-radius:4px;border:1px solid var(--border);}
.chat-msg.loading{opacity:.6;font-style:italic;}

/* â”€â”€ BALLOON GAME â”€â”€ */
.balloon{position:absolute;cursor:pointer;transition:transform .15s;user-select:none;}
.balloon:hover{transform:scale(1.05);}
.balloon-inner{position:relative;width:70px;height:85px;border-radius:50% 50% 50% 50%/60% 60% 40% 40%;display:flex;align-items:center;justify-content:center;font-family:'Playfair Display',serif;font-size:14px;font-weight:700;color:#fff;text-shadow:0 1px 3px rgba(0,0,0,.5);box-shadow:inset -5px -5px 15px rgba(0,0,0,.2),inset 5px 5px 15px rgba(255,255,255,.3);animation:float 3s ease-in-out infinite;}
@keyframes float{0%,100%{transform:translateY(0);}50%{transform:translateY(-8px);}}
.balloon-string{position:absolute;top:100%;left:50%;width:1px;height:30px;background:rgba(255,255,255,.4);transform-origin:top;}

@media(max-width:600px){
  .c-word{font-size:28px;}.quiz-opts{grid-template-columns:1fr;}
  .prog-grid{grid-template-columns:1fr 1fr;}.form-2,.form-3{grid-template-columns:1fr;}
  header{flex-direction:column;align-items:flex-start;}
}
</style>
</head>
<body>

<!-- Loading overlay -->
<div id="overlay">
  <div class="ov-logo">IELTS Vocab</div>
  <div class="spinner"></div>
  <div class="ov-msg" id="ov-msg">Äang khá»Ÿi Ä‘á»™ng...</div>
</div>

<div id="app" style="display:none">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SETUP (first run)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-setup" class="screen">
  <div class="setup-wrap">
    <div class="card">
      <div style="font-size:38px;margin-bottom:12px;text-align:center">âš™ï¸</div>
      <h2 style="text-align:center">CÃ i Ä‘áº·t láº§n Ä‘áº§u</h2>
      <p style="text-align:center">Káº¿t ná»‘i vá»›i JSONBin Ä‘á»ƒ lÆ°u tá»« vá»±ng trÃªn cloud â€” há»c sinh trÃªn má»i thiáº¿t bá»‹ Ä‘á»u tháº¥y cÃ¹ng ná»™i dung.</p>
      <div class="setup-field"><label>JSONBin Secret Key</label><input id="s-key" type="text" placeholder="$2b$10$..."></div>
      <div class="setup-field"><label>Anthropic API Key <span style="color:var(--text2);font-weight:400">(tuá»³ chá»n â€” Ä‘á»ƒ dÃ¹ng tÃ­nh nÄƒng AI)</span></label><input id="s-claude" type="text" placeholder="sk-ant-..."></div>
      <div class="setup-field"><label>Máº­t kháº©u Admin (giÃ¡o viÃªn)</label><input id="s-pwd" type="password" placeholder="Äáº·t máº­t kháº©u báº£o máº­t"></div>
      <button class="btn btn-p" style="width:100%;justify-content:center;margin-top:6px" onclick="doSetup()">
        <span id="setup-btn-txt">HoÃ n táº¥t cÃ i Ä‘áº·t â†’</span>
      </button>
      <div id="setup-err" style="color:var(--danger);font-size:13px;margin-top:10px;display:none;text-align:center"></div>
      <div class="api-note">
        ğŸ“Œ <strong>CÃ¡ch láº¥y JSONBin Key (miá»…n phÃ­):</strong><br>
        1. VÃ o <a href="https://jsonbin.io" target="_blank">jsonbin.io</a> â†’ Sign up (miá»…n phÃ­)<br>
        2. Dashboard â†’ API Keys â†’ copy <strong>Secret Access Key</strong><br><br>
        ğŸ¤– <strong>Anthropic API Key (Ä‘á»ƒ dÃ¹ng AI):</strong><br>
        VÃ o <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a> â†’ API Keys â†’ táº¡o key má»›i
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     STUDENT APP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="student-app" style="display:none">
  <header>
    <div>
      <span class="logo-text">IELTS Vocab</span>
      <span class="logo-sub">Master</span>
    </div>
    <div class="hstats">
      <div class="hstat" style="text-align:center"><div class="hstat-num" id="h-total">0</div><div class="hstat-lbl">Tá»«</div></div>
      <div class="hstat" style="text-align:center"><div class="hstat-num" id="h-due">0</div><div class="hstat-lbl">HÃ´m nay</div></div>
      <div class="hstat" style="text-align:center"><div class="hstat-num" id="h-mastered">0</div><div class="hstat-lbl">Thuá»™c</div></div>
    </div>
    <button class="admin-gear" onclick="showLoginScreen()" title="Admin">âš™</button>
  </header>

  <div class="nav-tabs">
    <button class="tab-btn active" onclick="switchTab('topics')">ğŸ—‚ Chá»§ Ä‘á»</button>
    <button class="tab-btn" onclick="switchTab('study')">ğŸ§  Há»c</button>
    <button class="tab-btn" onclick="switchTab('quiz')">âš¡ Quiz</button>
    <button class="tab-btn" onclick="switchTab('progress')">ğŸ“Š Tiáº¿n Ä‘á»™</button>
  </div>

  <!-- Topics -->
  <div id="screen-topics" class="screen active">
    <div id="topic-list-view">
      <div style="margin-bottom:18px"><span class="section-title">ğŸ—‚ Chá»§ Ä‘á» tá»« vá»±ng</span></div>
      <div class="topic-grid" id="topic-grid"></div>
    </div>
    <div id="topic-detail-view" style="display:none">
      <div class="detail-hdr">
        <button class="back-btn" onclick="backToList()">â† Quay láº¡i</button>
        <span class="detail-title" id="det-title"></span>
        <span class="detail-badge" id="det-badge"></span>
      </div>
      <div class="chip-grid" id="chip-grid"></div>
      <div class="topic-actions">
        <button class="btn btn-p" onclick="studyThis()">ğŸ§  Há»c chá»§ Ä‘á» nÃ y</button>
        <button class="btn btn-s" onclick="quizThis()">âš¡ Quiz chá»§ Ä‘á» nÃ y</button>
      </div>
    </div>
  </div>

  <!-- Study -->
  <div id="screen-study" class="screen">
    <div id="study-main">
      <div class="study-hdr">
        <span id="study-lbl" style="font-size:13px;color:var(--text2)">Spaced Repetition</span>
        <div class="prg-wrap"><div class="prg-fill" id="study-bar" style="width:0%"></div></div>
        <span class="study-cnt" id="study-cnt">0/0</span>
      </div>
      <div class="acc-row">
        <span class="acc-lbl">Giá»ng:</span>
        <button class="acc-btn active" id="acc-us" onclick="setAccent('us')">ğŸ‡ºğŸ‡¸ US</button>
        <button class="acc-btn" id="acc-uk" onclick="setAccent('uk')">ğŸ‡¬ğŸ‡§ UK</button>
      </div>
      <!-- Spelling step (first encounter only) -->
      <div id="spelling-screen">
        <div class="spell-tag">BÆ¯á»šC 1 / 2 â€” NGHE VÃ€ CHá»ŒN CHÃNH Táº¢</div>
        <div class="spell-listen">
          <div class="spell-listen-icon">ğŸ§</div>
          <div class="spell-listen-lbl">Nghe vÃ  chá»n tá»« Ä‘Ãºng chÃ­nh táº£</div>
          <button class="speak-btn" onclick="speakCurrent()" style="margin:0 auto"><span class="wave"><span></span><span></span><span></span></span> Nghe láº¡i</button>
          <div class="spell-listen-ph" id="spell-ph"></div>
          <div class="spell-listen-type" id="spell-type"></div>
        </div>
        <div class="spell-opts" id="spell-opts"></div>
        <div id="spell-feedback" style="display:none;text-align:center;padding:10px;font-size:14px;color:var(--success)"></div>
      </div>

      <div class="card-wrap" id="card-wrap-main">
        <div class="flashcard" id="flashcard" onclick="flipCard()">
          <div class="card-face cf">
            <div class="c-tag">Tá»ª Vá»°NG IELTS</div>
            <div class="c-word" id="cf-word">â€”</div>
            <div class="c-ph" id="cf-ph"></div>
            <div class="c-type" id="cf-type"></div>
            <button class="speak-btn" onclick="event.stopPropagation();speakCurrent()"><span class="wave"><span></span><span></span><span></span></span> PhÃ¡t Ã¢m</button>
            <div class="c-hint">Click Ä‘á»ƒ láº­t card</div>
          </div>
          <div class="card-face cb">
            <div class="c-tag">Äá»ŠNH NGHÄ¨A</div>
            <div class="c-def" id="cb-def"></div>
            <div class="c-vn" id="cb-vn"></div>
            <div class="c-ex" id="cb-ex"></div>
            <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;justify-content:center">
              <button class="speak-btn" onclick="event.stopPropagation();speakCurrent()"><span class="wave"><span></span><span></span><span></span></span> Nghe láº¡i</button>
              <button class="speak-btn" id="ai-explain-btn" onclick="event.stopPropagation();aiExplain()" style="border-color:var(--accent2);color:var(--accent2)">ğŸ¤– AI giáº£i thÃ­ch</button>
            </div>
            <div id="ai-explain-box" style="display:none;margin-top:12px;font-size:13px;color:var(--text2);line-height:1.6;text-align:left;background:var(--surface2);border-radius:10px;padding:12px 14px;max-width:100%"></div>
          </div>
        </div>
      </div>
      <div class="rating-area" id="rating-area">
        <div class="r-lbl">Báº¡n nhá»› tá»« nÃ y á»Ÿ má»©c nÃ o?</div>
        <div class="r-btns">
          <button class="r-btn r-again" onclick="rate(0)"><span class="r-em">ğŸ˜°</span>QuÃªn rá»“i<span class="r-nx" id="nx0"></span></button>
          <button class="r-btn r-hard"  onclick="rate(1)"><span class="r-em">ğŸ˜…</span>KhÃ³<span class="r-nx" id="nx1"></span></button>
          <button class="r-btn r-good"  onclick="rate(2)"><span class="r-em">ğŸ˜Š</span>Nhá»› Ä‘Æ°á»£c<span class="r-nx" id="nx2"></span></button>
          <button class="r-btn r-easy"  onclick="rate(3)"><span class="r-em">ğŸ‰</span>Dá»… quÃ¡!<span class="r-nx" id="nx3"></span></button>
        </div>
      </div>
    </div>
    <div class="done-box" id="study-done" style="display:none">
      <div class="big">ğŸ‰</div>
      <h3>HoÃ n thÃ nh!</h3>
      <p>Báº¡n Ä‘Ã£ Ã´n xong hÃ´m nay.<br>Quay láº¡i ngÃ y mai Ä‘á»ƒ tiáº¿p tá»¥c!</p><br>
      <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
        <button class="btn btn-p" onclick="switchTab('progress')">Xem tiáº¿n Ä‘á»™ â†’</button>
        <button class="btn btn-s" id="study-all-btn" style="display:none" onclick="clearFilter()">ğŸ“š Há»c táº¥t cáº£ tá»«</button>
      </div>
    </div>
  </div>

  <!-- Quiz -->
  <div id="screen-quiz" class="screen">
    <div class="quiz-stats">
      <div class="q-stat"><div class="q-stat-num" id="qc" style="color:var(--success)">0</div><div class="q-stat-lbl">ÄÃºng</div></div>
      <div class="q-stat"><div class="q-stat-num" id="qw" style="color:var(--danger)">0</div><div class="q-stat-lbl">Sai</div></div>
      <div class="q-stat"><div class="q-stat-num" id="qt" style="color:var(--accent)">0</div><div class="q-stat-lbl">Tá»•ng</div></div>
      <div class="q-stat"><div class="q-stat-num" id="qa" style="color:var(--accent3)">â€”</div><div class="q-stat-lbl">ChÃ­nh xÃ¡c</div></div>
    </div>
    <div id="quiz-main">
      <div class="qtype-tabs">
        <button class="qtype-btn active" id="qt-meaning" onclick="setQType('meaning')">ğŸ“– Chá»n nghÄ©a</button>
        <button class="qtype-btn" id="qt-word"      onclick="setQType('word')">âœï¸ Chá»n tá»«</button>
        <button class="qtype-btn" id="qt-balloon"   onclick="setQType('balloon')">ğŸˆ Báº¯n bÃ³ng</button>
        <button class="qtype-btn" id="qt-random"    onclick="setQType('random')">ğŸ² Ngáº«u nhiÃªn</button>
      </div>
      <div class="quiz-q-card">
        <div class="q-type-lbl" id="q-lbl">Chá»n nghÄ©a Ä‘Ãºng</div>
        <div class="q-word" id="q-word">â€”</div>
        <div class="q-ph" id="q-ph"></div>
        <div class="blank-sent" id="q-sent" style="display:none"></div>
        <button class="speak-btn" id="q-speak-btn" onclick="speakWord(document.getElementById('q-word').textContent)" style="margin-top:8px"><span class="wave"><span></span><span></span><span></span></span> PhÃ¡t Ã¢m</button>
      </div>
      <div class="quiz-opts" id="quiz-opts"></div>
      <!-- Balloon game -->
      <div id="balloon-game" style="display:none">
        <div style="text-align:center;margin-bottom:12px">
          <div style="display:inline-flex;gap:16px;align-items:center;background:var(--surface2);padding:10px 20px;border-radius:12px">
            <div style="font-size:13px;color:var(--text2)">Level: <strong style="color:var(--accent);font-size:18px" id="game-level">1</strong></div>
            <div style="font-size:13px;color:var(--text2)">Äiá»ƒm: <strong style="color:var(--success);font-size:18px" id="game-score">0</strong></div>
            <div style="font-size:13px;color:var(--text2)">â¤ï¸ <strong style="color:var(--danger);font-size:18px" id="game-lives">3</strong></div>
          </div>
        </div>
        <div id="game-canvas-wrap" style="position:relative;width:100%;height:420px;background:linear-gradient(180deg,#0a0a12 0%,#16161e 100%);border-radius:16px;overflow:hidden;border:2px solid var(--border)"></div>
        <div id="game-over" style="display:none;text-align:center;margin-top:16px;padding:20px;background:var(--surface2);border-radius:12px;border:1px solid var(--border)">
          <div style="font-size:42px;margin-bottom:8px">ğŸ’¥</div>
          <div style="font-size:18px;font-weight:700;margin-bottom:6px;color:var(--danger)">Game Over!</div>
          <div style="font-size:14px;color:var(--text2);margin-bottom:14px">Tá»•ng Ä‘iá»ƒm: <strong style="color:var(--accent);font-size:20px" id="final-score">0</strong></div>
          <button class="btn btn-p" onclick="startBalloonGame()">ğŸ”„ ChÆ¡i láº¡i</button>
        </div>
      </div>
      <button class="quiz-next-btn" id="quiz-next" onclick="nextQ()">CÃ¢u tiáº¿p theo â†’</button>
    </div>
    <div id="quiz-empty" style="display:none;text-align:center;padding:56px 20px;color:var(--text2)">
      <div style="font-size:42px;margin-bottom:12px">ğŸ“š</div>
      <p>Chá»n má»™t chá»§ Ä‘á» Ä‘á»ƒ báº¯t Ä‘áº§u quiz!</p><br>
      <button class="btn btn-p" onclick="switchTab('topics')">Chá»n chá»§ Ä‘á»</button>
    </div>
  </div>

  <!-- Progress -->
  <div id="screen-progress" class="screen">
    <div class="prog-grid">
      <div class="prog-card pc1"><div class="prog-num" id="p-new">0</div><div class="prog-lbl">ğŸ†• Má»›i</div></div>
      <div class="prog-card pc2"><div class="prog-num" id="p-learn">0</div><div class="prog-lbl">ğŸ“– Äang há»c</div></div>
      <div class="prog-card pc3"><div class="prog-num" id="p-rev">0</div><div class="prog-lbl">ğŸ”„ Cáº§n Ã´n</div></div>
      <div class="prog-card pc4"><div class="prog-num" id="p-master">0</div><div class="prog-lbl">âœ… Thuá»™c</div></div>
    </div>
    <div style="text-align:center;margin:6px 0 18px">
      <div class="donut-wrap">
        <svg class="donut" width="148" height="148" viewBox="0 0 160 160">
          <circle class="donut-ring" cx="80" cy="80" r="62" stroke="#1e1e24"/>
          <circle class="donut-ring" id="donut" cx="80" cy="80" r="62" stroke="#6bcb77" stroke-dasharray="0 390" stroke-linecap="round"/>
        </svg>
      </div>
      <div style="font-family:'Playfair Display',serif;font-size:16px;color:var(--text2);margin-top:-4px">
        <span id="pct" style="font-size:28px;color:var(--success);font-weight:900">0%</span> Ä‘Ã£ thuá»™c
      </div>
    </div>
    <div class="streak-box">
      <div class="streak-lbl">ğŸ“… Lá»‹ch sá»­ há»c (30 ngÃ y)</div>
      <div class="streak-days" id="streak"></div>
    </div>
  </div>
</div><!-- /student-app -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ADMIN LOGIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-login" class="screen">
  <div class="login-wrap">
    <div class="card">
      <div style="font-size:34px;margin-bottom:8px;text-align:center">ğŸ”</div>
      <h2>Admin Login</h2>
      <input id="login-pwd" type="password" placeholder="Máº­t kháº©u" onkeydown="if(event.key==='Enter')doLogin()">
      <button class="btn btn-p" style="width:100%;justify-content:center" onclick="doLogin()">ÄÄƒng nháº­p</button>
      <div class="login-err" id="login-err">Sai máº­t kháº©u!</div><br>
      <button class="btn btn-s btn-sm" onclick="toStudent()">â† Quay láº¡i</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ADMIN PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-admin" class="screen">
  <div class="admin-hdr">
    <span class="admin-title">âš™ï¸ Admin Panel</span>
    <div style="display:flex;gap:8px">
      <button class="btn btn-s btn-sm" onclick="toStudent()">â† ThoÃ¡t</button>
      <button class="btn btn-d btn-sm" onclick="doLogout()">ÄÄƒng xuáº¥t</button>
    </div>
  </div>
  <div class="a-tabs">
    <button class="a-tab active" onclick="switchATab('topics',this)">ğŸ—‚ Chá»§ Ä‘á»</button>
    <button class="a-tab" onclick="switchATab('words',this)">ğŸ“ Tá»« vá»±ng</button>
    <button class="a-tab" onclick="switchATab('import',this)">ğŸ“¥ Import CSV</button>
    <button class="a-tab" onclick="switchATab('aigen',this)">âœ¨ AI Generate</button>
  </div>

  <!-- Admin > Topics -->
  <div id="a-topics" class="a-screen active">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
      <span style="font-weight:600">Danh sÃ¡ch chá»§ Ä‘á»</span>
      <button class="btn btn-p btn-sm" onclick="openTopicForm()">ï¼‹ ThÃªm chá»§ Ä‘á»</button>
    </div>
    <div id="a-topic-list"></div>
    <div id="topic-form" class="card" style="display:none;margin-top:14px">
      <div style="font-weight:600;margin-bottom:14px" id="tf-title">ThÃªm chá»§ Ä‘á» má»›i</div>
      <div class="form-3" style="margin-bottom:11px">
        <div><label>Icon</label><input id="tf-emoji" type="text" maxlength="2" value="ğŸ“š" style="text-align:center;font-size:20px;padding:8px"></div>
        <div><label>TÃªn chá»§ Ä‘á»</label><input id="tf-name" type="text" placeholder="VD: Environment"></div>
        <div><label>MÃ u</label><input id="tf-color" type="color" value="#7c6ee0" style="height:42px;padding:4px 8px;cursor:pointer;width:100%"></div>
      </div>
      <div style="display:flex;gap:9px;margin-top:6px">
        <button class="btn btn-p" onclick="saveTopic()">ğŸ’¾ LÆ°u</button>
        <button class="btn btn-s" onclick="closeTopicForm()">Huá»·</button>
      </div>
    </div>
  </div>

  <!-- Admin > Words -->
  <div id="a-words" class="a-screen">
    <div style="margin-bottom:13px"><label>Chá»n chá»§ Ä‘á»</label>
      <select id="a-topic-sel" onchange="loadWords()"></select>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:11px">
      <span style="font-size:13px;color:var(--text2)" id="word-count-lbl"></span>
      <button class="btn btn-p btn-sm" onclick="openWordForm()">ï¼‹ ThÃªm tá»«</button>
    </div>
    <div id="word-form" class="card" style="display:none;margin-bottom:14px">
      <div style="font-weight:600;margin-bottom:13px">ThÃªm tá»« má»›i</div>
      <div class="form-2" style="margin-bottom:10px">
        <div><label>Tá»« / cá»¥m tá»« *</label><input id="wf-word" placeholder="VD: abundant"></div>
        <div><label>PhiÃªn Ã¢m</label><input id="wf-ph" placeholder="/É™ËˆbÊŒn.dÉ™nt/"></div>
      </div>
      <div class="form-2" style="margin-bottom:10px">
        <div><label>Loáº¡i tá»«</label><input id="wf-type" placeholder="n / v / adj / phrase"></div>
        <div><label>NghÄ©a tiáº¿ng Viá»‡t</label><input id="wf-vn" placeholder="phong phÃº"></div>
      </div>
      <div style="margin-bottom:10px"><label>Äá»‹nh nghÄ©a tiáº¿ng Anh</label><input id="wf-def" placeholder="existing in large quantities"></div>
      <div style="margin-bottom:13px"><label>CÃ¢u vÃ­ dá»¥</label><input id="wf-ex" placeholder="Rainfall is abundant in this region."></div>
      <div style="display:flex;gap:9px">
        <button class="btn btn-p" onclick="saveWord()">ğŸ’¾ LÆ°u tá»«</button>
        <button class="btn btn-s" onclick="closeWordForm()">Huá»·</button>
      </div>
    </div>
    <table class="w-table">
      <thead><tr><th>Tá»«</th><th>PhiÃªn Ã¢m</th><th>NghÄ©a VN</th><th>Definition</th><th></th></tr></thead>
      <tbody id="word-tbody"></tbody>
    </table>
  </div>

  <!-- Admin > AI Generate -->
  <div id="a-aigen" class="a-screen">
    <div class="card" style="margin-bottom:16px">
      <div style="font-weight:600;margin-bottom:6px;font-size:15px">âœ¨ Táº¡o tá»« vá»±ng báº±ng AI</div>
      <div style="font-size:13px;color:var(--text2);margin-bottom:16px">Claude sáº½ tá»± Ä‘á»™ng táº¡o danh sÃ¡ch tá»« IELTS theo chá»§ Ä‘á» báº¡n nháº­p</div>
      <div style="margin-bottom:11px"><label>ThÃªm vÃ o chá»§ Ä‘á»</label>
        <select id="aigen-topic-sel"></select>
      </div>
      <div style="margin-bottom:11px"><label>Chá»§ Ä‘á» / yÃªu cáº§u cá»¥ thá»ƒ</label>
        <input id="aigen-topic-input" placeholder="VD: Environment and climate change, Housing vocabulary for IELTS Speaking Part 2...">
      </div>
      <div style="margin-bottom:14px"><label>Sá»‘ lÆ°á»£ng tá»« muá»‘n táº¡o</label>
        <select id="aigen-count" style="width:auto">
          <option value="10">10 tá»«</option>
          <option value="20" selected>20 tá»«</option>
          <option value="30">30 tá»«</option>
          <option value="40">40 tá»«</option>
        </select>
      </div>
      <button class="btn btn-p" onclick="aiGenerate()" id="aigen-btn">âœ¨ Táº¡o tá»« vá»±ng</button>
      <div id="aigen-no-key" style="display:none;margin-top:12px;font-size:13px;color:var(--danger)">
        âš ï¸ ChÆ°a cÃ³ Anthropic API key. VÃ o <strong>CÃ i Ä‘áº·t</strong> Ä‘á»ƒ thÃªm.
      </div>
    </div>
    <div id="aigen-result" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:11px">
        <span style="font-weight:600" id="aigen-result-count"></span>
        <button class="btn btn-p btn-sm" onclick="aiSaveWords()">ğŸ’¾ LÆ°u táº¥t cáº£ vÃ o chá»§ Ä‘á»</button>
      </div>
      <table class="w-table">
        <thead><tr><th>Tá»«</th><th>PhiÃªn Ã¢m</th><th>NghÄ©a VN</th><th>Definition</th></tr></thead>
        <tbody id="aigen-tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Admin > Import (CSV) -->
  <div id="a-import" class="a-screen">
    <div style="margin-bottom:13px"><label>Import vÃ o chá»§ Ä‘á»</label>
      <select id="imp-topic-sel"></select>
    </div>
    <div class="csv-drop" id="csv-drop">
      <input type="file" id="csv-file" accept=".csv,.txt">
      <div style="font-size:30px;margin-bottom:9px">ğŸ“„</div>
      <div style="font-weight:600;margin-bottom:5px" id="csv-lbl">KÃ©o tháº£ hoáº·c click chá»n CSV</div>
      <div style="font-size:12px;color:var(--text2)">word, phonetic, type, definition, example, vietnamese</div>
    </div>
    <div id="csv-preview" style="display:none;margin-top:15px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:9px">
        <span style="font-weight:600" id="csv-cnt"></span>
        <button class="btn btn-p btn-sm" onclick="doImport()">âœ… Import</button>
      </div>
      <table class="w-table">
        <thead><tr><th>Tá»«</th><th>PhiÃªn Ã¢m</th><th>NghÄ©a VN</th><th>Definition</th></tr></thead>
        <tbody id="csv-prev-body"></tbody>
      </table>
    </div>
  </div>
</div><!-- /screen-admin -->


</div><!-- /app -->
<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSTANTS & STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CFG_KEY  = 'ielts_cfg_v1';
const PROG_KEY = 'ielts_prog_v2';
const BIN_URL  = 'https://api.jsonbin.io/v3/b';

let CFG      = {};                      // { apiKey, binId, pwdHash }
let CLOUD    = { topics: [] };          // shared vocab data (from JSONBin)
let PROGRESS = { cards:{}, log:[] };    // per-student progress (localStorage)
let activeTopicId = null;
let isAdmin = false;
let editingTopicId = null;
let pendingCSV = [];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STORAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadCFG(){ try{ CFG = JSON.parse(localStorage.getItem(CFG_KEY))||{}; }catch{ CFG={}; } }
function saveCFG(){ localStorage.setItem(CFG_KEY, JSON.stringify(CFG)); }
function loadProg(){ try{ PROGRESS = JSON.parse(localStorage.getItem(PROG_KEY))||{cards:{},log:[]}; }catch{ PROGRESS={cards:{},log:[]}; } }
function saveProg(){ localStorage.setItem(PROG_KEY, JSON.stringify(PROGRESS)); }

async function sha256(txt){
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(txt));
  return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  JSONBIN API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function binHeaders(extra={}){
  return {
    'Content-Type': 'application/json',
    'X-Master-Key': CFG.apiKey,
    'X-Access-Key': CFG.apiKey,
    ...extra
  };
}
async function binCreate(data){
  const r = await fetch(BIN_URL, {
    method:'POST',
    headers: binHeaders({'X-Bin-Name':'ielts-vocab','X-Bin-Private':'false'}),
    body: JSON.stringify(data)
  });
  if(!r.ok){
    const err = await r.json().catch(()=>({}));
    throw new Error(`JSONBin ${r.status}: ${err.message||err.error||r.statusText}`);
  }
  return (await r.json()).metadata.id;
}
async function binRead(){
  const r = await fetch(`${BIN_URL}/${CFG.binId}/latest`, {
    headers: binHeaders()
  });
  if(!r.ok){
    const err = await r.json().catch(()=>({}));
    throw new Error(`JSONBin ${r.status}: ${err.message||err.error||r.statusText}`);
  }
  return (await r.json()).record;
}
async function binWrite(data){
  const r = await fetch(`${BIN_URL}/${CFG.binId}`, {
    method:'PUT',
    headers: binHeaders(),
    body: JSON.stringify(data)
  });
  if(!r.ok){
    const err = await r.json().catch(()=>({}));
    throw new Error(`JSONBin ${r.status}: ${err.message||err.error||r.statusText}`);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init(){
  loadCFG(); loadProg();
  const ov = document.getElementById('overlay');
  const app = document.getElementById('app');

  if(!CFG.apiKey){
    ov.classList.add('hidden');
    app.style.display = 'block';
    showOnly('screen-setup');
    return;
  }

  try {
    document.getElementById('ov-msg').textContent = 'Äang táº£i tá»« vá»±ng...';
    CLOUD = await binRead();
    if(!CLOUD.topics) CLOUD = {topics:[]};
  } catch(e){
    document.getElementById('ov-msg').textContent = 'âš ï¸ KhÃ´ng táº£i Ä‘Æ°á»£c dá»¯ liá»‡u';
    await sleep(1200);
    CLOUD = {topics:[]};
  }
  ov.classList.add('hidden');
  app.style.display = 'block';
  document.getElementById('student-app').style.display = 'block';
  renderStudent();
}

const sleep = ms => new Promise(r=>setTimeout(r,ms));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doSetup(){
  const key = document.getElementById('s-key').value.trim();
  const pwd = document.getElementById('s-pwd').value.trim();
  const errEl = document.getElementById('setup-err');
  if(!key||!pwd){ errEl.textContent='HÃ£y Ä‘iá»n Ä‘áº§y Ä‘á»§!'; errEl.style.display='block'; return; }

  document.getElementById('setup-btn-txt').innerHTML = '<span class="spinner"></span> Äang cÃ i Ä‘áº·t...';
  errEl.style.display = 'none';
  try {
    CFG.apiKey    = key;
    CFG.claudeKey = document.getElementById('s-claude').value.trim();
    CFG.pwdHash   = await sha256(pwd);
    CFG.binId   = await binCreate({topics:[]});
    saveCFG();
    CLOUD = {topics:[]};
    document.getElementById('overlay').classList.add('hidden');
    document.getElementById('student-app').style.display = 'block';
    showOnly(null);
    renderStudent();
    showToast('âœ… CÃ i Ä‘áº·t thÃ nh cÃ´ng!');
  } catch(e){
    document.getElementById('setup-btn-txt').textContent = 'HoÃ n táº¥t cÃ i Ä‘áº·t â†’';
    errEl.textContent = `âŒ ${e.message||'Lá»—i khÃ´ng xÃ¡c Ä‘á»‹nh'}`;
    errEl.style.display = 'block';
    console.error('Setup error:', e);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STUDENT â€” DATA HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const wKey = (tid,word) => `${tid}||${word}`;
function getCard(tid,word){ return PROGRESS.cards[wKey(tid,word)] || {interval:0,repetition:0,efactor:2.5,dueDate:0,status:'new'}; }
function setCard(tid,word,s){ PROGRESS.cards[wKey(tid,word)]=s; saveProg(); }

function allWords(){
  return (CLOUD.topics||[]).flatMap(t=>(t.words||[]).map(w=>({...w, topicId:t.id, ...getCard(t.id,w.word)})));
}
function topicWords(tid){
  const t = (CLOUD.topics||[]).find(t=>t.id===tid);
  return t ? (t.words||[]).map(w=>({...w, topicId:tid, ...getCard(tid,w.word)})) : [];
}
function dueWords(){
  const now = Date.now();
  const pool = activeTopicId ? topicWords(activeTopicId) : allWords();
  return pool.filter(w=>w.dueDate<=now);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STUDENT â€” RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderStudent(){ renderHeader(); renderTopicGrid(); }

function renderHeader(){
  const all = allWords();
  document.getElementById('h-total').textContent    = all.length;
  document.getElementById('h-due').textContent      = dueWords().length;
  document.getElementById('h-mastered').textContent = all.filter(w=>w.status==='mastered').length;
}

function renderTopicGrid(){
  const el = document.getElementById('topic-grid');
  if(!(CLOUD.topics||[]).length){
    el.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:48px 20px;color:var(--text2)">
      <div style="font-size:42px;margin-bottom:12px">ğŸ—‚</div>
      <p>GiÃ¡o viÃªn chÆ°a thÃªm chá»§ Ä‘á» nÃ o.<br>HÃ£y kiÃªn nháº«n chá» nhÃ©! ğŸ˜Š</p></div>`;
    return;
  }
  el.innerHTML = CLOUD.topics.map(t=>{
    const words = topicWords(t.id);
    const total = words.length;
    const mastered = words.filter(w=>w.status==='mastered').length;
    const pct = total ? Math.round(mastered/total*100) : 0;
    return `<div class="topic-card" onclick="openTopic('${t.id}')"
        style="border-top:3px solid ${t.color||'#7c6ee0'}">
      <div class="t-emoji">${t.emoji||'ğŸ“š'}</div>
      <div class="t-name" style="color:${t.color||'#7c6ee0'}">${t.name}</div>
      <div class="t-meta">${total} tá»« Â· ${mastered} Ä‘Ã£ thuá»™c</div>
      <div class="t-bar"><div class="t-bar-fill" style="width:${pct}%;background:${t.color||'#7c6ee0'}"></div></div>
      <div class="t-pct">${pct}% hoÃ n thÃ nh</div>
    </div>`;
  }).join('');
}

function openTopic(tid){
  const t = (CLOUD.topics||[]).find(t=>t.id===tid); if(!t) return;
  activeTopicId = tid;
  const words = topicWords(tid);
  document.getElementById('det-title').textContent = `${t.emoji||''} ${t.name}`;
  document.getElementById('det-badge').textContent = `${words.length} tá»«`;
  document.getElementById('chip-grid').innerHTML = words.map(w=>`
    <div class="chip ${w.status==='mastered'?'done':''}" onclick="speakWord('${w.word.replace(/'/g,"\\'")}')">
      <div class="chip-word"><span class="dot ${w.status==='mastered'?'s-mastered':w.status==='review'?'s-review':w.status==='learning'?'s-learning':'s-new'}"></span>${w.word}</div>
      <div class="chip-vn">${w.vietnamese||w.definition||''}</div>
    </div>`).join('');
  document.getElementById('topic-list-view').style.display='none';
  document.getElementById('topic-detail-view').style.display='block';
}
function backToList(){ document.getElementById('topic-list-view').style.display='block'; document.getElementById('topic-detail-view').style.display='none'; }
function studyThis(){ switchTab('study'); }
function quizThis(){ switchTab('quiz'); }
function clearFilter(){ activeTopicId=null; initStudy(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SPACED REPETITION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let queue=[], qIdx=0, flipped=false, spellingStep=false;

function initStudy(){
  const t = activeTopicId ? (CLOUD.topics||[]).find(t=>t.id===activeTopicId) : null;
  document.getElementById('study-lbl').textContent = t ? `${t.emoji||''} ${t.name}` : 'Spaced Repetition';
  queue = dueWords().sort(()=>Math.random()-.5);
  qIdx=0; showCard();
}

function showCard(){
  const done = document.getElementById('study-done');
  const main = document.getElementById('study-main');
  if(qIdx >= queue.length){
    done.style.display='block'; main.style.display='none';
    document.getElementById('study-all-btn').style.display = activeTopicId?'inline-flex':'none';
    const today = new Date().toISOString().slice(0,10);
    if(!PROGRESS.log.includes(today)) PROGRESS.log.push(today);
    saveProg(); renderProgress(); renderHeader(); renderTopicGrid();
    return;
  }
  done.style.display='none'; main.style.display='block';
  const w=queue[qIdx], tot=queue.length;
  document.getElementById('study-cnt').textContent=`${qIdx+1}/${tot}`;
  document.getElementById('study-bar').style.width=`${qIdx/tot*100}%`;
  currentWord = w.word;

  // New word â†’ show spelling step first
  if(w.status === 'new'){
    showSpellingStep(w);
  } else {
    showFlashcard(w);
  }
}

// â”€â”€ SPELLING STEP â”€â”€
function showSpellingStep(w){
  spellingStep = true;
  document.getElementById('spelling-screen').style.display = 'block';
  document.getElementById('card-wrap-main').style.display  = 'none';
  document.getElementById('rating-area').classList.remove('show');
  document.getElementById('spell-feedback').style.display  = 'none';
  document.getElementById('ai-explain-box').style.display  = 'none';

  document.getElementById('spell-ph').textContent   = w.phonetic || '';
  document.getElementById('spell-type').textContent = w.type ? `(${w.type})` : '';

  // Generate 3 distractors
  const opts = generateSpellingOpts(w.word);
  document.getElementById('spell-opts').innerHTML = opts.map(o =>
    `<button class="spell-opt" onclick="checkSpelling(this,'${o.replace(/'/g,"\\'")}','${w.word.replace(/'/g,"\\'")}')">
      ${o}
    </button>`
  ).join('');

  // Auto-play pronunciation
  clearTimeout(speakTimer);
  speakTimer = setTimeout(()=>speakWord(w.word), 300);
}

function generateSpellingOpts(word){
  const distractors = new Set();
  const w = word.toLowerCase();

  // Strategy 1: swap adjacent letters
  for(let i=0; i<w.length-1 && distractors.size<2; i++){
    const arr = w.split('');
    [arr[i], arr[i+1]] = [arr[i+1], arr[i]];
    const d = arr.join('');
    if(d !== w) distractors.add(d);
  }
  // Strategy 2: double a consonant / remove double
  const consonants = 'bcdfghjklmnpqrstvwxyz';
  for(let i=0; i<w.length && distractors.size<3; i++){
    if(consonants.includes(w[i])){
      // double it if not already doubled
      if(w[i+1] !== w[i]){
        distractors.add(w.slice(0,i+1) + w[i] + w.slice(i+1));
      }
      // remove double if doubled
      if(w[i] === w[i-1]){
        distractors.add(w.slice(0,i) + w.slice(i+1));
      }
    }
  }
  // Strategy 3: common vowel swaps (aâ†”e, iâ†”e, aâ†”o, ouâ†”ow)
  const vowelSwaps = [['a','e'],['i','e'],['a','o'],['ou','ow'],['ie','ei'],['tion','sion'],['ance','ence'],['able','ible']];
  for(const [a,b] of vowelSwaps){
    if(distractors.size >= 3) break;
    if(w.includes(a)) distractors.add(w.replace(a, b));
    if(w.includes(b)) distractors.add(w.replace(b, a));
  }
  // Strategy 4: random letter change as last resort
  while(distractors.size < 3){
    const arr = w.split('');
    const i = Math.floor(Math.random() * arr.length);
    const alphabet = 'abcdefghijklmnoprstuvwy';
    arr[i] = alphabet[Math.floor(Math.random()*alphabet.length)];
    const d = arr.join('');
    if(d !== w && d.length === w.length) distractors.add(d);
  }

  // Mix correct answer with 3 distractors, shuffle
  const all = [word, ...[...distractors].slice(0,3)];
  return all.sort(()=>Math.random()-.5);
}

function checkSpelling(btn, selected, correct){
  document.querySelectorAll('.spell-opt').forEach(b=>b.classList.add('disabled'));

  if(selected.toLowerCase() === correct.toLowerCase()){
    btn.classList.add('correct');
    const fb = document.getElementById('spell-feedback');
    fb.style.display = 'block';
    fb.textContent = 'âœ… ChÃ­nh xÃ¡c! Chuyá»ƒn sang há»c nghÄ©a...';

    // Speak then transition â€” use both onend and a max-wait fallback
    if(window.speechSynthesis) window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(correct);
    u.lang = currentAccent==='us' ? 'en-US' : 'en-GB';
    u.rate = 0.72;
    const voice = pickVoice(currentAccent);
    if(voice) u.voice = voice;

    let transitioned = false;
    const doTransition = () => {
      if(transitioned) return;
      transitioned = true;
      showFlashcard(queue[qIdx]);
    };
    u.onend   = () => setTimeout(doTransition, 300);
    u.onerror = () => setTimeout(doTransition, 300);
    window.speechSynthesis.speak(u);
    // Hard fallback: always transition after 2.5s even if speech fails silently
    setTimeout(doTransition, 2500);

  } else {
    btn.classList.add('wrong');
    speakWord(correct);
    setTimeout(()=>{
      document.querySelectorAll('.spell-opt').forEach(b=>{
        if(!b.classList.contains('correct')) b.classList.remove('disabled');
      });
    }, 700);
  }
}

// â”€â”€ FLASHCARD â”€â”€
function showFlashcard(w){
  spellingStep = false;
  document.getElementById('spelling-screen').style.display = 'none';
  document.getElementById('card-wrap-main').style.display  = 'block';

  document.getElementById('cf-word').textContent = w.word;
  document.getElementById('cf-ph').textContent   = w.phonetic||'';
  document.getElementById('cf-type').textContent = w.type?`(${w.type})`:'';
  document.getElementById('cb-def').textContent  = w.definition||'â€”';
  document.getElementById('cb-vn').textContent   = w.vietnamese?`ğŸ‡»ğŸ‡³ ${w.vietnamese}`:'';
  document.getElementById('cb-ex').textContent   = w.example?`"${w.example}"`:'';
  document.getElementById('ai-explain-box').style.display = 'none';
  document.getElementById('flashcard').classList.remove('flipped');
  flipped=false;
  document.getElementById('rating-area').classList.remove('show');

  clearTimeout(speakTimer); speakTimer=setTimeout(()=>speakWord(w.word),400);
  [0,1,2,3].forEach(q=>{
    const s=sm2Sim(w,q);
    document.getElementById(`nx${q}`).textContent = s.interval===0?'<1 ngÃ y':s.interval===1?'1 ngÃ y':`${s.interval} ngÃ y`;
  });
}

function flipCard(){
  if(spellingStep) return; // ignore clicks during spelling step
  const fc = document.getElementById('flashcard');
  flipped=!flipped; fc.classList.toggle('flipped',flipped);
  if(flipped) setTimeout(()=>document.getElementById('rating-area').classList.add('show'),300);
  else document.getElementById('rating-area').classList.remove('show');
}

function sm2Sim(w,q){
  let {interval=0,repetition=0,efactor=2.5} = w;
  if(q<1){ repetition=0; interval=0; }
  else{
    if(repetition===0) interval=1;
    else if(repetition===1) interval=6;
    else interval=Math.round(interval*efactor);
    repetition++;
    efactor=Math.max(1.3, efactor+0.1-(3-q)*(0.08+(3-q)*0.02));
    if(q===1) interval=Math.max(1,Math.round(interval*.5));
    if(q===3) interval=Math.round(interval*1.3);
  }
  return {interval,repetition,efactor};
}

function rate(q){
  const w=queue[qIdx];
  const cur=getCard(w.topicId,w.word);
  const {interval,repetition,efactor}=sm2Sim({...cur},q);
  const dueDate = interval===0 ? Date.now()+600000 : Date.now()+interval*86400000;
  const status  = interval===0?'learning':interval>=21?'mastered':interval>=4?'review':'learning';
  setCard(w.topicId, w.word, {interval,repetition,efactor,dueDate,status});
  renderHeader(); qIdx++; showCard();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  QUIZ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let qC=0,qW=0,qT=0,qType='meaning';

function setQType(t){
  qType=t;
  document.querySelectorAll('.qtype-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('qt-'+t).classList.add('active');
  nextQ();
}

function initQuiz(){
  qC=0;qW=0;qT=0; updateQStats();
  const pool = activeTopicId ? topicWords(activeTopicId) : allWords();
  const empty = pool.length < 4;
  document.getElementById('quiz-main').style.display  = empty?'none':'block';
  document.getElementById('quiz-empty').style.display = empty?'block':'none';
  if(!empty) nextQ();
}

function nextQ(){
  const words = activeTopicId ? topicWords(activeTopicId) : allWords();
  if(words.length<4) return;

  let type = qType==='random' ? (Math.random()<0.5?'meaning':'word') : qType;

  // Balloon mode starts the game instead of showing a question
  if(type==='balloon'){
    document.getElementById('q-lbl').style.display='none';
    document.getElementById('q-word').style.display='none';
    document.getElementById('q-ph').style.display='none';
    document.getElementById('q-sent').style.display='none';
    document.getElementById('q-speak-btn').style.display='none';
    document.getElementById('quiz-opts').style.display='none';
    document.getElementById('balloon-game').style.display='block';
    document.getElementById('quiz-next').style.display='none';
    startBalloonGame();
    return;
  }

  // Hide balloon game for normal quiz modes
  document.getElementById('balloon-game').style.display='none';
  document.getElementById('q-lbl').style.display='block';
  document.getElementById('quiz-opts').style.display='grid';
  document.getElementById('quiz-next').classList.remove('show');

  const idx = Math.floor(Math.random()*words.length);
  const correct = words[idx];
  let distPool=[...words].filter(w=>w.word!==correct.word);
  const dist=[];
  while(dist.length<3&&distPool.length){ const r=Math.floor(Math.random()*distPool.length); dist.push(distPool.splice(r,1)[0]); }
  const opts=[correct,...dist].sort(()=>Math.random()-.5);
  currentWord = correct.word;

  if(type==='meaning'){
    document.getElementById('q-lbl').textContent='ğŸ“– Chá»n nghÄ©a Ä‘Ãºng cá»§a tá»«';
    document.getElementById('q-word').style.display='block';
    document.getElementById('q-word').textContent=correct.word;
    document.getElementById('q-ph').textContent=correct.phonetic||'';
    document.getElementById('q-sent').style.display='none';
    document.getElementById('q-speak-btn').style.display='inline-flex';
    clearTimeout(speakTimer); speakTimer=setTimeout(()=>speakWord(correct.word),300);
    document.getElementById('quiz-opts').innerHTML=opts.map(o=>
      `<button class="q-opt" data-id="${o.topicId}||${o.word}"
         onclick="checkQ(this,'${o.topicId}||${o.word}','${correct.topicId}||${correct.word}')">
         ${o.definition||o.vietnamese||'â€”'}</button>`).join('');

  } else { // word
    document.getElementById('q-lbl').textContent='âœï¸ Chá»n tá»« Ä‘Ãºng Ä‘iá»n vÃ o cÃ¢u';
    document.getElementById('q-word').style.display='none';
    document.getElementById('q-ph').textContent='';
    document.getElementById('q-speak-btn').style.display='none';
    const sent=correct.example||'';
    const display = sent
      ? sent.replace(new RegExp('\\b'+correct.word.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+'\\w*\\b','gi'),'<span class="blank">_____</span>')
      : `<span style="font-size:14px;color:var(--text2)">Tá»« cÃ³ nghÄ©a lÃ :</span><br>"${correct.definition||correct.vietnamese||'?'}"`;
    document.getElementById('q-sent').innerHTML=display;
    document.getElementById('q-sent').style.display='block';
    document.getElementById('quiz-opts').innerHTML=opts.map(o=>
      `<button class="q-opt" data-id="${o.topicId}||${o.word}"
         onclick="checkQ(this,'${o.topicId}||${o.word}','${correct.topicId}||${correct.word}')"
         style="text-align:center;font-family:'Playfair Display',serif;font-size:16px;font-weight:700">
         ${o.word}</button>`).join('');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BALLOON GAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let gameLevel=1, gameScore=0, gameLives=3, gameBalloons=[], gameInterval=null, gameTargetWord=null, gameRunning=false;

function startBalloonGame(){
  // Reset game
  gameLevel=1; gameScore=0; gameLives=3; gameBalloons=[]; gameRunning=true;
  document.getElementById('game-level').textContent=gameLevel;
  document.getElementById('game-score').textContent=gameScore;
  document.getElementById('game-lives').textContent=gameLives;
  document.getElementById('game-over').style.display='none';
  const canvas = document.getElementById('game-canvas-wrap');
  canvas.innerHTML=''; // clear old balloons

  // Start spawning balloons
  spawnBalloon();
  gameInterval = setInterval(spawnBalloon, Math.max(2000 - (gameLevel-1)*200, 800));
}

function spawnBalloon(){
  if(!gameRunning || gameLives<=0) return;

  const words = activeTopicId ? topicWords(activeTopicId) : allWords();
  if(words.length<3){ endGame(); return; }

  // Pick random target word and 2 distractors
  const idx = Math.floor(Math.random()*words.length);
  const correct = words[idx];
  let pool = [...words].filter(w=>w.word!==correct.word);
  const distractors = [];
  while(distractors.length<2 && pool.length){
    const r = Math.floor(Math.random()*pool.length);
    distractors.push(pool.splice(r,1)[0]);
  }
  const batch = [correct, ...distractors];

  // Speak the target word
  gameTargetWord = correct.word;
  speakWord(correct.word);

  // Create balloons for this batch
  const canvas = document.getElementById('game-canvas-wrap');
  const canvasRect = canvas.getBoundingClientRect();

  batch.forEach((w,i)=>{
    const balloon = document.createElement('div');
    balloon.className = 'balloon';
    const colors = ['#ff6b9d','#c77dff','#4ecdc4','#ffe66d','#ff8c42','#7eb8f7'];
    const color = colors[Math.floor(Math.random()*colors.length)];
    balloon.innerHTML = `
      <div class="balloon-inner" style="background:linear-gradient(135deg, ${color} 0%, ${color}dd 100%);">
        ${w.word}
      </div>
      <div class="balloon-string"></div>
    `;

    // Random starting position (spread horizontally)
    const x = (i / batch.length) * 100 + (Math.random() * 20);
    balloon.style.left = `${x}%`;
    balloon.style.bottom = `-100px`;

    balloon.onclick = ()=>clickBalloon(balloon, w.word);
    canvas.appendChild(balloon);
    gameBalloons.push({el:balloon, word:w.word, y:-100, speed:0.3 + gameLevel*0.05});
  });

  // Animate balloons upward
  if(!gameInterval) gameInterval = setInterval(animateBalloons, 50);
}

function animateBalloons(){
  if(!gameRunning) return;
  gameBalloons = gameBalloons.filter(b=>{
    b.y += b.speed;
    b.el.style.bottom = `${b.y}px`;
    // Check if balloon escaped (reached top)
    if(b.y > 450){
      b.el.remove();
      if(b.word === gameTargetWord){
        gameLives--;
        document.getElementById('game-lives').textContent = gameLives;
        showToast('ğŸ’” Bá» lá»¡ tá»« Ä‘Ãºng!');
        if(gameLives <=0) endGame();
      }
      return false; // remove from array
    }
    return true;
  });
}

function clickBalloon(el, word){
  if(!gameRunning) return;
  el.style.animation='none';
  el.style.transform='scale(0)';
  el.style.transition='transform 0.2s ease';
  setTimeout(()=>el.remove(), 200);

  // Remove from tracking
  gameBalloons = gameBalloons.filter(b=>b.el!==el);

  if(word === gameTargetWord){
    gameScore += 10 * gameLevel;
    document.getElementById('game-score').textContent = gameScore;
    showToast('âœ… +' + (10*gameLevel));
    // Level up every 50 points
    if(gameScore % 50 === 0 && gameScore > 0){
      gameLevel++;
      document.getElementById('game-level').textContent = gameLevel;
      showToast('ğŸ‰ Level ' + gameLevel + '!');
      clearInterval(gameInterval);
      gameInterval = setInterval(spawnBalloon, Math.max(2000 - (gameLevel-1)*200, 800));
    }
  } else {
    gameLives--;
    document.getElementById('game-lives').textContent = gameLives;
    showToast('âŒ Sai tá»«!');
    if(gameLives <= 0) endGame();
  }
}

function endGame(){
  gameRunning = false;
  clearInterval(gameInterval);
  gameInterval = null;
  document.getElementById('final-score').textContent = gameScore;
  document.getElementById('game-over').style.display='block';
  // Clear remaining balloons
  gameBalloons.forEach(b=>b.el.remove());
  gameBalloons = [];
}

function checkQ(btn,selId,corrId){
  document.querySelectorAll('.q-opt').forEach(b=>b.classList.add('disabled'));
  qT++;
  if(selId===corrId){
    btn.classList.add('correct'); qC++; showToast('âœ… ChÃ­nh xÃ¡c!');
    if(qType!=='meaning') setTimeout(()=>speakWord(currentWord),300);
  } else {
    btn.classList.add('wrong'); qW++;
    document.querySelectorAll('.q-opt').forEach(b=>{ if(b.dataset.id===corrId) b.classList.add('reveal'); });
    showToast('âŒ Sai rá»“i!');
  }
  updateQStats();
  document.getElementById('quiz-next').classList.add('show');
}

function updateQStats(){
  document.getElementById('qc').textContent=qC;
  document.getElementById('qw').textContent=qW;
  document.getElementById('qt').textContent=qT;
  document.getElementById('qa').textContent=qT?Math.round(qC/qT*100)+'%':'â€”';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PROGRESS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderProgress(){
  const all=allWords();
  const c={new:0,learning:0,review:0,mastered:0};
  all.forEach(w=>c[w.status]=(c[w.status]||0)+1);
  document.getElementById('p-new').textContent=c.new||0;
  document.getElementById('p-learn').textContent=c.learning||0;
  document.getElementById('p-rev').textContent=c.review||0;
  document.getElementById('p-master').textContent=c.mastered||0;
  const total=all.length, p=total?Math.round((c.mastered||0)/total*100):0;
  document.getElementById('pct').textContent=p+'%';
  const circ=2*Math.PI*62;
  document.getElementById('donut').setAttribute('stroke-dasharray',`${circ*p/100} ${circ}`);
  const el=document.getElementById('streak');
  const log=new Set(PROGRESS.log||[]);
  const today=new Date(); today.setHours(0,0,0,0);
  el.innerHTML='';
  for(let i=29;i>=0;i--){
    const d=new Date(today); d.setDate(d.getDate()-i);
    const k=d.toISOString().slice(0,10);
    el.innerHTML+=`<div class="day ${log.has(k)?'ok':''}" title="${k}">${d.getDate()}</div>`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showOnly(id){
  document.querySelectorAll('#app > .screen, #student-app .screen').forEach(s=>s.classList.remove('active'));
  if(id) document.getElementById(id)?.classList.add('active');
}
function switchTab(tab){
  document.querySelectorAll('#student-app .screen').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('screen-'+tab).classList.add('active');
  ['topics','study','quiz','progress'].forEach((t,i)=>{
    if(t===tab) document.querySelectorAll('.tab-btn')[i].classList.add('active');
  });
  if(tab==='topics')   renderTopicGrid();
  if(tab==='study')    initStudy();
  if(tab==='quiz')     initQuiz();
  if(tab==='progress') renderProgress();
}
function toStudent(){
  document.getElementById('student-app').style.display='block';
  showOnly(null);
  document.querySelectorAll('#student-app .screen').forEach((s,i)=>{s.classList.toggle('active',i===0);});
  document.querySelectorAll('.tab-btn').forEach((b,i)=>b.classList.toggle('active',i===0));
  renderStudent();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADMIN AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showLoginScreen(){
  document.getElementById('student-app').style.display='none';
  showOnly('screen-login');
  document.getElementById('login-pwd').value='';
  document.getElementById('login-err').style.display='none';
}
async function doLogin(){
  const h=await sha256(document.getElementById('login-pwd').value);
  if(h===CFG.pwdHash){
    isAdmin=true;
    document.getElementById('student-app').style.display='none';
    showOnly('screen-admin');
    renderAdminTopics(); populateSels();
  } else {
    document.getElementById('login-err').style.display='block';
  }
}
function doLogout(){ isAdmin=false; toStudent(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADMIN â€” UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchATab(tab,el){
  document.querySelectorAll('.a-tab').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.a-screen').forEach(s=>s.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('a-'+tab).classList.add('active');
  if(tab==='topics') renderAdminTopics();
  if(tab==='words')  { populateSels(); loadWords(); }
  if(tab==='import') populateSels();
  if(tab==='aigen')  { populateSels(); document.getElementById('aigen-result').style.display='none'; }
}

// â”€â”€ Topics â”€â”€
function renderAdminTopics(){
  const el=document.getElementById('a-topic-list');
  if(!(CLOUD.topics||[]).length){ el.innerHTML='<div style="color:var(--text2);padding:16px">ChÆ°a cÃ³ chá»§ Ä‘á» nÃ o.</div>'; return; }
  el.innerHTML=CLOUD.topics.map(t=>`
    <div class="t-row">
      <div style="font-size:22px">${t.emoji||'ğŸ“š'}</div>
      <div class="t-row-info">
        <div class="t-row-name" style="color:${t.color||'var(--accent)'}">${t.name}</div>
        <div class="t-row-count">${(t.words||[]).length} tá»«</div>
      </div>
      <div style="display:flex;gap:7px">
        <button class="btn btn-s btn-sm" onclick="editTopic('${t.id}')">âœï¸</button>
        <button class="btn btn-d btn-sm" onclick="deleteTopic('${t.id}')">ğŸ—‘</button>
      </div>
    </div>`).join('');
}
function openTopicForm(){ editingTopicId=null; document.getElementById('tf-title').textContent='ThÃªm chá»§ Ä‘á» má»›i'; document.getElementById('tf-emoji').value='ğŸ“š'; document.getElementById('tf-name').value=''; document.getElementById('tf-color').value='#7c6ee0'; document.getElementById('topic-form').style.display='block'; }
function editTopic(id){ const t=(CLOUD.topics||[]).find(t=>t.id===id); if(!t)return; editingTopicId=id; document.getElementById('tf-title').textContent='Chá»‰nh sá»­a chá»§ Ä‘á»'; document.getElementById('tf-emoji').value=t.emoji||'ğŸ“š'; document.getElementById('tf-name').value=t.name; document.getElementById('tf-color').value=t.color||'#7c6ee0'; document.getElementById('topic-form').style.display='block'; }
function closeTopicForm(){ document.getElementById('topic-form').style.display='none'; editingTopicId=null; }
async function saveTopic(){
  const name=document.getElementById('tf-name').value.trim();
  if(!name){ showToast('âš ï¸ Nháº­p tÃªn chá»§ Ä‘á»!'); return; }
  const emoji=document.getElementById('tf-emoji').value.trim()||'ğŸ“š';
  const color=document.getElementById('tf-color').value;
  if(editingTopicId){
    const t=CLOUD.topics.find(t=>t.id===editingTopicId);
    if(t){ t.name=name; t.emoji=emoji; t.color=color; }
  } else {
    CLOUD.topics.push({id:'t'+Date.now(),name,emoji,color,words:[]});
  }
  await syncCloud(); closeTopicForm(); renderAdminTopics(); populateSels(); showToast('âœ… ÄÃ£ lÆ°u!');
}
async function deleteTopic(id){
  const t=(CLOUD.topics||[]).find(t=>t.id===id);
  if(!confirm(`XoÃ¡ chá»§ Ä‘á» "${t?.name}" vÃ  ${(t?.words||[]).length} tá»«?`)) return;
  CLOUD.topics=CLOUD.topics.filter(t=>t.id!==id);
  await syncCloud(); renderAdminTopics(); populateSels(); showToast('ğŸ—‘ ÄÃ£ xoÃ¡!');
}

// â”€â”€ Words â”€â”€
function populateSels(){
  const opts = (CLOUD.topics||[]).map(t=>`<option value="${t.id}">${t.emoji||'ğŸ“š'} ${t.name}</option>`).join('');
  ['a-topic-sel','imp-topic-sel','aigen-topic-sel'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.innerHTML=opts||'<option value="">ChÆ°a cÃ³ chá»§ Ä‘á»</option>';
  });
}
function loadWords(){
  const tid=document.getElementById('a-topic-sel').value;
  const t=(CLOUD.topics||[]).find(t=>t.id===tid);
  const words=t?.words||[];
  document.getElementById('word-count-lbl').textContent=`${words.length} tá»«`;
  document.getElementById('word-tbody').innerHTML=words.map((w,i)=>`
    <tr>
      <td><strong>${w.word}</strong></td>
      <td style="color:var(--accent2)">${w.phonetic||'â€”'}</td>
      <td>${w.vietnamese||'â€”'}</td>
      <td style="color:var(--text2);font-size:12px;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${w.definition||'â€”'}</td>
      <td><button class="btn btn-d btn-sm" onclick="deleteWord('${tid}',${i})">ğŸ—‘</button></td>
    </tr>`).join('')||`<tr><td colspan="5" style="text-align:center;color:var(--text2);padding:18px">ChÆ°a cÃ³ tá»« nÃ o</td></tr>`;
  document.getElementById('word-form').style.display='none';
}
function openWordForm(){ ['wf-word','wf-ph','wf-type','wf-vn','wf-def','wf-ex'].forEach(id=>document.getElementById(id).value=''); document.getElementById('word-form').style.display='block'; }
function closeWordForm(){ document.getElementById('word-form').style.display='none'; }
async function saveWord(){
  const word=document.getElementById('wf-word').value.trim();
  if(!word){ showToast('âš ï¸ Nháº­p tá»« vá»±ng!'); return; }
  const tid=document.getElementById('a-topic-sel').value;
  const t=(CLOUD.topics||[]).find(t=>t.id===tid);
  if(!t){ showToast('âš ï¸ Chá»n chá»§ Ä‘á» trÆ°á»›c!'); return; }
  if(!t.words) t.words=[];
  t.words.push({word,phonetic:document.getElementById('wf-ph').value.trim(),type:document.getElementById('wf-type').value.trim(),definition:document.getElementById('wf-def').value.trim(),example:document.getElementById('wf-ex').value.trim(),vietnamese:document.getElementById('wf-vn').value.trim()});
  await syncCloud(); loadWords(); closeWordForm(); showToast(`âœ… ÄÃ£ thÃªm "${word}"!`);
}
async function deleteWord(tid,idx){
  const t=(CLOUD.topics||[]).find(t=>t.id===tid); if(!t?.words) return;
  if(!confirm(`XoÃ¡ tá»« "${t.words[idx]?.word}"?`)) return;
  t.words.splice(idx,1);
  await syncCloud(); loadWords(); showToast('ğŸ—‘ ÄÃ£ xoÃ¡!');
}

// â”€â”€ CSV Import â”€â”€
function parseCSV(text){
  const lines=text.trim().split('\n');
  const start=lines[0].toLowerCase().includes('word')?1:0;
  return lines.slice(start).map(line=>{
    const p=splitLine(line); if(!p[0]?.trim()) return null;
    return{word:p[0].trim(),phonetic:(p[1]||'').trim(),type:(p[2]||'').trim(),definition:(p[3]||'').trim(),example:(p[4]||'').trim(),vietnamese:(p[5]||'').trim()};
  }).filter(Boolean);
}
function splitLine(line){
  const r=[]; let cur='',inQ=false;
  for(const c of line){ if(c==='"'){inQ=!inQ;}else if(c===','&&!inQ){r.push(cur);cur='';}else cur+=c; }
  r.push(cur); return r;
}

document.addEventListener('DOMContentLoaded',()=>{
  const fi=document.getElementById('csv-file');
  fi?.addEventListener('change',e=>{ if(e.target.files[0]) readCSVFile(e.target.files[0]); e.target.value=''; });
  const dz=document.getElementById('csv-drop');
  dz?.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('over');});
  dz?.addEventListener('dragleave',()=>dz.classList.remove('over'));
  dz?.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('over');const f=e.dataTransfer.files[0];if(f)readCSVFile(f);});
});

function readCSVFile(file){
  const reader=new FileReader();
  reader.onload=ev=>{
    pendingCSV=parseCSV(ev.target.result);
    document.getElementById('csv-lbl').textContent=`âœ… ${pendingCSV.length} tá»«: ${file.name}`;
    document.getElementById('csv-cnt').textContent=`Xem trÆ°á»›c (${Math.min(pendingCSV.length,10)} / ${pendingCSV.length} tá»«)`;
    document.getElementById('csv-prev-body').innerHTML=pendingCSV.slice(0,10).map(w=>`
      <tr><td><strong>${w.word}</strong></td><td style="color:var(--accent2)">${w.phonetic||''}</td>
      <td>${w.vietnamese||''}</td><td style="color:var(--text2);font-size:12px">${w.definition||''}</td></tr>`).join('');
    document.getElementById('csv-preview').style.display='block';
  };
  reader.readAsText(file,'UTF-8');
}

async function doImport(){
  if(!pendingCSV.length){ showToast('âš ï¸ ChÆ°a cÃ³ file!'); return; }
  const tid=document.getElementById('imp-topic-sel').value;
  const t=(CLOUD.topics||[]).find(t=>t.id===tid);
  if(!t){ showToast('âš ï¸ Chá»n chá»§ Ä‘á»!'); return; }
  if(!t.words) t.words=[];
  let added=0;
  pendingCSV.forEach(w=>{ if(!t.words.find(x=>x.word===w.word)){ t.words.push(w); added++; } });
  await syncCloud();
  document.getElementById('csv-preview').style.display='none';
  document.getElementById('csv-lbl').textContent='KÃ©o tháº£ hoáº·c click chá»n CSV';
  pendingCSV=[];
  showToast(`âœ… ÄÃ£ import ${added} tá»« vÃ o "${t.name}"!`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CLOUD SYNC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function syncCloud(){
  try {
    await binWrite(CLOUD);
  } catch(e){
    showToast(`âŒ Lá»—i lÆ°u: ${e.message}`);
    console.error('syncCloud:', e);
    throw e;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUDIO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentAccent='us', currentWord='', speakTimer=null;
function setAccent(a){
  currentAccent=a;
  document.querySelectorAll('.acc-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('acc-'+a).classList.add('active');
  if(currentWord) speakWord(currentWord);
}
function setSpeaking(on){ document.querySelectorAll('.speak-btn').forEach(b=>on?b.classList.add('speaking'):b.classList.remove('speaking')); }

// Preload voices (some browsers need this)
let _voices = [];
function getVoices(){
  if(_voices.length) return _voices;
  _voices = window.speechSynthesis?.getVoices() || [];
  return _voices;
}
if(window.speechSynthesis){
  window.speechSynthesis.onvoiceschanged = () => { _voices = window.speechSynthesis.getVoices(); };
}

function pickVoice(accent){
  const voices = getVoices();
  if(!voices.length) return null;
  const lang = accent==='us' ? 'en-US' : 'en-GB';

  // Priority list for US
  const usPriority = ['Samantha','Alex','Karen','Google US English','Microsoft Aria','Microsoft Guy'];
  // Priority list for UK
  const ukPriority = ['Daniel','Google UK English Female','Google UK English Male','Microsoft Hazel','Microsoft George'];
  const priority   = accent==='us' ? usPriority : ukPriority;

  // Try exact name match first
  for(const name of priority){
    const v = voices.find(v=>v.name.includes(name));
    if(v) return v;
  }
  // Fallback: exact lang match
  const exact = voices.find(v=>v.lang===lang);
  if(exact) return exact;
  // Last resort: any English
  return voices.find(v=>v.lang.startsWith('en')) || null;
}

function speakWord(word){
  if(!word||word==='â€”') return;
  word = word.trim();
  if(window.speechSynthesis) window.speechSynthesis.cancel();
  setSpeaking(true);

  if(!window.speechSynthesis){ setSpeaking(false); return; }

  // Voices may not be ready yet â€” retry once if empty
  const trySpeak = () => {
    const u = new SpeechSynthesisUtterance(word);
    u.lang  = currentAccent==='us' ? 'en-US' : 'en-GB';
    u.rate  = 0.72;
    u.pitch = 1.0;
    const voice = pickVoice(currentAccent);
    if(voice) u.voice = voice;
    u.onend   = () => setSpeaking(false);
    u.onerror = () => setSpeaking(false);
    window.speechSynthesis.speak(u);
  };

  // If voices not loaded yet, wait for them
  if(!getVoices().length){
    window.speechSynthesis.onvoiceschanged = () => {
      _voices = window.speechSynthesis.getVoices();
      trySpeak();
    };
    // Also try after short delay as fallback (some browsers never fire onvoiceschanged)
    setTimeout(trySpeak, 250);
  } else {
    trySpeak();
  }
}
function speakCurrent(){ speakWord(currentWord); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let toastTm;
function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  clearTimeout(toastTm); toastTm=setTimeout(()=>t.classList.remove('show'),2400);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CLAUDE AI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CLAUDE_URL = 'https://api.anthropic.com/v1/messages';

async function claudeCall(systemPrompt, userMsg, maxTokens=1500){
  if(!CFG.claudeKey) throw new Error('no_key');
  const res = await fetch(CLAUDE_URL, {
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'x-api-key': CFG.claudeKey,
      'anthropic-version':'2023-06-01',
      'anthropic-dangerous-direct-browser-access':'true'
    },
    body: JSON.stringify({
      model:'claude-sonnet-4-5-20250929',
      max_tokens: maxTokens,
      system: systemPrompt,
      messages:[{role:'user', content: userMsg}]
    })
  });
  if(!res.ok){ const e=await res.json(); throw new Error(e.error?.message||'API error'); }
  const data = await res.json();
  return data.content[0].text;
}

// â”€â”€ AI GENERATE (admin) â”€â”€
let aiGenBuffer = [];
async function aiGenerate(){
  if(!CFG.claudeKey){
    document.getElementById('aigen-no-key').style.display='block'; return;
  }
  document.getElementById('aigen-no-key').style.display='none';
  const topic = document.getElementById('aigen-topic-input').value.trim();
  if(!topic){ showToast('âš ï¸ Nháº­p chá»§ Ä‘á» muá»‘n táº¡o!'); return; }
  const count = document.getElementById('aigen-count').value;
  const btn = document.getElementById('aigen-btn');
  btn.innerHTML='<span class="spinner"></span> Äang táº¡o...'; btn.disabled=true;
  document.getElementById('aigen-result').style.display='none';

  const system = `You are an IELTS vocabulary expert. Return ONLY a valid JSON array, no markdown, no explanation.
Each item: {"word":"...","phonetic":"...","type":"...","definition":"...","example":"...","vietnamese":"..."}
Rules: phonetic in IPA, type = n/v/adj/adv/phrase/idiom, definition in English, example is a natural sentence, vietnamese is the Vietnamese translation.`;
  const prompt = `Generate ${count} IELTS vocabulary items for the topic: "${topic}".
Return ONLY a JSON array.`;

  try {
    const raw = await claudeCall(system, prompt, 2000);
    const clean = raw.replace(/```json|```/g,'').trim();
    aiGenBuffer = JSON.parse(clean);
    document.getElementById('aigen-result-count').textContent = `${aiGenBuffer.length} tá»« Ä‘Æ°á»£c táº¡o`;
    document.getElementById('aigen-tbody').innerHTML = aiGenBuffer.map(w=>`
      <tr>
        <td><strong>${w.word||''}</strong></td>
        <td style="color:var(--accent2)">${w.phonetic||''}</td>
        <td>${w.vietnamese||''}</td>
        <td style="color:var(--text2);font-size:12px">${w.definition||''}</td>
      </tr>`).join('');
    document.getElementById('aigen-result').style.display='block';
    showToast(`âœ… Táº¡o xong ${aiGenBuffer.length} tá»«!`);
  } catch(e){
    showToast('âŒ Lá»—i: '+(e.message||'KhÃ´ng táº¡o Ä‘Æ°á»£c'));
  }
  btn.innerHTML='âœ¨ Táº¡o tá»« vá»±ng'; btn.disabled=false;
}

async function aiSaveWords(){
  if(!aiGenBuffer.length){ showToast('âš ï¸ ChÆ°a cÃ³ tá»« nÃ o!'); return; }
  const tid = document.getElementById('aigen-topic-sel').value;
  const t = (CLOUD.topics||[]).find(t=>t.id===tid);
  if(!t){ showToast('âš ï¸ Chá»n chá»§ Ä‘á»!'); return; }
  if(!t.words) t.words=[];
  let added=0;
  aiGenBuffer.forEach(w=>{ if(w.word && !t.words.find(x=>x.word===w.word)){ t.words.push(w); added++; } });
  await syncCloud();
  showToast(`âœ… ÄÃ£ lÆ°u ${added} tá»« vÃ o "${t.name}"!`);
  aiGenBuffer=[];
  document.getElementById('aigen-result').style.display='none';
}

// â”€â”€ AI EXPLAIN (student flashcard) â”€â”€
async function aiExplain(){
  if(!CFG.claudeKey){ showToast('ğŸ¤– TÃ­nh nÄƒng AI chÆ°a Ä‘Æ°á»£c cÃ i Ä‘áº·t'); return; }
  const word = currentWord;
  if(!word||word==='â€”') return;
  const btn = document.getElementById('ai-explain-btn');
  const box = document.getElementById('ai-explain-box');
  btn.innerHTML='<span class="spinner"></span>'; btn.disabled=true;
  box.style.display='block'; box.textContent='Äang há»i AI...';

  const system = `You are an IELTS tutor. Explain English vocabulary clearly and concisely in Vietnamese. Keep it under 100 words.`;
  const prompt = `Explain the word/phrase "${word}" for an IELTS student:
- NghÄ©a chÃ­nh (tiáº¿ng Viá»‡t)
- CÃ¡ch dÃ¹ng (1-2 cÃ¢u)
- VÃ­ dá»¥ trong ngá»¯ cáº£nh IELTS
Be brief and practical.`;

  try {
    const reply = await claudeCall(system, prompt, 300);
    box.innerHTML = reply.replace(/\n/g,'<br>');
  } catch(e){
    box.textContent = 'âŒ KhÃ´ng thá»ƒ káº¿t ná»‘i AI. Kiá»ƒm tra API key.';
  }
  btn.innerHTML='ğŸ¤– AI giáº£i thÃ­ch'; btn.disabled=false;
}

// â”€â”€ STUDENT CHAT â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
init();
</script>
</body>
</html>
