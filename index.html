<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IELTS Vocab Master</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d0d0f;
    --surface: #16161a;
    --surface2: #1e1e24;
    --border: #2a2a35;
    --accent: #e8c547;
    --accent2: #7c6ee0;
    --accent3: #4ecdc4;
    --text: #f0eff4;
    --text2: #9d9daf;
    --danger: #ff6b6b;
    --success: #6bcb77;
    --radius: 16px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* â”€â”€ Background noise texture â”€â”€ */
  body::before {
    content: '';
    position: fixed; inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none; z-index: 0;
  }

  /* â”€â”€ LAYOUT â”€â”€ */
  #app { position: relative; z-index: 1; max-width: 860px; margin: 0 auto; padding: 24px 20px 60px; }

  /* â”€â”€ HEADER â”€â”€ */
  header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 0 32px; border-bottom: 1px solid var(--border); margin-bottom: 36px;
  }
  .logo { display: flex; align-items: baseline; gap: 8px; }
  .logo-text { font-family: 'Playfair Display', serif; font-size: 28px; font-weight: 900; color: var(--accent); letter-spacing: -1px; }
  .logo-sub { font-size: 12px; color: var(--text2); letter-spacing: 3px; text-transform: uppercase; }
  .header-stats { display: flex; gap: 20px; }
  .hstat { text-align: center; }
  .hstat-num { font-family: 'Playfair Display', serif; font-size: 22px; font-weight: 700; color: var(--accent); }
  .hstat-lbl { font-size: 10px; color: var(--text2); letter-spacing: 2px; text-transform: uppercase; }

  /* â”€â”€ NAV TABS â”€â”€ */
  .nav-tabs { display: flex; gap: 6px; background: var(--surface); border-radius: 14px; padding: 6px; margin-bottom: 32px; }
  .tab-btn {
    flex: 1; padding: 11px 8px; border: none; border-radius: 10px; cursor: pointer;
    font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 500; letter-spacing: 0.3px;
    background: transparent; color: var(--text2); transition: all 0.2s;
  }
  .tab-btn.active { background: var(--accent); color: #0d0d0f; font-weight: 600; }
  .tab-btn:hover:not(.active) { color: var(--text); background: var(--surface2); }

  /* â”€â”€ SCREENS â”€â”€ */
  .screen { display: none; animation: fadeIn 0.3s ease; }
  .screen.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }

  /* â”€â”€ UPLOAD SECTION â”€â”€ */
  .upload-zone {
    border: 2px dashed var(--border); border-radius: var(--radius); padding: 40px 24px;
    text-align: center; cursor: pointer; transition: all 0.2s; background: var(--surface);
    position: relative;
  }
  .upload-zone:hover, .upload-zone.dragover { border-color: var(--accent); background: #1a1a10; }
  .upload-icon { font-size: 40px; margin-bottom: 12px; }
  .upload-title { font-size: 16px; font-weight: 600; margin-bottom: 6px; }
  .upload-sub { font-size: 13px; color: var(--text2); line-height: 1.6; }
  #csv-input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
  .csv-format {
    margin-top: 20px; background: var(--surface2); border-radius: 10px; padding: 16px 20px;
    font-size: 12px; color: var(--text2); text-align: left; border: 1px solid var(--border);
  }
  .csv-format code { color: var(--accent3); font-family: monospace; }
  .sample-btn {
    margin-top: 14px; padding: 10px 20px; background: var(--surface2); border: 1px solid var(--border);
    border-radius: 10px; color: var(--text); cursor: pointer; font-size: 13px; font-family: 'DM Sans', sans-serif;
    transition: all 0.2s;
  }
  .sample-btn:hover { border-color: var(--accent); color: var(--accent); }

  /* â”€â”€ WORD LIST TABLE â”€â”€ */
  .word-list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
  .section-title { font-family: 'Playfair Display', serif; font-size: 22px; font-weight: 700; }
  .btn-primary {
    padding: 10px 20px; background: var(--accent); color: #0d0d0f; border: none;
    border-radius: 10px; cursor: pointer; font-family: 'DM Sans', sans-serif;
    font-size: 13px; font-weight: 600; transition: all 0.15s;
  }
  .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(232,197,71,0.3); }
  .btn-secondary {
    padding: 10px 20px; background: transparent; color: var(--text2); border: 1px solid var(--border);
    border-radius: 10px; cursor: pointer; font-family: 'DM Sans', sans-serif; font-size: 13px;
    transition: all 0.15s;
  }
  .btn-secondary:hover { border-color: var(--text2); color: var(--text); }

  .word-table { width: 100%; border-collapse: collapse; }
  .word-table th { font-size: 11px; letter-spacing: 2px; text-transform: uppercase; color: var(--text2); padding: 10px 14px; text-align: left; border-bottom: 1px solid var(--border); }
  .word-table td { padding: 12px 14px; font-size: 14px; border-bottom: 1px solid var(--border); }
  .word-table tr:last-child td { border-bottom: none; }
  .word-table tr:hover td { background: var(--surface2); }
  .badge {
    display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 600;
    letter-spacing: 0.5px;
  }
  .badge-new { background: #1e2a3a; color: #7eb8f7; }
  .badge-learning { background: #2a1e3a; color: var(--accent2); }
  .badge-review { background: #2a2a10; color: var(--accent); }
  .badge-mastered { background: #1a2a1a; color: var(--success); }
  .interval-text { font-size: 12px; color: var(--text2); }
  .empty-state { text-align: center; padding: 60px 20px; color: var(--text2); }
  .empty-state .icon { font-size: 48px; margin-bottom: 16px; }
  .empty-state p { font-size: 15px; line-height: 1.6; }

  /* â”€â”€ SPACED REPETITION STUDY â”€â”€ */
  .study-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
  .progress-bar-wrap { flex: 1; height: 6px; background: var(--surface2); border-radius: 3px; margin: 0 20px; overflow: hidden; }
  .progress-bar-fill { height: 100%; background: linear-gradient(90deg, var(--accent2), var(--accent)); border-radius: 3px; transition: width 0.4s ease; }
  .study-count { font-size: 13px; color: var(--text2); white-space: nowrap; }

  /* Flashcard */
  .card-container { perspective: 1000px; margin: 0 auto 28px; width: 100%; max-width: 560px; }
  .card {
    position: relative; width: 100%; padding-top: 56%;
    transform-style: preserve-3d; transition: transform 0.55s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
  }
  .card.flipped { transform: rotateY(180deg); }
  .card-face {
    position: absolute; inset: 0; border-radius: 20px; padding: 32px;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    backface-visibility: hidden; -webkit-backface-visibility: hidden;
    border: 1px solid var(--border);
  }
  .card-front { background: linear-gradient(135deg, #1a1a22, #16161e); }
  .card-back { background: linear-gradient(135deg, #1a1e2a, #161822); transform: rotateY(180deg); }
  .card-tag { font-size: 11px; letter-spacing: 2px; text-transform: uppercase; color: var(--text2); margin-bottom: 16px; }
  .card-word { font-family: 'Playfair Display', serif; font-size: 42px; font-weight: 900; color: var(--accent); text-align: center; line-height: 1.1; }
  .card-phonetic { font-size: 16px; color: var(--accent2); margin-top: 8px; }
  .card-type { font-size: 12px; color: var(--text2); margin-top: 6px; font-style: italic; }
  .card-definition { font-size: 17px; color: var(--text); text-align: center; line-height: 1.6; }
  .card-example { font-size: 13px; color: var(--text2); font-style: italic; text-align: center; margin-top: 12px; line-height: 1.5; padding: 0 12px; }
  .card-vn { font-size: 15px; color: var(--accent3); margin-top: 10px; font-weight: 500; }
  .card-hint { font-size: 12px; color: var(--border); margin-top: 16px; }

  /* â”€â”€ AUDIO BUTTON â”€â”€ */
  .speak-btn {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 7px 14px; border-radius: 20px; border: 1px solid var(--border);
    background: var(--surface2); color: var(--text2); cursor: pointer;
    font-size: 12px; font-family: 'DM Sans', sans-serif; font-weight: 500;
    transition: all 0.2s; margin-top: 10px; letter-spacing: 0.3px;
  }
  .speak-btn:hover { border-color: var(--accent3); color: var(--accent3); background: #0d2020; }
  .speak-btn.speaking { border-color: var(--accent3); color: var(--accent3); background: #0d2020; animation: pulse-speak 0.8s ease infinite; }
  @keyframes pulse-speak {
    0%, 100% { box-shadow: 0 0 0 0 rgba(78,205,196,0.3); }
    50% { box-shadow: 0 0 0 6px rgba(78,205,196,0); }
  }
  .speak-btn .wave { display: flex; gap: 2px; align-items: center; height: 14px; }
  .speak-btn .wave span {
    display: block; width: 3px; background: currentColor; border-radius: 2px;
    height: 6px; transition: height 0.1s;
  }
  .speak-btn.speaking .wave span:nth-child(1) { animation: bar 0.6s 0.0s ease infinite; }
  .speak-btn.speaking .wave span:nth-child(2) { animation: bar 0.6s 0.15s ease infinite; }
  .speak-btn.speaking .wave span:nth-child(3) { animation: bar 0.6s 0.3s ease infinite; }
  @keyframes bar {
    0%, 100% { height: 4px; } 50% { height: 13px; }
  }

  /* speak btn in word table */
  .speak-sm {
    background: none; border: none; cursor: pointer; font-size: 16px;
    padding: 2px 6px; border-radius: 6px; transition: background 0.15s; vertical-align: middle;
  }
  .speak-sm:hover { background: var(--surface2); }

  /* accent selector */
  .accent-toggle {
    display: flex; gap: 6px; align-items: center; justify-content: center; margin-bottom: 16px;
  }
  .accent-btn {
    padding: 5px 14px; border-radius: 20px; border: 1px solid var(--border);
    background: transparent; color: var(--text2); cursor: pointer; font-size: 12px;
    font-family: 'DM Sans', sans-serif; transition: all 0.15s;
  }
  .accent-btn.active { background: var(--accent2); border-color: var(--accent2); color: #fff; }
  .accent-label { font-size: 11px; color: var(--text2); letter-spacing: 1px; }

  /* Rating buttons */
  .rating-section { display: none; }
  .rating-section.visible { display: block; }
  .rating-label { font-size: 12px; color: var(--text2); text-align: center; margin-bottom: 14px; letter-spacing: 1px; text-transform: uppercase; }
  .rating-btns { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
  .rating-btn {
    flex: 1; min-width: 90px; max-width: 150px; padding: 14px 10px; border: 2px solid transparent;
    border-radius: 12px; cursor: pointer; font-family: 'DM Sans', sans-serif;
    font-size: 13px; font-weight: 600; transition: all 0.15s; text-align: center;
  }
  .rating-btn:hover { transform: translateY(-2px); }
  .rating-btn .emoji { font-size: 20px; display: block; margin-bottom: 4px; }
  .rating-btn .label { display: block; }
  .rating-btn .next-review { display: block; font-size: 10px; font-weight: 400; margin-top: 2px; opacity: 0.8; }
  .btn-again { background: #2a1010; border-color: var(--danger); color: var(--danger); }
  .btn-hard  { background: #2a2010; border-color: #f0a500; color: #f0a500; }
  .btn-good  { background: #10202a; border-color: var(--accent2); color: var(--accent2); }
  .btn-easy  { background: #102a10; border-color: var(--success); color: var(--success); }
  .btn-again:hover { background: #3a1010; }
  .btn-hard:hover  { background: #3a2a10; }
  .btn-good:hover  { background: #10302a; }
  .btn-easy:hover  { background: #103a10; }

  .no-cards-due { text-align: center; padding: 60px 20px; }
  .no-cards-due .big-icon { font-size: 56px; margin-bottom: 16px; }
  .no-cards-due h3 { font-family: 'Playfair Display', serif; font-size: 24px; margin-bottom: 8px; color: var(--success); }
  .no-cards-due p { color: var(--text2); font-size: 14px; line-height: 1.7; }

  /* â”€â”€ QUIZ â”€â”€ */
  .quiz-info { display: flex; gap: 16px; margin-bottom: 28px; }
  .quiz-stat { flex: 1; background: var(--surface); border-radius: 12px; padding: 16px; text-align: center; border: 1px solid var(--border); }
  .quiz-stat-num { font-family: 'Playfair Display', serif; font-size: 28px; font-weight: 700; }
  .quiz-stat-lbl { font-size: 11px; color: var(--text2); text-transform: uppercase; letter-spacing: 1.5px; }
  .num-correct { color: var(--success); }
  .num-wrong { color: var(--danger); }

  .quiz-question-card {
    background: var(--surface); border-radius: var(--radius); padding: 32px;
    border: 1px solid var(--border); margin-bottom: 20px; text-align: center;
  }
  .quiz-q-type { font-size: 11px; color: var(--text2); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 16px; }
  .quiz-question { font-family: 'Playfair Display', serif; font-size: 36px; font-weight: 700; color: var(--accent); margin-bottom: 8px; }
  .quiz-phonetic { font-size: 15px; color: var(--accent2); }

  .quiz-options { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
  .quiz-option {
    padding: 16px 20px; background: var(--surface); border: 2px solid var(--border);
    border-radius: 12px; cursor: pointer; font-family: 'DM Sans', sans-serif;
    font-size: 14px; line-height: 1.4; transition: all 0.15s; text-align: left;
    color: var(--text);
  }
  .quiz-option:hover:not(.disabled) { border-color: var(--accent2); background: var(--surface2); color: var(--text); }
  .quiz-option.correct { border-color: var(--success) !important; background: #102a10 !important; color: var(--success) !important; font-weight: 600; }
  .quiz-option.wrong   { border-color: var(--danger) !important; background: #2a1010 !important; color: var(--danger) !important; }
  .quiz-option.reveal  { border-color: var(--success) !important; background: #0d2010 !important; color: var(--success) !important; font-weight: 600; animation: pulse-correct 0.4s ease; }
  @keyframes pulse-correct { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
  .quiz-option.disabled { cursor: default; opacity: 0.75; }
  .quiz-next-btn { width: 100%; padding: 14px; background: var(--accent); color: #0d0d0f; border: none; border-radius: 12px; cursor: pointer; font-family: 'DM Sans', sans-serif; font-size: 15px; font-weight: 600; display: none; }
  .quiz-next-btn.visible { display: block; }

  /* quiz type tabs */
  .quiz-type-tabs { display: flex; gap: 8px; margin-bottom: 20px; }
  .qtype-btn {
    flex: 1; padding: 9px 12px; border-radius: 10px; border: 1px solid var(--border);
    background: var(--surface); color: var(--text2); cursor: pointer; font-family: 'DM Sans', sans-serif;
    font-size: 12px; font-weight: 500; transition: all 0.15s; text-align: center;
  }
  .qtype-btn.active { background: var(--accent2); border-color: var(--accent2); color: #fff; font-weight: 600; }
  .qtype-btn:hover:not(.active) { border-color: var(--accent2); color: var(--text); }

  /* fill-in-blank style */
  .blank-sentence {
    font-size: 18px; color: var(--text); line-height: 1.8; text-align: center;
    padding: 0 8px; margin-top: 8px;
  }
  .blank-word { 
    display: inline-block; min-width: 100px; border-bottom: 2px solid var(--accent);
    color: var(--accent); font-weight: 700; font-family: 'Playfair Display', serif;
    font-size: 20px; text-align: center; padding: 0 6px;
  }

  /* â”€â”€ PROGRESS â”€â”€ */
  .progress-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 32px; }
  .prog-card {
    background: var(--surface); border-radius: var(--radius); padding: 24px;
    border: 1px solid var(--border); position: relative; overflow: hidden;
  }
  .prog-card::after {
    content: ''; position: absolute; top: 0; right: 0; width: 80px; height: 80px;
    border-radius: 0 var(--radius) 0 80px; opacity: 0.07;
  }
  .prog-card.c1::after { background: #7eb8f7; }
  .prog-card.c2::after { background: var(--accent2); }
  .prog-card.c3::after { background: var(--accent); }
  .prog-card.c4::after { background: var(--success); }
  .prog-num { font-family: 'Playfair Display', serif; font-size: 40px; font-weight: 900; line-height: 1; }
  .prog-lbl { font-size: 12px; color: var(--text2); text-transform: uppercase; letter-spacing: 1.5px; margin-top: 6px; }
  .prog-card.c1 .prog-num { color: #7eb8f7; }
  .prog-card.c2 .prog-num { color: var(--accent2); }
  .prog-card.c3 .prog-num { color: var(--accent); }
  .prog-card.c4 .prog-num { color: var(--success); }

  .donut-wrap { display: flex; justify-content: center; margin: 24px 0; }
  svg.donut { transform: rotate(-90deg); }
  .donut-ring { fill: none; stroke-width: 18; }

  .streak-section { background: var(--surface); border-radius: var(--radius); padding: 24px; border: 1px solid var(--border); }
  .streak-title { font-size: 14px; font-weight: 600; margin-bottom: 16px; color: var(--text2); text-transform: uppercase; letter-spacing: 1px; }
  .streak-days { display: flex; gap: 6px; flex-wrap: wrap; }
  .day-dot {
    width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center;
    font-size: 10px; color: var(--text2); border: 1px solid var(--border);
  }
  .day-dot.studied { background: var(--accent); color: #0d0d0f; border-color: var(--accent); font-weight: 700; }

  /* â”€â”€ TOPICS SCREEN â”€â”€ */
  .topics-intro { margin-bottom: 28px; }
  .topics-intro p { color: var(--text2); font-size: 14px; line-height: 1.7; }

  .topic-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 16px; margin-bottom: 32px; }
  .topic-card {
    background: var(--surface); border-radius: var(--radius); padding: 24px;
    border: 1px solid var(--border); cursor: pointer; transition: all 0.2s;
    position: relative; overflow: hidden;
  }
  .topic-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
  .topic-card.active-topic { border-color: var(--accent); background: #1a1a10; }
  .topic-card::before {
    content: ''; position: absolute; top: 0; right: 0;
    width: 60px; height: 60px; border-radius: 0 var(--radius) 0 60px; opacity: 0.12;
  }
  .topic-emoji { font-size: 32px; margin-bottom: 12px; }
  .topic-name { font-family: 'Playfair Display', serif; font-size: 18px; font-weight: 700; margin-bottom: 4px; }
  .topic-count { font-size: 12px; color: var(--text2); }
  .topic-progress-bar { height: 3px; background: var(--border); border-radius: 2px; margin-top: 12px; overflow: hidden; }
  .topic-progress-fill { height: 100%; background: var(--accent); border-radius: 2px; transition: width 0.4s; }
  .topic-mastered { font-size: 11px; color: var(--success); margin-top: 6px; }

  .topic-study-header {
    display: flex; align-items: center; gap: 12px; margin-bottom: 20px;
    padding-bottom: 16px; border-bottom: 1px solid var(--border);
  }
  .topic-back-btn {
    background: var(--surface2); border: 1px solid var(--border); border-radius: 10px;
    padding: 8px 14px; cursor: pointer; font-size: 13px; color: var(--text2);
    font-family: 'DM Sans', sans-serif; transition: all 0.15s;
  }
  .topic-back-btn:hover { color: var(--text); border-color: var(--text2); }
  .topic-study-title { font-family: 'Playfair Display', serif; font-size: 20px; font-weight: 700; }
  .topic-badge { background: var(--accent); color: #0d0d0f; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; margin-left: auto; }

  .topic-word-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-bottom: 24px; }
  .topic-word-chip {
    background: var(--surface2); border: 1px solid var(--border); border-radius: 10px;
    padding: 12px 14px; cursor: pointer; transition: all 0.15s;
  }
  .topic-word-chip:hover { border-color: var(--accent2); }
  .topic-word-chip.chip-mastered { border-color: var(--success); opacity: 0.6; }
  .chip-word { font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 6px; }
  .chip-vn { font-size: 12px; color: var(--text2); margin-top: 2px; }
  .chip-status { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
  .chip-status.s-new      { background: #7eb8f7; }
  .chip-status.s-learning { background: var(--accent2); }
  .chip-status.s-review   { background: var(--accent); }
  .chip-status.s-mastered { background: var(--success); }

  .topic-actions { display: flex; gap: 10px; }

  /* Notification toast */
  .toast {
    position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px);
    background: var(--surface2); border: 1px solid var(--border); border-radius: 12px;
    padding: 12px 24px; font-size: 14px; opacity: 0; pointer-events: none;
    transition: all 0.3s; z-index: 999;
  }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  @media (max-width: 600px) {
    .card-word { font-size: 30px; }
    .quiz-options { grid-template-columns: 1fr; }
    .progress-grid { grid-template-columns: 1fr 1fr; }
    header { flex-direction: column; gap: 16px; align-items: flex-start; }
    .rating-btns { gap: 8px; }
  }
</style>
</head>
<body>
<div id="app">
  <!-- Header -->
  <header>
    <div class="logo">
      <span class="logo-text">IELTS Vocab</span>
      <span class="logo-sub">Master</span>
    </div>
    <div class="header-stats">
      <div class="hstat">
        <div class="hstat-num" id="h-total">0</div>
        <div class="hstat-lbl">Tá»«</div>
      </div>
      <div class="hstat">
        <div class="hstat-num" id="h-due">0</div>
        <div class="hstat-lbl">HÃ´m nay</div>
      </div>
      <div class="hstat">
        <div class="hstat-num" id="h-mastered">0</div>
        <div class="hstat-lbl">Thuá»™c</div>
      </div>
    </div>
  </header>

  <!-- Nav -->
  <div class="nav-tabs">
    <button class="tab-btn active" onclick="switchTab('upload')">ğŸ“‚ Tá»« vá»±ng</button>
    <button class="tab-btn" onclick="switchTab('topics')">ğŸ—‚ Chá»§ Ä‘á»</button>
    <button class="tab-btn" onclick="switchTab('study')">ğŸ§  Há»c</button>
    <button class="tab-btn" onclick="switchTab('quiz')">âš¡ Quiz</button>
    <button class="tab-btn" onclick="switchTab('progress')">ğŸ“Š Tiáº¿n Ä‘á»™</button>
  </div>

  <!-- â•â•â• UPLOAD/WORD LIST SCREEN â•â•â• -->
  <div id="screen-upload" class="screen active">
    <div id="upload-area">
      <div class="upload-zone" id="drop-zone">
        <input type="file" id="csv-input" accept=".csv,.txt">
        <div class="upload-icon">ğŸ“„</div>
        <div class="upload-title">Upload file CSV tá»« vá»±ng IELTS</div>
        <div class="upload-sub">KÃ©o & tháº£ file vÃ o Ä‘Ã¢y hoáº·c click Ä‘á»ƒ chá»n<br>Há»— trá»£ Ä‘á»‹nh dáº¡ng CSV, TXT</div>
      </div>
      <div class="csv-format">
        <strong>ğŸ“‹ Äá»‹nh dáº¡ng CSV:</strong><br><br>
        <code>word,phonetic,type,definition,example,vietnamese</code><br>
        <code>abundant,/É™ËˆbÊŒn.dÉ™nt/,adj,existing in large quantities,Rainfall is abundant here.,phong phÃº</code><br><br>
        <em style="color:#666">* phonetic, type, example, vietnamese lÃ  tÃ¹y chá»n (cÃ³ thá»ƒ Ä‘á»ƒ trá»‘ng)</em>
      </div>
      <div style="text-align:center; margin-top:16px">
        <button class="sample-btn" onclick="loadSampleData()">âœ¨ DÃ¹ng 20 tá»« máº«u IELTS Ä‘á»ƒ thá»­</button>
      </div>
    </div>

    <div id="word-list-area" style="display:none">
      <div class="word-list-header">
        <span class="section-title" id="list-title">Danh sÃ¡ch tá»«</span>
        <div style="display:flex;gap:10px">
          <button class="btn-secondary" onclick="clearAllData()">ğŸ—‘ XÃ³a táº¥t cáº£</button>
          <button class="btn-primary" onclick="switchTab('study')">ğŸ§  Há»c ngay â†’</button>
        </div>
      </div>
      <table class="word-table">
        <thead>
          <tr>
            <th>Tá»«</th>
            <th>Loáº¡i</th>
            <th>NghÄ©a</th>
            <th>Tráº¡ng thÃ¡i</th>
            <th>Ã”n láº¡i</th>
          </tr>
        </thead>
        <tbody id="word-tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- â•â•â• STUDY SCREEN â•â•â• -->
  <div id="screen-study" class="screen">
    <div id="study-content">
      <div class="study-header">
        <span style="font-size:13px;color:var(--text2)" id="study-mode-label">Spaced Repetition</span>
        <div class="progress-bar-wrap"><div class="progress-bar-fill" id="study-progress-bar" style="width:0%"></div></div>
        <span class="study-count" id="study-count">0 / 0</span>
      </div>
      <div class="accent-toggle">
        <span class="accent-label">Giá»ng:</span>
        <button class="accent-btn active" id="acc-us" onclick="setAccent('us')">ğŸ‡ºğŸ‡¸ US</button>
        <button class="accent-btn" id="acc-uk" onclick="setAccent('uk')">ğŸ‡¬ğŸ‡§ UK</button>
      </div>
      <div class="card-container">
        <div class="card" id="study-card" onclick="flipCard()">
          <div class="card-face card-front" id="card-front">
            <div class="card-tag">Tá»ª Vá»°NG IELTS</div>
            <div class="card-word" id="cf-word">â€”</div>
            <div class="card-phonetic" id="cf-phonetic"></div>
            <div class="card-type" id="cf-type"></div>
            <button class="speak-btn" id="speak-front-btn" onclick="event.stopPropagation(); speakCurrentWord()">
              <span class="wave"><span></span><span></span><span></span></span>
              PhÃ¡t Ã¢m
            </button>
            <div class="card-hint" style="margin-top:8px">Click Ä‘á»ƒ láº­t card</div>
          </div>
          <div class="card-face card-back" id="card-back">
            <div class="card-tag">Äá»ŠNH NGHÄ¨A</div>
            <div class="card-definition" id="cb-def"></div>
            <div class="card-vn" id="cb-vn"></div>
            <div class="card-example" id="cb-ex"></div>
            <button class="speak-btn" onclick="event.stopPropagation(); speakCurrentWord()">
              <span class="wave"><span></span><span></span><span></span></span>
              Nghe láº¡i
            </button>
          </div>
        </div>
      </div>
      <div class="rating-section" id="rating-section">
        <div class="rating-label">Báº¡n nhá»› tá»« nÃ y á»Ÿ má»©c nÃ o?</div>
        <div class="rating-btns">
          <button class="rating-btn btn-again" onclick="rateCard(0)">
            <span class="emoji">ğŸ˜°</span>
            <span class="label">QuÃªn rá»“i</span>
            <span class="next-review" id="next-again"></span>
          </button>
          <button class="rating-btn btn-hard" onclick="rateCard(1)">
            <span class="emoji">ğŸ˜…</span>
            <span class="label">KhÃ³</span>
            <span class="next-review" id="next-hard"></span>
          </button>
          <button class="rating-btn btn-good" onclick="rateCard(2)">
            <span class="emoji">ğŸ˜Š</span>
            <span class="label">Nhá»› Ä‘Æ°á»£c</span>
            <span class="next-review" id="next-good"></span>
          </button>
          <button class="rating-btn btn-easy" onclick="rateCard(3)">
            <span class="emoji">ğŸ‰</span>
            <span class="label">Dá»… quÃ¡!</span>
            <span class="next-review" id="next-easy"></span>
          </button>
        </div>
      </div>
    </div>
    <div class="no-cards-due" id="no-cards-msg" style="display:none">
      <div class="big-icon">ğŸ‰</div>
      <h3>HoÃ n thÃ nh rá»“i!</h3>
      <p>Báº¡n Ä‘Ã£ há»c háº¿t táº¥t cáº£ tá»« cáº§n Ã´n hÃ´m nay.<br>Quay láº¡i vÃ o ngÃ y mai Ä‘á»ƒ tiáº¿p tá»¥c!</p>
      <br>
      <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
        <button class="btn-primary" onclick="switchTab('progress')">Xem tiáº¿n Ä‘á»™ â†’</button>
        <button class="btn-secondary" id="clear-filter-btn" style="display:none" onclick="clearTopicFilter()">ğŸ“š Há»c táº¥t cáº£ tá»«</button>
      </div>
    </div>
  </div>

  <!-- â•â•â• QUIZ SCREEN â•â•â• -->
  <div id="screen-quiz" class="screen">
    <div class="quiz-info">
      <div class="quiz-stat">
        <div class="quiz-stat-num num-correct" id="q-correct">0</div>
        <div class="quiz-stat-lbl">ÄÃºng</div>
      </div>
      <div class="quiz-stat">
        <div class="quiz-stat-num num-wrong" id="q-wrong">0</div>
        <div class="quiz-stat-lbl">Sai</div>
      </div>
      <div class="quiz-stat">
        <div class="quiz-stat-num" id="q-total-done" style="color:var(--accent)">0</div>
        <div class="quiz-stat-lbl">Tá»•ng</div>
      </div>
      <div class="quiz-stat">
        <div class="quiz-stat-num" id="q-accuracy" style="color:var(--accent3)">â€”</div>
        <div class="quiz-stat-lbl">ChÃ­nh xÃ¡c</div>
      </div>
    </div>
    <div id="quiz-area">
      <div class="quiz-type-tabs">
        <button class="qtype-btn active" id="qtype-meaning" onclick="setQuizType('meaning')">ğŸ“– Chá»n nghÄ©a</button>
        <button class="qtype-btn" id="qtype-word" onclick="setQuizType('word')">âœï¸ Chá»n tá»« vÃ o cÃ¢u</button>
        <button class="qtype-btn" id="qtype-random" onclick="setQuizType('random')">ğŸ² Ngáº«u nhiÃªn</button>
      </div>
      <div class="quiz-question-card" id="quiz-question-card">
        <div class="quiz-q-type" id="quiz-q-type-label">Chá»n nghÄ©a Ä‘Ãºng cá»§a tá»«</div>
        <div class="quiz-question" id="quiz-word">â€”</div>
        <div class="quiz-phonetic" id="quiz-phonetic"></div>
        <div class="blank-sentence" id="quiz-sentence" style="display:none"></div>
        <button class="speak-btn" id="speak-quiz-btn" onclick="speakWord(document.getElementById('quiz-word').textContent)" style="margin-top:8px">
          <span class="wave"><span></span><span></span><span></span></span>
          PhÃ¡t Ã¢m
        </button>
      </div>
      <div class="quiz-options" id="quiz-options"></div>
      <button class="quiz-next-btn" id="quiz-next-btn" onclick="nextQuizQuestion()">CÃ¢u tiáº¿p theo â†’</button>
    </div>
    <div id="quiz-empty" style="display:none; text-align:center; padding:60px 20px; color:var(--text2)">
      <div style="font-size:48px;margin-bottom:16px">ğŸ“š</div>
      <p>Cáº§n Ã­t nháº¥t 4 tá»« Ä‘á»ƒ báº¯t Ä‘áº§u quiz.<br>HÃ£y upload tá»« vá»±ng trÆ°á»›c nhÃ©!</p>
      <br>
      <button class="btn-primary" onclick="switchTab('upload')">Upload tá»« vá»±ng</button>
    </div>
  </div>

  <!-- â•â•â• TOPICS SCREEN â•â•â• -->
  <div id="screen-topics" class="screen">

    <!-- â”€â”€ View 1: Topic list â”€â”€ -->
    <div id="topics-list-view">
      <div class="word-list-header" style="margin-bottom:20px">
        <span class="section-title">ğŸ—‚ Chá»§ Ä‘á» tá»« vá»±ng</span>
        <button class="btn-primary" onclick="showAddTopicForm()">ï¼‹ ThÃªm chá»§ Ä‘á»</button>
      </div>

      <!-- Add topic form (hidden by default) -->
      <div id="add-topic-form" style="display:none; background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:24px; margin-bottom:24px;">
        <div style="font-weight:600; font-size:15px; margin-bottom:16px;">â• Táº¡o chá»§ Ä‘á» má»›i</div>
        <div style="display:grid; grid-template-columns:60px 1fr; gap:12px; margin-bottom:16px; align-items:center;">
          <div>
            <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px;">Icon</label>
            <input id="new-topic-emoji" type="text" maxlength="2" value="ğŸ“š"
              style="width:100%;padding:10px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:20px;text-align:center;font-family:inherit;">
          </div>
          <div>
            <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px;">TÃªn chá»§ Ä‘á»</label>
            <input id="new-topic-name" type="text" placeholder="VD: Architecture, Environment..."
              style="width:100%;padding:10px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:inherit;font-size:14px;">
          </div>
        </div>
        <div style="margin-bottom:16px;">
          <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:8px;">Upload file CSV cho chá»§ Ä‘á» nÃ y</label>
          <div class="upload-zone" id="topic-drop-zone" style="padding:24px 16px;">
            <input type="file" id="topic-csv-input" accept=".csv,.txt" style="position:absolute;inset:0;opacity:0;cursor:pointer;">
            <div style="font-size:28px;margin-bottom:8px;">ğŸ“„</div>
            <div style="font-size:14px;font-weight:600;margin-bottom:4px;" id="topic-file-label">KÃ©o tháº£ hoáº·c click Ä‘á»ƒ chá»n CSV</div>
            <div style="font-size:12px;color:var(--text2);">word, phonetic, type, definition, example, vietnamese</div>
          </div>
        </div>
        <div style="display:flex;gap:10px;">
          <button class="btn-primary" onclick="confirmAddTopic()">âœ… Táº¡o chá»§ Ä‘á»</button>
          <button class="btn-secondary" onclick="hideAddTopicForm()">Huá»·</button>
        </div>
      </div>

      <!-- Topic cards grid -->
      <div id="topic-grid-empty" style="display:none; text-align:center; padding:48px 20px; color:var(--text2);">
        <div style="font-size:48px;margin-bottom:16px">ğŸ—‚</div>
        <p style="font-size:15px;line-height:1.7">ChÆ°a cÃ³ chá»§ Ä‘á» nÃ o.<br>Nháº¥n <strong style="color:var(--accent)">ï¼‹ ThÃªm chá»§ Ä‘á»</strong> Ä‘á»ƒ táº¡o chá»§ Ä‘á» Ä‘áº§u tiÃªn!</p>
      </div>
      <div class="topic-grid" id="topic-grid"></div>
    </div>

    <!-- â”€â”€ View 2: Topic detail â”€â”€ -->
    <div id="topics-detail-view" style="display:none">
      <div class="topic-study-header">
        <button class="topic-back-btn" onclick="showTopicList()">â† Quay láº¡i</button>
        <span class="topic-study-title" id="topic-detail-title"></span>
        <span class="topic-badge" id="topic-detail-badge"></span>
        <button onclick="deleteCurrentTopic()" style="background:none;border:none;cursor:pointer;font-size:18px;margin-left:8px;opacity:0.5;" title="XoÃ¡ chá»§ Ä‘á»">ğŸ—‘</button>
      </div>
      <div id="topic-word-list"></div>
      <div class="topic-actions">
        <button class="btn-primary" onclick="studyTopic()">ğŸ§  Há»c chá»§ Ä‘á» nÃ y</button>
        <button class="btn-secondary" onclick="quizTopic()">âš¡ Quiz chá»§ Ä‘á» nÃ y</button>
      </div>
    </div>
  </div>

  <!-- â•â•â• PROGRESS SCREEN â•â•â• -->
  <div id="screen-progress" class="screen">
    <div class="progress-grid">
      <div class="prog-card c1">
        <div class="prog-num" id="p-new">0</div>
        <div class="prog-lbl">ğŸ†• Má»›i</div>
      </div>
      <div class="prog-card c2">
        <div class="prog-num" id="p-learning">0</div>
        <div class="prog-lbl">ğŸ“– Äang há»c</div>
      </div>
      <div class="prog-card c3">
        <div class="prog-num" id="p-review">0</div>
        <div class="prog-lbl">ğŸ”„ Cáº§n Ã´n</div>
      </div>
      <div class="prog-card c4">
        <div class="prog-num" id="p-mastered">0</div>
        <div class="prog-lbl">âœ… ÄÃ£ thuá»™c</div>
      </div>
    </div>

    <div style="text-align:center; margin:8px 0 24px">
      <div class="donut-wrap">
        <svg class="donut" width="160" height="160" viewBox="0 0 160 160">
          <circle class="donut-ring" cx="80" cy="80" r="62" stroke="#1e1e24"/>
          <circle class="donut-ring" id="donut-ring" cx="80" cy="80" r="62" stroke="#6bcb77" stroke-dasharray="0 390" stroke-linecap="round"/>
        </svg>
      </div>
      <div style="font-family:'Playfair Display',serif; font-size:18px; color:var(--text2); margin-top:-8px">
        <span id="mastered-pct" style="font-size:32px; color:var(--success); font-weight:900">0%</span> Ä‘Ã£ thuá»™c
      </div>
    </div>

    <div class="streak-section">
      <div class="streak-title">ğŸ“… Lá»‹ch sá»­ há»c (30 ngÃ y gáº§n nháº¥t)</div>
      <div class="streak-days" id="streak-days"></div>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA & STORAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STORAGE_KEY = 'ielts_vocab_v2';

function loadData() {
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || { words: [], studyLog: [] }; }
  catch { return { words: [], studyLog: [] }; }
}
function saveData(d) { localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); }

let DB = loadData();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SAMPLE DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SAMPLE_WORDS = [
  ['abundant','/É™ËˆbÊŒn.dÉ™nt/','adj','existing in large quantities','Rainfall is abundant in this region.','phong phÃº'],
  ['alleviate','/É™ËˆliË.vi.eÉªt/','v','to make something bad less severe','Exercise can alleviate stress.','giáº£m bá»›t'],
  ['ambiguous','/Ã¦mËˆbÉªÉ¡.ju.É™s/','adj','having more than one possible meaning','The instructions were ambiguous.','mÆ¡ há»“, khÃ´ng rÃµ rÃ ng'],
  ['coherent','/kÉ™ÊŠËˆhÉªÉ™r.É™nt/','adj','logical and well-organized','She presented a coherent argument.','máº¡ch láº¡c, nháº¥t quÃ¡n'],
  ['contemporary','/kÉ™nËˆtem.pÉ™r.É™r.i/','adj','belonging to the present time','Contemporary art is very diverse.','Ä‘Æ°Æ¡ng Ä‘áº¡i, hiá»‡n Ä‘áº¡i'],
  ['controversial','/ËŒkÉ’n.trÉ™ËˆvÉœË.ÊƒÉ™l/','adj','causing disagreement or discussion','Climate change is a controversial topic.','gÃ¢y tranh cÃ£i'],
  ['deteriorate','/dÉªËˆtÉªÉ™r.i.É™r.eÉªt/','v','to become worse','Air quality has deteriorated.','xáº¥u Ä‘i, suy giáº£m'],
  ['empirical','/emËˆpÉªr.Éª.kÉ™l/','adj','based on observation and experiment','Empirical evidence supports the theory.','theo kinh nghiá»‡m thá»±c tiá»…n'],
  ['facilitate','/fÉ™ËˆsÉªl.Éª.teÉªt/','v','to make something easier','Technology facilitates communication.','táº¡o Ä‘iá»u kiá»‡n, thÃºc Ä‘áº©y'],
  ['fundamental','/ËŒfÊŒn.dÉ™Ëˆmen.tl/','adj','forming the base or most important part','Trust is fundamental to any relationship.','cÆ¡ báº£n, ná»n táº£ng'],
  ['inevitable','/ÉªËˆnev.Éª.tÉ™.bÉ™l/','adj','certain to happen','Change is inevitable.','khÃ´ng thá»ƒ trÃ¡nh khá»i'],
  ['innovative','/ËˆÉªn.É™.veÉª.tÉªv/','adj','using new methods or ideas','The company has an innovative approach.','sÃ¡ng táº¡o, Ä‘á»•i má»›i'],
  ['mitigate','/ËˆmÉªt.Éª.É¡eÉªt/','v','to make less harmful or serious','Steps were taken to mitigate the damage.','giáº£m nháº¹, háº¡n cháº¿'],
  ['paramount','/ËˆpÃ¦r.É™.maÊŠnt/','adj','more important than anything else','Safety is of paramount importance.','tá»‘i quan trá»ng'],
  ['profound','/prÉ™ËˆfaÊŠnd/','adj','very great or intense','The discovery had a profound effect.','sÃ¢u sáº¯c, thÃ¢m thÃºy'],
  ['rhetoric','/Ëˆret.É™r.Éªk/','n','persuasive language','Politicians often use rhetoric.','tu tá»«, hÃ¹ng biá»‡n'],
  ['scrutiny','/ËˆskruË.tÉª.ni/','n','careful and detailed examination','The plan is under public scrutiny.','sá»± kiá»ƒm tra ká»¹ lÆ°á»¡ng'],
  ['skeptical','/Ëˆskep.tÉª.kÉ™l/','adj','having doubts','Scientists are skeptical of the claim.','hoÃ i nghi'],
  ['sustainable','/sÉ™ËˆsteÉª.nÉ™.bÉ™l/','adj','able to continue at the same rate','Sustainable development is crucial.','bá»n vá»¯ng'],
  ['undermine','/ËŒÊŒn.dÉ™ËˆmaÉªn/','v','to make weaker or less effective','Stress can undermine your health.','lÃ m suy yáº¿u, phÃ¡ hoáº¡i']
];

function loadSampleData() {
  const now = Date.now();
  DB.words = SAMPLE_WORDS.map((r, i) => ({
    id: i,
    word: r[0], phonetic: r[1], type: r[2],
    definition: r[3], example: r[4], vietnamese: r[5],
    interval: 0, repetition: 0, efactor: 2.5,
    dueDate: now, status: 'new'
  }));
  saveData(DB);
  renderAll();
  switchTab('upload');
  showToast('âœ… ÄÃ£ táº£i 20 tá»« máº«u IELTS!');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOPIC SYSTEM  (user-uploaded CSV per topic)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let activeTopicFilter = null;
let pendingTopicCSVWords = [];   // parsed words waiting to be assigned to new topic
let currentDetailTopicId = null;

// Topic metadata stored separately in DB.topics = [ { id, name, emoji, color } ]
const TOPIC_COLORS = ['#c8a96e','#7c6ee0','#4ecdc4','#6bcb77','#ff8c69','#e8c547','#7eb8f7','#f78fb3'];

function getTopics() {
  if (!DB.topics) DB.topics = [];
  return DB.topics;
}

// â”€â”€ Add topic form â”€â”€
function showAddTopicForm() {
  document.getElementById('add-topic-form').style.display = 'block';
  pendingTopicCSVWords = [];
  document.getElementById('topic-file-label').textContent = 'KÃ©o tháº£ hoáº·c click Ä‘á»ƒ chá»n CSV';
  document.getElementById('new-topic-name').value = '';
  document.getElementById('new-topic-emoji').value = 'ğŸ“š';
}
function hideAddTopicForm() {
  document.getElementById('add-topic-form').style.display = 'none';
  pendingTopicCSVWords = [];
}

// Topic CSV input
document.getElementById('topic-csv-input').addEventListener('change', function(e) {
  const file = e.target.files[0]; if (!file) return;
  readTopicCSV(file);
  this.value = '';
});

const topicDropZone = document.getElementById('topic-drop-zone');
topicDropZone.addEventListener('dragover', e => { e.preventDefault(); topicDropZone.classList.add('dragover'); });
topicDropZone.addEventListener('dragleave', () => topicDropZone.classList.remove('dragover'));
topicDropZone.addEventListener('drop', e => {
  e.preventDefault(); topicDropZone.classList.remove('dragover');
  const file = e.dataTransfer.files[0]; if (file) readTopicCSV(file);
});

function readTopicCSV(file) {
  const reader = new FileReader();
  reader.onload = ev => {
    pendingTopicCSVWords = parseCSV(ev.target.result);
    document.getElementById('topic-file-label').textContent = `âœ… ${pendingTopicCSVWords.length} tá»« Ä‘Ã£ Ä‘á»c: ${file.name}`;
    showToast(`ğŸ“„ Äá»c Ä‘Æ°á»£c ${pendingTopicCSVWords.length} tá»«`);
  };
  reader.readAsText(file, 'UTF-8');
}

function confirmAddTopic() {
  const name = document.getElementById('new-topic-name').value.trim();
  const emoji = document.getElementById('new-topic-emoji').value.trim() || 'ğŸ“š';
  if (!name) { showToast('âš ï¸ HÃ£y nháº­p tÃªn chá»§ Ä‘á»'); return; }
  if (!pendingTopicCSVWords.length) { showToast('âš ï¸ HÃ£y upload file CSV'); return; }

  const topics = getTopics();
  const id = 'topic_' + Date.now();
  const color = TOPIC_COLORS[topics.length % TOPIC_COLORS.length];
  topics.push({ id, name, emoji, color });
  DB.topics = topics;

  // Assign topic id to each word and add to DB
  const now = Date.now();
  pendingTopicCSVWords.forEach((w, i) => {
    w.id = now + i + Math.random();
    w.topic = id;
    DB.words.push(w);
  });
  saveData(DB);
  pendingTopicCSVWords = [];
  hideAddTopicForm();
  renderTopicGrid();
  renderAll();
  showToast(`âœ… ÄÃ£ táº¡o chá»§ Ä‘á» "${name}" vá»›i ${DB.words.filter(w=>w.topic===id).length} tá»«!`);
}

// â”€â”€ Render topic grid â”€â”€
function renderTopicGrid() {
  const topics = getTopics();
  const grid = document.getElementById('topic-grid');
  const empty = document.getElementById('topic-grid-empty');
  if (!topics.length) {
    grid.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';
  grid.innerHTML = topics.map(topic => {
    const topicWords = DB.words.filter(w => w.topic === topic.id);
    const total = topicWords.length;
    const mastered = topicWords.filter(w => w.status === 'mastered').length;
    const pct = total ? Math.round(mastered / total * 100) : 0;
    return `
      <div class="topic-card ${activeTopicFilter === topic.id ? 'active-topic' : ''}"
           onclick="openTopic('${topic.id}')"
           style="border-top: 3px solid ${topic.color}">
        <div class="topic-emoji">${topic.emoji}</div>
        <div class="topic-name" style="color:${topic.color}">${topic.name}</div>
        <div class="topic-count">${total} tá»« vá»±ng Â· ${mastered} Ä‘Ã£ thuá»™c</div>
        <div class="topic-progress-bar">
          <div class="topic-progress-fill" style="width:${pct}%;background:${topic.color}"></div>
        </div>
        <div class="topic-mastered">${pct}% hoÃ n thÃ nh</div>
      </div>`;
  }).join('');
}

// â”€â”€ Open topic detail â”€â”€
function openTopic(topicId) {
  const topic = getTopics().find(t => t.id === topicId);
  if (!topic) return;
  currentDetailTopicId = topicId;
  const words = DB.words.filter(w => w.topic === topicId);

  document.getElementById('topic-detail-title').textContent = `${topic.emoji} ${topic.name}`;
  document.getElementById('topic-detail-badge').textContent = `${words.length} tá»«`;

  const list = document.getElementById('topic-word-list');
  list.innerHTML = `<div class="topic-word-grid">` + words.map(w => `
    <div class="topic-word-chip ${w.status === 'mastered' ? 'chip-mastered' : ''}"
         onclick="speakWord('${w.word.replace(/'/g,"\\'")}')">
      <div class="chip-word">
        <span class="chip-status s-${w.status}"></span>
        ${w.word}
      </div>
      <div class="chip-vn">${w.vietnamese || w.definition || ''}</div>
    </div>`).join('') + `</div>`;

  document.getElementById('topics-list-view').style.display = 'none';
  document.getElementById('topics-detail-view').style.display = 'block';
  activeTopicFilter = topicId;
}

function showTopicList() {
  document.getElementById('topics-list-view').style.display = 'block';
  document.getElementById('topics-detail-view').style.display = 'none';
  currentDetailTopicId = null;
  renderTopicGrid();
}

function deleteCurrentTopic() {
  const topic = getTopics().find(t => t.id === currentDetailTopicId);
  if (!topic) return;
  if (!confirm(`XoÃ¡ chá»§ Ä‘á» "${topic.name}" vÃ  toÃ n bá»™ ${DB.words.filter(w=>w.topic===topic.id).length} tá»«?`)) return;
  DB.topics = DB.topics.filter(t => t.id !== currentDetailTopicId);
  DB.words = DB.words.filter(w => w.topic !== currentDetailTopicId);
  if (activeTopicFilter === currentDetailTopicId) activeTopicFilter = null;
  saveData(DB);
  renderAll();
  showTopicList();
  showToast(`ğŸ—‘ ÄÃ£ xoÃ¡ chá»§ Ä‘á» "${topic.name}"`);
}

function studyTopic() {
  switchTab('study');
}
function quizTopic() {
  switchTab('quiz');
}
function clearTopicFilter() {
  activeTopicFilter = null;
  initStudy();
}
function parseCSV(text) {
  const lines = text.trim().split('\n');
  let start = 0;
  if (lines[0].toLowerCase().includes('word')) start = 1; // skip header
  const words = [];
  const now = Date.now();
  lines.slice(start).forEach((line, idx) => {
    const parts = splitCSVLine(line);
    if (!parts[0] || !parts[0].trim()) return;
    words.push({
      id: Date.now() + idx,
      word: (parts[0] || '').trim(),
      phonetic: (parts[1] || '').trim(),
      type: (parts[2] || '').trim(),
      definition: (parts[3] || '').trim(),
      example: (parts[4] || '').trim(),
      vietnamese: (parts[5] || '').trim(),
      interval: 0, repetition: 0, efactor: 2.5,
      dueDate: now, status: 'new'
    });
  });
  return words;
}

function splitCSVLine(line) {
  const result = []; let cur = ''; let inQ = false;
  for (let c of line) {
    if (c === '"') { inQ = !inQ; }
    else if (c === ',' && !inQ) { result.push(cur); cur = ''; }
    else cur += c;
  }
  result.push(cur);
  return result;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILE UPLOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('csv-input').addEventListener('change', function(e) {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    const words = parseCSV(ev.target.result);
    if (!words.length) { showToast('âš ï¸ KhÃ´ng Ä‘á»c Ä‘Æ°á»£c tá»« nÃ o tá»« file'); return; }
    DB.words = words; saveData(DB); renderAll();
    switchTab('upload');
    showToast(`âœ… ÄÃ£ import ${words.length} tá»« vá»±ng!`);
  };
  reader.readAsText(file, 'UTF-8');
});

const dropZone = document.getElementById('drop-zone');
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', e => {
  e.preventDefault(); dropZone.classList.remove('dragover');
  const file = e.dataTransfer.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    const words = parseCSV(ev.target.result);
    if (!words.length) { showToast('âš ï¸ KhÃ´ng Ä‘á»c Ä‘Æ°á»£c tá»« nÃ o'); return; }
    DB.words = words; saveData(DB); renderAll();
    showToast(`âœ… ÄÃ£ import ${words.length} tá»« vá»±ng!`);
  };
  reader.readAsText(file, 'UTF-8');
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll() {
  renderHeader();
  renderWordList();
  renderProgress();
}

function renderHeader() {
  const total = DB.words.length;
  const due = getDueWords().length;
  const mastered = DB.words.filter(w => w.status === 'mastered').length;
  document.getElementById('h-total').textContent = total;
  document.getElementById('h-due').textContent = due;
  document.getElementById('h-mastered').textContent = mastered;
}

function renderWordList() {
  const tbody = document.getElementById('word-tbody');
  const hasWords = DB.words.length > 0;
  document.getElementById('upload-area').style.display = hasWords ? 'none' : 'block';
  document.getElementById('word-list-area').style.display = hasWords ? 'block' : 'none';
  if (!hasWords) return;
  document.getElementById('list-title').textContent = `ğŸ“š ${DB.words.length} tá»« vá»±ng`;
  tbody.innerHTML = DB.words.map(w => {
    const badge = { new: '<span class="badge badge-new">Má»›i</span>', learning: '<span class="badge badge-learning">Äang há»c</span>', review: '<span class="badge badge-review">Cáº§n Ã´n</span>', mastered: '<span class="badge badge-mastered">Thuá»™c rá»“i</span>' }[w.status] || '';
    const due = w.dueDate ? formatDue(w.dueDate) : 'â€”';
    return `<tr>
      <td>
        <strong>${w.word}</strong>
        <button class="speak-sm" onclick="speakWord('${w.word.replace(/'/g,"\\'")}')">ğŸ”Š</button>
        ${w.phonetic ? `<br><small style="color:var(--accent2)">${w.phonetic}</small>` : ''}
      </td>
      <td><small style="color:var(--text2)">${w.type || 'â€”'}</small></td>
      <td style="max-width:220px">${w.definition || w.vietnamese || 'â€”'}</td>
      <td>${badge}</td>
      <td class="interval-text">${due}</td>
    </tr>`;
  }).join('');
}

function formatDue(ts) {
  const diff = ts - Date.now();
  if (diff <= 0) return '<span style="color:var(--accent)">HÃ´m nay</span>';
  const d = Math.ceil(diff / 86400000);
  return d === 1 ? 'NgÃ y mai' : `${d} ngÃ y ná»¯a`;
}

function renderProgress() {
  const counts = { new: 0, learning: 0, review: 0, mastered: 0 };
  DB.words.forEach(w => counts[w.status] = (counts[w.status] || 0) + 1);
  document.getElementById('p-new').textContent = counts.new;
  document.getElementById('p-learning').textContent = counts.learning;
  document.getElementById('p-review').textContent = counts.review;
  document.getElementById('p-mastered').textContent = counts.mastered;
  const total = DB.words.length;
  const pct = total ? Math.round(counts.mastered / total * 100) : 0;
  document.getElementById('mastered-pct').textContent = pct + '%';
  const circumference = 2 * Math.PI * 62;
  const fill = circumference * pct / 100;
  document.getElementById('donut-ring').setAttribute('stroke-dasharray', `${fill} ${circumference}`);
  renderStreak();
}

function renderStreak() {
  const el = document.getElementById('streak-days');
  const today = new Date(); today.setHours(0,0,0,0);
  const log = new Set(DB.studyLog || []);
  el.innerHTML = '';
  for (let i = 29; i >= 0; i--) {
    const d = new Date(today); d.setDate(d.getDate() - i);
    const key = d.toISOString().slice(0,10);
    const studied = log.has(key);
    const label = d.getDate();
    el.innerHTML += `<div class="day-dot ${studied ? 'studied' : ''}" title="${key}">${label}</div>`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SPACED REPETITION (SM-2 algorithm)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getDueWords() {
  const now = Date.now();
  const pool = activeTopicFilter
    ? DB.words.filter(w => w.topic === activeTopicFilter)
    : DB.words;
  return pool.filter(w => w.dueDate <= now);
}

let studyQueue = [], currentIdx = 0, cardFlipped = false;

function initStudy() {
  const topic = activeTopicFilter ? getTopics().find(t => t.id === activeTopicFilter) : null;
  const label = document.getElementById('study-mode-label');
  if (label) label.textContent = topic ? `${topic.emoji} ${topic.name}` : 'Spaced Repetition';

  studyQueue = getDueWords();
  // Shuffle
  for (let i = studyQueue.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [studyQueue[i], studyQueue[j]] = [studyQueue[j], studyQueue[i]];
  }
  currentIdx = 0;
  showStudyCard();
}

function showStudyCard() {
  const noMsg = document.getElementById('no-cards-msg');
  const content = document.getElementById('study-content');
  if (currentIdx >= studyQueue.length) {
    noMsg.style.display = 'block';
    content.style.display = 'none';
    // Show "study all" button if in topic filter mode
    const cfBtn = document.getElementById('clear-filter-btn');
    if (cfBtn) cfBtn.style.display = activeTopicFilter ? 'inline-block' : 'none';
    // Log today
    const today = new Date().toISOString().slice(0,10);
    if (!DB.studyLog) DB.studyLog = [];
    if (!DB.studyLog.includes(today)) DB.studyLog.push(today);
    saveData(DB);
    renderProgress();
    return;
  }
  noMsg.style.display = 'none';
  content.style.display = 'block';

  const w = studyQueue[currentIdx];
  const total = studyQueue.length;
  document.getElementById('study-count').textContent = `${currentIdx + 1} / ${total}`;
  document.getElementById('study-progress-bar').style.width = `${(currentIdx / total) * 100}%`;

  document.getElementById('cf-word').textContent = w.word;
  document.getElementById('cf-phonetic').textContent = w.phonetic || '';
  document.getElementById('cf-type').textContent = w.type ? `(${w.type})` : '';
  document.getElementById('cb-def').textContent = w.definition || 'â€”';
  document.getElementById('cb-vn').textContent = w.vietnamese ? `ğŸ‡»ğŸ‡³ ${w.vietnamese}` : '';
  document.getElementById('cb-ex').textContent = w.example ? `"${w.example}"` : '';

  // Reset card
  const card = document.getElementById('study-card');
  card.classList.remove('flipped');
  cardFlipped = false;
  document.getElementById('rating-section').classList.remove('visible');

  // Set current word for speak buttons & auto-play
  currentWord = w.word;
  clearTimeout(speakTimer);
  speakTimer = setTimeout(() => speakWord(w.word), 400);

  // Preview intervals
  previewNextIntervals(w);
}

function previewNextIntervals(w) {
  const ratings = [0, 1, 2, 3];
  const labels = ['next-again', 'next-hard', 'next-good', 'next-easy'];
  ratings.forEach((q, i) => {
    const sim = simulateSM2(w, q);
    document.getElementById(labels[i]).textContent = sim.interval === 0 ? '< 1 ngÃ y' : sim.interval === 1 ? '1 ngÃ y' : `${sim.interval} ngÃ y`;
  });
}

function simulateSM2(w, q) {
  let { interval, repetition, efactor } = w;
  if (q < 1) { repetition = 0; interval = 0; }
  else {
    if (repetition === 0) interval = 1;
    else if (repetition === 1) interval = 6;
    else interval = Math.round(interval * efactor);
    repetition++;
    efactor = Math.max(1.3, efactor + 0.1 - (3 - q) * (0.08 + (3 - q) * 0.02));
    if (q === 1) { interval = Math.max(1, Math.round(interval * 0.5)); }
    if (q === 3) { interval = Math.round(interval * 1.3); }
  }
  return { interval, repetition, efactor };
}

function flipCard() {
  const card = document.getElementById('study-card');
  cardFlipped = !cardFlipped;
  card.classList.toggle('flipped', cardFlipped);
  if (cardFlipped) {
    setTimeout(() => document.getElementById('rating-section').classList.add('visible'), 300);
  } else {
    document.getElementById('rating-section').classList.remove('visible');
  }
}

function rateCard(q) {
  const w = studyQueue[currentIdx];
  const wordInDB = DB.words.find(x => x.id === w.id);
  if (!wordInDB) { currentIdx++; showStudyCard(); return; }

  const { interval, repetition, efactor } = simulateSM2(wordInDB, q);
  wordInDB.interval = interval;
  wordInDB.repetition = repetition;
  wordInDB.efactor = efactor;

  if (interval === 0) {
    wordInDB.dueDate = Date.now() + 10 * 60 * 1000; // 10 minutes
    wordInDB.status = 'learning';
  } else {
    wordInDB.dueDate = Date.now() + interval * 86400000;
    wordInDB.status = interval >= 21 ? 'mastered' : interval >= 4 ? 'review' : 'learning';
  }

  saveData(DB);
  renderHeader();
  currentIdx++;
  showStudyCard();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  QUIZ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let quizCorrect = 0, quizWrong = 0, quizTotal = 0;
let quizType = 'meaning'; // 'meaning' | 'word' | 'random'
let currentQuizCorrectId = null;

function setQuizType(type) {
  quizType = type;
  document.querySelectorAll('.qtype-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('qtype-' + type).classList.add('active');
  nextQuizQuestion();
}

function initQuiz() {
  quizCorrect = 0; quizWrong = 0; quizTotal = 0;
  updateQuizStats();
  const pool = activeTopicFilter ? DB.words.filter(w => w.topic === activeTopicFilter) : DB.words;
  if (pool.length < 4) {
    document.getElementById('quiz-area').style.display = 'none';
    document.getElementById('quiz-empty').style.display = 'block';
  } else {
    document.getElementById('quiz-area').style.display = 'block';
    document.getElementById('quiz-empty').style.display = 'none';
    nextQuizQuestion();
  }
}

function nextQuizQuestion() {
  const words = activeTopicFilter ? DB.words.filter(w => w.topic === activeTopicFilter) : DB.words;
  if (words.length < 4) return;

  // Pick actual type
  const type = quizType === 'random'
    ? (Math.random() < 0.5 ? 'meaning' : 'word')
    : quizType;

  const idx = Math.floor(Math.random() * words.length);
  const correct = words[idx];
  currentQuizCorrectId = correct.id;

  // 4 options pool
  let pool = words.filter((_, i) => i !== idx);
  let distractors = [];
  while (distractors.length < 3 && pool.length) {
    const r = Math.floor(Math.random() * pool.length);
    distractors.push(pool.splice(r, 1)[0]);
  }
  let options = [correct, ...distractors].sort(() => Math.random() - 0.5);

  // Auto-speak only for meaning mode
  currentWord = correct.word;
  clearTimeout(speakTimer);
  if (type === 'meaning') {
    speakTimer = setTimeout(() => speakWord(correct.word), 300);
  }

  document.getElementById('quiz-next-btn').classList.remove('visible');

  if (type === 'meaning') {
    // â”€â”€ Mode A: show word â†’ pick definition â”€â”€
    document.getElementById('quiz-q-type-label').textContent = 'ğŸ“– Chá»n nghÄ©a Ä‘Ãºng cá»§a tá»«';
    document.getElementById('quiz-word').style.display = 'block';
    document.getElementById('quiz-word').textContent = correct.word;
    document.getElementById('quiz-phonetic').textContent = correct.phonetic || '';
    document.getElementById('quiz-sentence').style.display = 'none';
    document.getElementById('speak-quiz-btn').style.display = 'inline-flex';

    document.getElementById('quiz-options').innerHTML = options.map(o => {
      const ans = o.definition || o.vietnamese || 'â€”';
      return `<button class="quiz-option" data-id="${o.id}" onclick="checkAnswer(this, '${o.id}', '${correct.id}')">${ans}</button>`;
    }).join('');

  } else {
    // â”€â”€ Mode B: show sentence with blank â†’ pick correct word â”€â”€
    document.getElementById('quiz-q-type-label').textContent = 'âœï¸ Chá»n tá»« Ä‘Ãºng Ä‘iá»n vÃ o cÃ¢u';
    document.getElementById('quiz-word').style.display = 'none';
    document.getElementById('quiz-phonetic').textContent = '';

    // Build sentence: use example if available, else definition as hint
    let sentence = correct.example || '';
    let displaySentence = '';
    if (sentence) {
      // Replace the word (case-insensitive) with a blank
      const regex = new RegExp('\\b' + correct.word + '\\w*\\b', 'gi');
      const hasMatch = regex.test(sentence);
      if (hasMatch) {
        displaySentence = sentence.replace(new RegExp('\\b' + correct.word + '\\w*\\b', 'gi'), '<span class="blank-word">_____</span>');
      } else {
        displaySentence = sentence + '<br><small style="color:var(--text2);font-size:13px">Äiá»n tá»« phÃ¹ há»£p</small>';
      }
    } else {
      // No example: show definition as the clue
      displaySentence = `<span style="font-size:15px;color:var(--text2)">Tá»« cÃ³ nghÄ©a lÃ :</span><br>"${correct.definition || correct.vietnamese || '?'}"`;
    }

    document.getElementById('quiz-sentence').innerHTML = displaySentence;
    document.getElementById('quiz-sentence').style.display = 'block';
    document.getElementById('speak-quiz-btn').style.display = 'none';

    document.getElementById('quiz-options').innerHTML = options.map(o => {
      return `<button class="quiz-option" data-id="${o.id}" onclick="checkAnswer(this, '${o.id}', '${correct.id}')" style="text-align:center; font-family:'Playfair Display',serif; font-size:16px; font-weight:700; color:var(--text);">${o.word}</button>`;
    }).join('');
  }
}

function checkAnswer(btn, selectedId, correctId) {
  const opts = document.querySelectorAll('.quiz-option');
  opts.forEach(b => b.classList.add('disabled'));
  quizTotal++;

  if (selectedId == correctId) {
    btn.classList.add('correct');
    quizCorrect++;
    showToast('âœ… ChÃ­nh xÃ¡c!');
    // In word-choice mode, speak the word now that it's been answered correctly
    if (quizType !== 'meaning') {
      setTimeout(() => speakWord(currentWord), 300);
    }
  } else {
    btn.classList.add('wrong');
    quizWrong++;
    // Highlight the correct answer
    opts.forEach(b => {
      if (b.dataset.id == correctId) b.classList.add('reveal');
    });
    showToast('âŒ Sai rá»“i!');
  }
  updateQuizStats();
  document.getElementById('quiz-next-btn').classList.add('visible');
}

function updateQuizStats() {
  document.getElementById('q-correct').textContent = quizCorrect;
  document.getElementById('q-wrong').textContent = quizWrong;
  document.getElementById('q-total-done').textContent = quizTotal;
  document.getElementById('q-accuracy').textContent = quizTotal ? Math.round(quizCorrect / quizTotal * 100) + '%' : 'â€”';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(tab) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('screen-' + tab).classList.add('active');
  const tabs = { upload: 0, topics: 1, study: 2, quiz: 3, progress: 4 };
  const idx = tabs[tab];
  if (idx !== undefined) document.querySelectorAll('.tab-btn')[idx].classList.add('active');

  if (tab === 'topics') { renderTopicGrid(); }
  if (tab === 'study')  { initStudy(); }
  if (tab === 'quiz')   { initQuiz(); }
  if (tab === 'progress') { renderProgress(); }
}

function clearTopicFilter() {
  activeTopicFilter = null;
  initStudy();
}

function clearAllData() {
  if (!confirm('XÃ³a toÃ n bá»™ dá»¯ liá»‡u tá»« vá»±ng vÃ  tiáº¿n Ä‘á»™?')) return;
  DB = { words: [], studyLog: [] };
  saveData(DB);
  renderAll();
  showToast('ğŸ—‘ ÄÃ£ xÃ³a táº¥t cáº£');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUDIO ENGINE  (Google TTS primary â†’ Web Speech fallback)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentAccent = 'us';   // 'us' | 'uk'
let currentWord   = '';
let speakTimer    = null;
let activeAudio   = null;

// Google TTS supported voices (Wavenet = most natural)
const TTS_VOICES = {
  us: [
    { name: 'en-US-Wavenet-D', gender: 'MALE' },
    { name: 'en-US-Wavenet-F', gender: 'FEMALE' },
    { name: 'en-US-Neural2-D', gender: 'MALE' },
  ],
  uk: [
    { name: 'en-GB-Wavenet-B', gender: 'MALE' },
    { name: 'en-GB-Wavenet-A', gender: 'FEMALE' },
    { name: 'en-GB-Neural2-B', gender: 'MALE' },
  ]
};

let selectedVoiceIdx = { us: 0, uk: 0 };

function setAccent(acc) {
  currentAccent = acc;
  document.querySelectorAll('.accent-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('acc-' + acc).classList.add('active');
  showToast(`ğŸ”Š Giá»ng ${acc === 'us' ? 'ğŸ‡ºğŸ‡¸ Má»¹' : 'ğŸ‡¬ğŸ‡§ Anh'}`);
  if (currentWord) speakWord(currentWord);
}

function setSpeakBtnState(on) {
  document.querySelectorAll('.speak-btn').forEach(b => {
    on ? b.classList.add('speaking') : b.classList.remove('speaking');
  });
}

// â”€â”€ Google Cloud TTS (free tier, no key needed via proxy trick) â”€â”€
function googleTTSUrl(word) {
  // Use Google Translate TTS endpoint â€” natural voices, free, no API key
  const lang = currentAccent === 'us' ? 'en-US' : 'en-GB';
  return `https://translate.google.com/translate_tts?ie=UTF-8&tl=${lang}&q=${encodeURIComponent(word)}&client=tw-ob&ttsspeed=0.8`;
}

// â”€â”€ Fallback: ResponsiveVoice-style via VoiceRSS free tier â”€â”€
function voiceRSSUrl(word) {
  const hl = currentAccent === 'us' ? 'en-us' : 'en-gb';
  return `https://api.voicerss.org/?key=&hl=${hl}&src=${encodeURIComponent(word)}&r=-1&c=mp3&f=16khz_16bit_stereo`;
}

// â”€â”€ Fallback: Web Speech API â”€â”€
function webSpeechFallback(word) {
  if (!window.speechSynthesis) {
    setSpeakBtnState(false);
    showToast('âš ï¸ KhÃ´ng thá»ƒ phÃ¡t Ã¢m');
    return;
  }
  window.speechSynthesis.cancel();
  const utter = new SpeechSynthesisUtterance(word);
  utter.lang  = currentAccent === 'us' ? 'en-US' : 'en-GB';
  utter.rate  = 0.78;
  utter.pitch = 1.0;
  const voices = window.speechSynthesis.getVoices();
  const langCode = utter.lang;
  const best = voices.find(v => v.lang === langCode && !v.localService)
    || voices.find(v => v.lang === langCode)
    || voices.find(v => v.lang.startsWith('en'));
  if (best) utter.voice = best;
  setSpeakBtnState(true);
  utter.onend  = () => setSpeakBtnState(false);
  utter.onerror = () => setSpeakBtnState(false);
  window.speechSynthesis.speak(utter);
}

// â”€â”€ Main speak function â”€â”€
function speakWord(word) {
  if (!word || word === 'â€”') return;
  word = word.trim().toLowerCase();

  // Stop any currently playing audio
  if (activeAudio) { activeAudio.pause(); activeAudio = null; }
  if (window.speechSynthesis) window.speechSynthesis.cancel();
  setSpeakBtnState(true);

  const url = googleTTSUrl(word);
  const audio = new Audio(url);
  activeAudio = audio;

  audio.onended = () => { setSpeakBtnState(false); activeAudio = null; };
  audio.onerror = () => {
    activeAudio = null;
    // Fallback to Web Speech
    webSpeechFallback(word);
  };
  audio.play().catch(() => {
    activeAudio = null;
    webSpeechFallback(word);
  });
}

function speakCurrentWord() { speakWord(currentWord); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
renderAll();
</script>
</body>
</html>
