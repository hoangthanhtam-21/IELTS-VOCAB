<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>IELTS Vocab Master</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;700;900&display=swap" rel="stylesheet">
<style>
:root{--bg:#0d0d0f;--surface:#16161a;--surface2:#1e1e24;--border:#2a2a35;--accent:#e8c547;--accent2:#7c6ee0;--accent3:#4ecdc4;--text:#f0eff4;--text2:#9d9daf;--danger:#ff6b6b;--success:#6bcb77;--radius:16px;}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");pointer-events:none;z-index:0;}
#app{position:relative;z-index:1;max-width:900px;margin:0 auto;padding:24px 20px 80px;}

/* â”€â”€ UTILITIES â”€â”€ */
input,textarea,select{background:var(--surface2);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;padding:10px 14px;width:100%;outline:none;transition:border .2s;}
input:focus,textarea:focus,select:focus{border-color:var(--accent2);}
label{font-size:12px;color:var(--text2);display:block;margin-bottom:6px;}
.btn{padding:10px 20px;border:none;border-radius:10px;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;transition:all .15s;display:inline-flex;align-items:center;gap:6px;justify-content:center;}
.btn-p{background:var(--accent);color:#0d0d0f;}.btn-p:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(232,197,71,.3);}
.btn-s{background:transparent;color:var(--text2);border:1px solid var(--border);}.btn-s:hover{border-color:var(--text2);color:var(--text);}
.btn-d{background:#2a1010;color:var(--danger);border:1px solid var(--danger);}.btn-d:hover{background:#3a1010;}
.btn-sm{padding:6px 12px;font-size:12px;border-radius:8px;}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:24px;}
.section-title{font-family:'DM Sans',sans-serif;font-size:22px;font-weight:700;}
.screen{display:none;animation:fadeIn .25s ease;}.screen.active{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:none;}}
.toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(16px);background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:11px 22px;font-size:14px;opacity:0;pointer-events:none;transition:all .3s;z-index:9999;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
.spinner{display:inline-block;width:18px;height:18px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle;}
@keyframes spin{to{transform:rotate(360deg);}}

/* â”€â”€ LOADING â”€â”€ */
#overlay{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9998;gap:14px;}
#overlay.hidden{display:none;}
.ov-logo{font-family:'DM Sans',sans-serif;font-size:30px;font-weight:900;color:var(--accent);}
.ov-msg{font-size:13px;color:var(--text2);}

/* â”€â”€ SETUP â”€â”€ */
.setup-wrap{max-width:460px;margin:60px auto;}
.setup-wrap h2{font-family:'DM Sans',sans-serif;font-size:22px;margin-bottom:10px;}
.setup-wrap p{color:var(--text2);font-size:14px;line-height:1.7;margin-bottom:22px;}
.setup-field{margin-bottom:14px;}
.api-note{font-size:12px;color:var(--text2);margin-top:18px;line-height:1.7;padding:14px;background:var(--surface2);border-radius:10px;}
.api-note a{color:var(--accent3);text-decoration:none;}.api-note a:hover{text-decoration:underline;}

/* â”€â”€ HEADER â”€â”€ */
header{display:flex;align-items:center;justify-content:space-between;padding-bottom:26px;border-bottom:1px solid var(--border);margin-bottom:30px;flex-wrap:wrap;gap:10px;}
.logo-text{font-family:'DM Sans',sans-serif;font-size:26px;font-weight:900;color:var(--accent);letter-spacing:-1px;}
.logo-sub{font-size:11px;color:var(--text2);letter-spacing:3px;text-transform:uppercase;margin-left:8px;}
.hstats{display:flex;gap:18px;}
.hstat-num{font-family:'DM Sans',sans-serif;font-size:20px;font-weight:700;color:var(--accent);}
.hstat-lbl{font-size:10px;color:var(--text2);letter-spacing:2px;text-transform:uppercase;}
.admin-gear{font-size:18px;cursor:pointer;opacity:.35;transition:opacity .2s;border:none;background:none;color:var(--text);padding:4px;}
.admin-gear:hover{opacity:.8;}

/* â”€â”€ NAV â”€â”€ */
.nav-tabs{display:flex;gap:5px;background:var(--surface);border-radius:13px;padding:5px;margin-bottom:28px;}
.tab-btn{flex:1;padding:10px 6px;border:none;border-radius:9px;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;background:transparent;color:var(--text2);transition:all .2s;}
.tab-btn.active{background:var(--accent);color:#0d0d0f;font-weight:600;}
.tab-btn:hover:not(.active){color:var(--text);background:var(--surface2);}

/* â”€â”€ TOPIC GRID â”€â”€ */
.topic-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:14px;margin-bottom:20px;}
.topic-card{background:var(--surface);border-radius:var(--radius);padding:20px;border:1px solid var(--border);cursor:pointer;transition:all .2s;}
.topic-card:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.35);}
.t-emoji{font-size:28px;margin-bottom:10px;}
.t-name{font-family:'DM Sans',sans-serif;font-size:17px;font-weight:700;margin-bottom:4px;}
.t-meta{font-size:12px;color:var(--text2);}
.t-bar{height:3px;background:var(--border);border-radius:2px;margin-top:10px;overflow:hidden;}
.t-bar-fill{height:100%;border-radius:2px;transition:width .4s;}
.t-pct{font-size:11px;color:var(--success);margin-top:5px;}
.detail-hdr{display:flex;align-items:center;gap:10px;margin-bottom:18px;padding-bottom:14px;border-bottom:1px solid var(--border);flex-wrap:wrap;}
.back-btn{background:var(--surface2);border:1px solid var(--border);border-radius:9px;padding:7px 13px;cursor:pointer;font-size:13px;color:var(--text2);font-family:'DM Sans',sans-serif;transition:all .15s;}
.back-btn:hover{color:var(--text);border-color:var(--text2);}
.detail-title{font-family:'DM Sans',sans-serif;font-size:19px;font-weight:700;}
.detail-badge{background:var(--accent);color:#0d0d0f;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700;margin-left:auto;}
.chip-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(185px,1fr));gap:9px;margin-bottom:22px;}
.chip{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:10px 13px;cursor:pointer;transition:all .15s;}
.chip:hover{border-color:var(--accent2);}
.chip.done{border-color:var(--success);opacity:.6;}
.chip-word{font-weight:600;font-size:14px;display:flex;align-items:center;gap:6px;}
.chip-vn{font-size:12px;color:var(--text2);margin-top:2px;}
.dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.s-new{background:#7eb8f7;}.s-learning{background:var(--accent2);}.s-review{background:var(--accent);}.s-mastered{background:var(--success);}
.topic-actions{display:flex;gap:10px;flex-wrap:wrap;}

/* â”€â”€ STUDY â”€â”€ */
.study-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;}
.prg-wrap{flex:1;height:6px;background:var(--surface2);border-radius:3px;margin:0 14px;overflow:hidden;}
.prg-fill{height:100%;background:linear-gradient(90deg,var(--accent2),var(--accent));border-radius:3px;transition:width .4s;}
.study-cnt{font-size:13px;color:var(--text2);white-space:nowrap;}
.acc-row{display:flex;gap:6px;align-items:center;justify-content:center;margin-bottom:12px;}
.acc-btn{padding:5px 13px;border-radius:20px;border:1px solid var(--border);background:transparent;color:var(--text2);cursor:pointer;font-size:12px;font-family:'DM Sans',sans-serif;transition:all .15s;}
.acc-btn.active{background:var(--accent2);border-color:var(--accent2);color:#fff;}
.acc-lbl{font-size:11px;color:var(--text2);letter-spacing:1px;}
.card-wrap{perspective:1000px;margin:0 auto 22px;max-width:530px;}
.flashcard{position:relative;width:100%;padding-top:54%;transform-style:preserve-3d;transition:transform .5s cubic-bezier(.4,0,.2,1);cursor:pointer;}
.flashcard.flipped{transform:rotateY(180deg);}
.card-face{position:absolute;inset:0;border-radius:20px;padding:26px;display:flex;flex-direction:column;justify-content:center;align-items:center;backface-visibility:hidden;-webkit-backface-visibility:hidden;border:1px solid var(--border);}
.cf{background:linear-gradient(135deg,#1a1a22,#16161e);}
.cb{background:linear-gradient(135deg,#1a1e2a,#161822);transform:rotateY(180deg);}
.c-tag{font-size:11px;letter-spacing:2px;text-transform:uppercase;color:var(--text2);margin-bottom:12px;}
.c-word{font-family:'DM Sans',sans-serif;font-size:40px;font-weight:900;color:var(--accent);text-align:center;line-height:1.1;}
.c-ph{font-size:15px;color:var(--accent2);margin-top:7px;}
.c-type{font-size:12px;color:var(--text2);margin-top:4px;font-style:italic;}
.c-def{font-size:16px;color:var(--text);text-align:center;line-height:1.6;}
.c-ex{font-size:13px;color:var(--text2);font-style:italic;text-align:center;margin-top:9px;line-height:1.5;padding:0 10px;}
.c-vn{font-size:14px;color:var(--accent3);margin-top:8px;font-weight:500;}
.c-hint{font-size:11px;color:var(--border);margin-top:8px;}
.speak-btn{display:inline-flex;align-items:center;gap:6px;padding:6px 13px;border-radius:20px;border:1px solid var(--border);background:var(--surface2);color:var(--text2);cursor:pointer;font-size:12px;font-family:'DM Sans',sans-serif;transition:all .2s;margin-top:9px;}
.speak-btn:hover,.speak-btn.speaking{border-color:var(--accent3);color:var(--accent3);}
.speak-btn.speaking{animation:pls .8s ease infinite;}
@keyframes pls{0%,100%{box-shadow:0 0 0 0 rgba(78,205,196,.3);}50%{box-shadow:0 0 0 6px rgba(78,205,196,0);}}
.wave{display:flex;gap:2px;align-items:center;height:13px;}
.wave span{display:block;width:3px;background:currentColor;border-radius:2px;height:5px;}
.speaking .wave span:nth-child(1){animation:bar .6s 0s ease infinite;}
.speaking .wave span:nth-child(2){animation:bar .6s .15s ease infinite;}
.speaking .wave span:nth-child(3){animation:bar .6s .3s ease infinite;}
@keyframes bar{0%,100%{height:4px;}50%{height:12px;}}
.rating-area{display:none;}.rating-area.show{display:block;}
.r-lbl{font-size:12px;color:var(--text2);text-align:center;margin-bottom:11px;letter-spacing:1px;text-transform:uppercase;}
.r-btns{display:flex;gap:9px;justify-content:center;flex-wrap:wrap;}
.r-btn{flex:1;min-width:82px;max-width:135px;padding:12px 7px;border:2px solid transparent;border-radius:12px;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;transition:all .15s;text-align:center;}
.r-em{font-size:17px;display:block;margin-bottom:3px;}
.r-nx{display:block;font-size:10px;font-weight:400;margin-top:2px;opacity:.8;}
.r-again{background:#2a1010;border-color:var(--danger);color:var(--danger);}
.r-hard{background:#2a2010;border-color:#f0a500;color:#f0a500;}
.r-good{background:#10202a;border-color:var(--accent2);color:var(--accent2);}
.r-easy{background:#102a10;border-color:var(--success);color:var(--success);}
.done-box{text-align:center;padding:54px 20px;}
.done-box .big{font-size:50px;margin-bottom:13px;}
.done-box h3{font-family:'DM Sans',sans-serif;font-size:22px;margin-bottom:8px;color:var(--success);}
.done-box p{color:var(--text2);font-size:14px;line-height:1.7;}

/* â”€â”€ QUIZ â”€â”€ */
.quiz-stats{display:flex;gap:12px;margin-bottom:22px;}
.q-stat{flex:1;background:var(--surface);border-radius:12px;padding:13px;text-align:center;border:1px solid var(--border);}
.q-stat-num{font-family:'DM Sans',sans-serif;font-size:24px;font-weight:700;}
.q-stat-lbl{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:1.5px;}
.qtype-tabs{display:flex;gap:7px;margin-bottom:16px;}
.qtype-btn{flex:1;padding:9px 8px;border-radius:9px;border:1px solid var(--border);background:var(--surface);color:var(--text2);cursor:pointer;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:500;transition:all .15s;}
.qtype-btn.active{background:var(--accent2);border-color:var(--accent2);color:#fff;font-weight:600;}
.quiz-q-card{background:var(--surface);border-radius:var(--radius);padding:26px;border:1px solid var(--border);margin-bottom:16px;text-align:center;}
.q-type-lbl{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:2px;margin-bottom:12px;}
.q-word{font-family:'DM Sans',sans-serif;font-size:33px;font-weight:700;color:var(--accent);margin-bottom:6px;}
.q-ph{font-size:14px;color:var(--accent2);}
.blank-sent{font-size:17px;color:var(--text);line-height:1.8;text-align:center;padding:0 8px;margin-top:6px;}
.blank{display:inline-block;min-width:88px;border-bottom:2px solid var(--accent);color:var(--accent);font-weight:700;font-family:'DM Sans',sans-serif;font-size:19px;text-align:center;padding:0 5px;}
.quiz-opts{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:16px;}
.q-opt{padding:13px 16px;background:var(--surface);border:2px solid var(--border);border-radius:12px;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:14px;line-height:1.4;transition:all .15s;text-align:left;color:var(--text);}
.q-opt:hover:not(.disabled){border-color:var(--accent2);background:var(--surface2);}
.q-opt.correct{border-color:var(--success)!important;background:#102a10!important;color:var(--success)!important;font-weight:600;}
.q-opt.wrong{border-color:var(--danger)!important;background:#2a1010!important;color:var(--danger)!important;}
.q-opt.reveal{border-color:var(--success)!important;background:#0d2010!important;color:var(--success)!important;font-weight:600;animation:pc .4s ease;}
@keyframes pc{0%,100%{transform:scale(1);}50%{transform:scale(1.02);}}
.q-opt.disabled{cursor:default;opacity:.75;}
.quiz-next-btn{width:100%;padding:13px;background:var(--accent);color:#0d0d0f;border:none;border-radius:12px;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:15px;font-weight:600;display:none;}
.quiz-next-btn.show{display:block;}

/* â”€â”€ PROGRESS â”€â”€ */
.prog-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:13px;margin-bottom:26px;}
.prog-card{background:var(--surface);border-radius:var(--radius);padding:20px;border:1px solid var(--border);}
.prog-num{font-family:'DM Sans',sans-serif;font-size:36px;font-weight:900;line-height:1;}
.prog-lbl{font-size:12px;color:var(--text2);text-transform:uppercase;letter-spacing:1.5px;margin-top:5px;}
.pc1 .prog-num{color:#7eb8f7;}.pc2 .prog-num{color:var(--accent2);}.pc3 .prog-num{color:var(--accent);}.pc4 .prog-num{color:var(--success);}
.donut-wrap{display:flex;justify-content:center;margin:18px 0;}
svg.donut{transform:rotate(-90deg);}
.donut-ring{fill:none;stroke-width:18;}
.streak-box{background:var(--surface);border-radius:var(--radius);padding:20px;border:1px solid var(--border);}
.streak-lbl{font-size:13px;font-weight:600;margin-bottom:13px;color:var(--text2);text-transform:uppercase;letter-spacing:1px;}
.streak-days{display:flex;gap:5px;flex-wrap:wrap;}
.day{width:29px;height:29px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:10px;color:var(--text2);border:1px solid var(--border);}
.day.ok{background:var(--accent);color:#0d0d0f;border-color:var(--accent);font-weight:700;}

/* â”€â”€ ADMIN PANEL â”€â”€ */
.admin-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:10px;}
.admin-title{font-family:'DM Sans',sans-serif;font-size:20px;font-weight:700;color:var(--accent);}
.a-tabs{display:flex;gap:5px;background:var(--surface);border-radius:11px;padding:5px;margin-bottom:22px;}
.a-tab{flex:1;padding:9px 10px;border:none;border-radius:8px;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:13px;background:transparent;color:var(--text2);transition:all .2s;}
.a-tab.active{background:var(--accent2);color:#fff;font-weight:600;}
.a-screen{display:none;}.a-screen.active{display:block;}
.t-row{display:flex;align-items:center;gap:10px;background:var(--surface);border-radius:12px;padding:13px 15px;border:1px solid var(--border);margin-bottom:9px;}
.t-row-info{flex:1;}
.t-row-name{font-weight:600;font-size:14px;}
.t-row-count{font-size:12px;color:var(--text2);margin-top:2px;}
.form-2{display:grid;grid-template-columns:1fr 1fr;gap:11px;}
.form-3{display:grid;grid-template-columns:56px 1fr 90px;gap:11px;}
.w-table-wrap{overflow-x:auto;margin-top:14px;}
.w-table{width:100%;border-collapse:collapse;min-width:600px;}
.w-table th{font-size:11px;letter-spacing:1.5px;text-transform:uppercase;color:var(--text2);padding:10px 11px;text-align:left;border-bottom:1px solid var(--border);}
.w-table td{padding:12px 11px;font-size:13px;border-bottom:1px solid var(--border);color:var(--text);}
.w-table tr:hover td{background:var(--surface2);}

/* â”€â”€ SPELLING â”€â”€ */
#spelling-screen{display:none;}
.spell-tag{font-size:11px;letter-spacing:2px;text-transform:uppercase;color:var(--text2);margin-bottom:10px;text-align:center;}
.spell-listen{background:linear-gradient(135deg,#1a1a22,#16161e);border:1px solid var(--border);border-radius:20px;padding:32px 20px;text-align:center;margin-bottom:20px;}
.spell-listen-icon{font-size:52px;margin-bottom:10px;}
.spell-listen-lbl{font-size:14px;color:var(--text2);margin-bottom:16px;}
.spell-opts{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;}
.spell-opt{padding:14px 12px;background:var(--surface);border:2px solid var(--border);border-radius:12px;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:17px;font-weight:700;text-align:center;color:var(--text);transition:all .15s;}
.spell-opt.correct{border-color:var(--success)!important;background:#102a10!important;color:var(--success)!important;}
.spell-opt.wrong{border-color:var(--danger)!important;background:#2a1010!important;color:var(--danger)!important;animation:shake .3s ease;}
@keyframes shake{0%,100%{transform:translateX(0);}25%{transform:translateX(-6px);}75%{transform:translateX(6px);}}

@media(max-width:600px){
  .c-word{font-size:28px;}.quiz-opts{grid-template-columns:1fr;}
  .prog-grid{grid-template-columns:1fr 1fr;}.form-2,.form-3{grid-template-columns:1fr;}
  header{flex-direction:column;align-items:flex-start;}
  .spell-opts{grid-template-columns:1fr;}
}
</style>
</head>
<body>

<!-- Loading overlay -->
<div id="overlay">
  <div class="ov-logo">IELTS Vocab</div>
  <div class="spinner"></div>
  <div class="ov-msg" id="ov-msg">Äang khá»Ÿi Ä‘á»™ng...</div>
</div>

<div id="app" style="display:none">

<!-- SETUP -->
<div id="screen-setup" class="screen">
  <div class="setup-wrap">
    <div class="card">
      <div style="font-size:38px;margin-bottom:12px;text-align:center">âš™ï¸</div>
      <h2 style="text-align:center">CÃ i Ä‘áº·t láº§n Ä‘áº§u</h2>
      <p style="text-align:center">Káº¿t ná»‘i vá»›i JSONBin Ä‘á»ƒ lÆ°u tá»« vá»±ng trÃªn cloud.</p>
      <div class="setup-field"><label>JSONBin Secret Key</label><input id="s-key" type="text" placeholder="$2b$10$..."></div>
      <div class="setup-field"><label>Anthropic API Key (tuá»³ chá»n)</label><input id="s-claude" type="text" placeholder="sk-ant-..."></div>
      <div class="setup-field"><label>Máº­t kháº©u Admin</label><input id="s-pwd" type="password" placeholder="Máº­t kháº©u báº£o máº­t"></div>
      <button class="btn btn-p" style="width:100%;justify-content:center" onclick="doSetup()">
        <span id="setup-btn-txt">HoÃ n táº¥t cÃ i Ä‘áº·t â†’</span>
      </button>
      <div id="setup-err" style="color:var(--danger);font-size:13px;margin-top:10px;display:none;text-align:center"></div>
    </div>
  </div>
</div>

<!-- STUDENT APP -->
<div id="student-app" style="display:none">
  <header>
    <div>
      <span class="logo-text">IELTS Vocab</span>
      <span class="logo-sub">Master</span>
    </div>
    <div class="hstats">
      <div class="hstat" style="text-align:center"><div class="hstat-num" id="h-total">0</div><div class="hstat-lbl">Tá»«</div></div>
      <div class="hstat" style="text-align:center"><div class="hstat-num" id="h-due">0</div><div class="hstat-lbl">HÃ´m nay</div></div>
      <div class="hstat" style="text-align:center"><div class="hstat-num" id="h-mastered">0</div><div class="hstat-lbl">Thuá»™c</div></div>
    </div>
    <button class="admin-gear" onclick="showLoginScreen()" title="Admin">âš™</button>
  </header>

  <div class="nav-tabs">
    <button class="tab-btn active" onclick="switchTab('topics')">ğŸ—‚ Chá»§ Ä‘á»</button>
    <button class="tab-btn" onclick="switchTab('study')">ğŸ§  Há»c</button>
    <button class="tab-btn" onclick="switchTab('quiz')">âš¡ Quiz</button>
    <button class="tab-btn" onclick="switchTab('progress')">ğŸ“Š Tiáº¿n Ä‘á»™</button>
  </div>

  <div id="screen-topics" class="screen active">
    <div id="topic-list-view">
      <div style="margin-bottom:18px"><span class="section-title">ğŸ—‚ Chá»§ Ä‘á» tá»« vá»±ng</span></div>
      <div class="topic-grid" id="topic-grid"></div>
    </div>
    <div id="topic-detail-view" style="display:none">
      <div class="detail-hdr">
        <button class="back-btn" onclick="backToList()">â† Quay láº¡i</button>
        <span class="detail-title" id="det-title"></span>
        <span class="detail-badge" id="det-badge"></span>
      </div>
      <div class="chip-grid" id="chip-grid"></div>
      <div class="topic-actions">
        <button class="btn btn-p" onclick="studyThis()">ğŸ§  Há»c chá»§ Ä‘á» nÃ y</button>
        <button class="btn btn-s" onclick="quizThis()">âš¡ Quiz chá»§ Ä‘á» nÃ y</button>
      </div>
    </div>
  </div>

  <div id="screen-study" class="screen">
    <div id="study-main">
      <div class="study-hdr">
        <span id="study-lbl" style="font-size:13px;color:var(--text2)">Spaced Repetition</span>
        <div class="prg-wrap"><div class="prg-fill" id="study-bar" style="width:0%"></div></div>
        <span class="study-cnt" id="study-cnt">0/0</span>
      </div>
      <div class="acc-row">
        <span class="acc-lbl">Giá»ng:</span>
        <button class="acc-btn active" id="acc-us" onclick="setAccent('us')">ğŸ‡ºğŸ‡¸ US</button>
        <button class="acc-btn" id="acc-uk" onclick="setAccent('uk')">ğŸ‡¬ğŸ‡§ UK</button>
      </div>

      <div id="spelling-screen">
        <div class="spell-tag">BÆ¯á»šC 1 / 2 â€” NGHE VÃ€ CHá»ŒN CHÃNH Táº¢</div>
        <div class="spell-listen">
          <div class="spell-listen-icon">ğŸ§</div>
          <div class="spell-listen-lbl">Nghe vÃ  chá»n tá»« Ä‘Ãºng chÃ­nh táº£</div>
          <button class="speak-btn" onclick="speakCurrent()" style="margin:0 auto"><span class="wave"><span></span><span></span><span></span></span> Nghe láº¡i</button>
          <div class="spell-listen-ph" id="spell-ph" style="color:var(--accent2);margin-top:10px"></div>
        </div>
        <div class="spell-opts" id="spell-opts"></div>
        <div id="spell-feedback" style="display:none;text-align:center;padding:10px;font-size:14px;color:var(--success)"></div>
      </div>

      <div class="card-wrap" id="card-wrap-main">
        <div class="flashcard" id="flashcard" onclick="flipCard()">
          <div class="card-face cf">
            <div class="c-tag">Tá»ª Vá»°NG IELTS</div>
            <div class="c-word" id="cf-word">â€”</div>
            <div class="c-ph" id="cf-ph"></div>
            <div class="c-type" id="cf-type"></div>
            <button class="speak-btn" onclick="event.stopPropagation();speakCurrent()"><span class="wave"><span></span><span></span><span></span></span> PhÃ¡t Ã¢m</button>
            <div class="c-hint">Cháº¡m Ä‘á»ƒ láº­t card</div>
          </div>
          <div class="card-face cb">
            <div class="c-tag">Äá»ŠNH NGHÄ¨A</div>
            <div class="c-def" id="cb-def"></div>
            <div class="c-vn" id="cb-vn"></div>
            <div class="c-ex" id="cb-ex"></div>
            <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;justify-content:center">
              <button class="speak-btn" onclick="event.stopPropagation();speakCurrent()"><span class="wave"><span></span><span></span><span></span></span> Nghe láº¡i</button>
              <button class="speak-btn" id="ai-explain-btn" onclick="event.stopPropagation();aiExplain()" style="border-color:var(--accent2);color:var(--accent2)">ğŸ¤– AI giáº£i thÃ­ch</button>
            </div>
            <div id="ai-explain-box" style="display:none;margin-top:12px;font-size:13px;color:var(--text2);line-height:1.6;text-align:left;background:var(--surface2);border-radius:10px;padding:12px 14px;max-width:100%"></div>
          </div>
        </div>
      </div>
      <div class="rating-area" id="rating-area">
        <div class="r-lbl">Báº¡n nhá»› tá»« nÃ y á»Ÿ má»©c nÃ o?</div>
        <div class="r-btns">
          <button class="r-btn r-again" onclick="rate(0)"><span class="r-em">ğŸ˜°</span>QuÃªn rá»“i<span class="r-nx" id="nx0"></span></button>
          <button class="r-btn r-hard"  onclick="rate(1)"><span class="r-em">ğŸ˜…</span>KhÃ³<span class="r-nx" id="nx1"></span></button>
          <button class="r-btn r-good"  onclick="rate(2)"><span class="r-em">ğŸ˜Š</span>Nhá»›<span class="r-nx" id="nx2"></span></button>
          <button class="r-btn r-easy"  onclick="rate(3)"><span class="r-em">ğŸ‰</span>Dá»…<span class="r-nx" id="nx3"></span></button>
        </div>
      </div>
    </div>
    <div class="done-box" id="study-done" style="display:none">
      <div class="big">ğŸ‰</div>
      <h3>HoÃ n thÃ nh!</h3>
      <p>Báº¡n Ä‘Ã£ Ã´n xong hÃ´m nay.<br>Quay láº¡i ngÃ y mai nhÃ©!</p><br>
      <button class="btn btn-p" onclick="switchTab('progress')">Xem tiáº¿n Ä‘á»™ â†’</button>
    </div>
  </div>

  <div id="screen-quiz" class="screen">
    <div class="quiz-stats">
      <div class="q-stat"><div class="q-stat-num" id="qc" style="color:var(--success)">0</div><div class="q-stat-lbl">ÄÃºng</div></div>
      <div class="q-stat"><div class="q-stat-num" id="qw" style="color:var(--danger)">0</div><div class="q-stat-lbl">Sai</div></div>
      <div class="q-stat"><div class="q-stat-num" id="qt" style="color:var(--accent)">0</div><div class="q-stat-lbl">Tá»•ng</div></div>
    </div>
    <div id="quiz-main">
      <div class="qtype-tabs">
        <button class="qtype-btn active" id="qt-meaning" onclick="setQType('meaning')">ğŸ“– NghÄ©a</button>
        <button class="qtype-btn" id="qt-word" onclick="setQType('word')">âœï¸ Tá»«</button>
        <button class="qtype-btn" id="qt-random" onclick="setQType('random')">ğŸ² Ngáº«u nhiÃªn</button>
      </div>
      <div class="quiz-q-card">
        <div class="q-type-lbl" id="q-lbl">Chá»n nghÄ©a Ä‘Ãºng</div>
        <div class="q-word" id="q-word">â€”</div>
        <div class="q-ph" id="q-ph"></div>
        <div class="blank-sent" id="q-sent" style="display:none"></div>
      </div>
      <div class="quiz-opts" id="quiz-opts"></div>
      <button class="quiz-next-btn" id="quiz-next" onclick="nextQ()">CÃ¢u tiáº¿p theo â†’</button>
    </div>
    <div id="quiz-empty" style="display:none;text-align:center;padding:56px 20px;color:var(--text2)">
      <div style="font-size:42px;margin-bottom:12px">ğŸ“š</div>
      <p>Chá»n má»™t chá»§ Ä‘á» Ä‘á»ƒ báº¯t Ä‘áº§u quiz!</p>
    </div>
  </div>

  <div id="screen-progress" class="screen">
    <div class="prog-grid">
      <div class="prog-card pc1"><div class="prog-num" id="p-new">0</div><div class="prog-lbl">ğŸ†• Má»›i</div></div>
      <div class="prog-card pc2"><div class="prog-num" id="p-learn">0</div><div class="prog-lbl">ğŸ“– Äang há»c</div></div>
      <div class="prog-card pc3"><div class="prog-num" id="p-rev">0</div><div class="prog-lbl">ğŸ”„ Cáº§n Ã´n</div></div>
      <div class="prog-card pc4"><div class="prog-num" id="p-master">0</div><div class="prog-lbl">âœ… Thuá»™c</div></div>
    </div>
    <div style="text-align:center;margin:18px 0;">
      <div class="donut-wrap">
        <svg class="donut" width="148" height="148" viewBox="0 0 160 160">
          <circle class="donut-ring" cx="80" cy="80" r="62" stroke="#1e1e24"/>
          <circle class="donut-ring" id="donut" cx="80" cy="80" r="62" stroke="#6bcb77" stroke-dasharray="0 390" stroke-linecap="round"/>
        </svg>
      </div>
      <div style="font-family:'DM Sans',sans-serif;font-size:28px;color:var(--success);font-weight:900" id="pct">0%</div>
    </div>
    <div class="streak-box">
      <div class="streak-lbl">ğŸ“… Lá»‹ch sá»­ há»c (30 ngÃ y)</div>
      <div class="streak-days" id="streak"></div>
    </div>
  </div>
</div>

<!-- ADMIN LOGIN -->
<div id="screen-login" class="screen">
  <div class="login-wrap" style="max-width:340px;margin:80px auto;text-align:center;">
    <div class="card">
      <h2>Admin Login</h2>
      <input id="login-pwd" type="password" placeholder="Máº­t kháº©u" style="margin:20px 0;">
      <button class="btn btn-p" style="width:100%" onclick="doLogin()">ÄÄƒng nháº­p</button>
      <div class="login-err" id="login-err" style="color:var(--danger);margin-top:10px;display:none;">Sai máº­t kháº©u!</div>
      <br><button class="btn btn-s btn-sm" onclick="toStudent()">â† Quay láº¡i</button>
    </div>
  </div>
</div>

<!-- ADMIN PANEL -->
<div id="screen-admin" class="screen">
  <div class="admin-hdr">
    <span class="admin-title">âš™ï¸ Admin Panel</span>
    <div style="display:flex;gap:8px">
      <button class="btn btn-s btn-sm" onclick="toStudent()">â† ThoÃ¡t</button>
      <button class="btn btn-d btn-sm" onclick="doLogout()">ÄÄƒng xuáº¥t</button>
    </div>
  </div>
  <div class="a-tabs">
    <button class="a-tab active" onclick="switchATab('topics',this)">ğŸ—‚ Chá»§ Ä‘á»</button>
    <button class="a-tab" onclick="switchATab('words',this)">ğŸ“ Tá»« vá»±ng</button>
    <button class="a-tab" onclick="switchATab('tools',this)">ğŸ›  CÃ´ng cá»¥</button>
  </div>

  <div id="a-topics" class="a-screen active">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
      <span style="font-weight:600">Danh sÃ¡ch chá»§ Ä‘á»</span>
      <button class="btn btn-p btn-sm" onclick="openTopicForm()">ï¼‹ ThÃªm chá»§ Ä‘á»</button>
    </div>
    <div id="a-topic-list"></div>
    <div id="topic-form" class="card" style="display:none;margin-top:14px">
      <div style="font-weight:600;margin-bottom:14px" id="tf-title">ThÃªm chá»§ Ä‘á»</div>
      <div class="form-3" style="margin-bottom:11px">
        <div><label>Icon</label><input id="tf-emoji" type="text" maxlength="2" value="ğŸ“š"></div>
        <div><label>TÃªn</label><input id="tf-name" type="text" placeholder="VD: Environment"></div>
        <div><label>MÃ u</label><input id="tf-color" type="color" value="#7c6ee0"></div>
      </div>
      <div style="display:flex;gap:9px">
        <button class="btn btn-p" onclick="saveTopic()">ğŸ’¾ LÆ°u</button>
        <button class="btn btn-s" onclick="closeTopicForm()">Huá»·</button>
      </div>
    </div>
  </div>

  <div id="a-words" class="a-screen">
    <div style="margin-bottom:13px">
      <label>Chá»n chá»§ Ä‘á»</label>
      <select id="a-topic-sel" onchange="loadWords()"></select>
    </div>
    <div style="margin-bottom:14px;">
      <input type="text" id="word-search" placeholder="ğŸ” TÃ¬m kiáº¿m tá»«..." oninput="filterAdminWords()">
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:11px">
      <span style="font-size:13px;color:var(--text2)" id="word-count-lbl"></span>
      <button class="btn btn-p btn-sm" onclick="openWordForm()">ï¼‹ ThÃªm tá»«</button>
    </div>
    <div id="word-form" class="card" style="display:none;margin-bottom:14px">
      <div class="form-2" style="margin-bottom:10px">
        <div><label>Tá»« *</label><input id="wf-word"></div>
        <div><label>PhiÃªn Ã¢m</label><input id="wf-ph"></div>
      </div>
      <div class="form-2" style="margin-bottom:10px">
        <div><label>Loáº¡i</label><input id="wf-type"></div>
        <div><label>NghÄ©a Viá»‡t</label><input id="wf-vn"></div>
      </div>
      <div style="margin-bottom:10px"><label>Äá»‹nh nghÄ©a Anh</label><input id="wf-def"></div>
      <div style="margin-bottom:13px"><label>VÃ­ dá»¥</label><input id="wf-ex"></div>
      <div style="display:flex;gap:9px">
        <button class="btn btn-p" onclick="saveWord()">ğŸ’¾ LÆ°u</button>
        <button class="btn btn-s" onclick="closeWordForm()">Huá»·</button>
      </div>
    </div>
    <div class="w-table-wrap">
      <table class="w-table">
        <thead><tr><th>Tá»«</th><th>PhiÃªn Ã¢m</th><th>NghÄ©a</th><th></th></tr></thead>
        <tbody id="word-tbody"></tbody>
      </table>
    </div>
  </div>

  <div id="a-tools" class="a-screen">
    <div class="card" style="margin-bottom:16px;">
      <h3>ğŸ“¥ Import CSV</h3>
      <p style="font-size:12px;color:var(--text2);margin:8px 0;">Cáº¥u trÃºc: word, phonetic, type, definition, example, vietnamese</p>
      <select id="imp-topic-sel" style="margin-bottom:10px;"></select>
      <input type="file" id="csv-file" accept=".csv" style="margin-bottom:10px;">
      <button class="btn btn-p" onclick="doImport()" style="width:100%">Import Dá»¯ Liá»‡u</button>
    </div>
    <div class="card">
      <h3>ğŸ’¾ Backup & Restore</h3>
      <p style="font-size:12px;color:var(--text2);margin:8px 0;">Xuáº¥t dá»¯ liá»‡u ra file JSON Ä‘á»ƒ lÆ°u trá»¯ dá»± phÃ²ng.</p>
      <div style="display:flex;gap:10px;">
        <button class="btn btn-s" onclick="exportData()" style="flex:1">Xuáº¥t JSON</button>
        <button class="btn btn-s" onclick="document.getElementById('restore-file').click()" style="flex:1">Nháº­p JSON</button>
        <input type="file" id="restore-file" style="display:none" accept=".json" onchange="importData(this)">
      </div>
    </div>
  </div>
</div>

</div>
<div class="toast" id="toast"></div>

<script>
// STATE
const CFG_KEY = 'ielts_cfg_v1';
const PROG_KEY = 'ielts_prog_v2';
const BIN_URL = 'https://api.jsonbin.io/v3/b';

let CFG = {};
let CLOUD = { topics: [] };
let PROGRESS = { cards:{}, log:[] };
let activeTopicId = null;
let isAdmin = false;
let currentWord = '';
let currentAccent = 'us';
let speakTimer = null;

// STORAGE
function loadCFG(){ try{ CFG = JSON.parse(localStorage.getItem(CFG_KEY))||{}; }catch{ CFG={}; } }
function saveCFG(){ localStorage.setItem(CFG_KEY, JSON.stringify(CFG)); }
function loadProg(){ try{ PROGRESS = JSON.parse(localStorage.getItem(PROG_KEY))||{cards:{},log:[]}; }catch{ PROGRESS={cards:{},log:[]}; } }
function saveProg(){ localStorage.setItem(PROG_KEY, JSON.stringify(PROGRESS)); }
async function sha256(txt){
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(txt));
  return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
}

// JSONBIN
function binHeaders(extra={}){ return { 'Content-Type': 'application/json', 'X-Master-Key': CFG.apiKey, 'X-Access-Key': CFG.apiKey, ...extra }; }
async function binCreate(data){
  const r = await fetch(BIN_URL, { method:'POST', headers: binHeaders({'X-Bin-Name':'ielts-vocab','X-Bin-Private':'false'}), body: JSON.stringify(data) });
  return (await r.json()).metadata.id;
}
async function binRead(){
  const r = await fetch(`${BIN_URL}/${CFG.binId}/latest`, { headers: binHeaders() });
  return (await r.json()).record;
}
async function binWrite(data){
  await fetch(`${BIN_URL}/${CFG.binId}`, { method:'PUT', headers: binHeaders(), body: JSON.stringify(data) });
}

// INIT
async function init(){
  loadCFG(); loadProg();
  const ov = document.getElementById('overlay');
  const app = document.getElementById('app');
  if(!CFG.apiKey){ ov.classList.add('hidden'); app.style.display='block'; showOnly('screen-setup'); return; }
  try {
    CLOUD = await binRead();
    if(!CLOUD.topics) CLOUD = {topics:[]};
  } catch(e){ CLOUD = {topics:[]}; }
  ov.classList.add('hidden'); app.style.display='block';
  document.getElementById('student-app').style.display='block';
  renderStudent();
}

// SETUP
async function doSetup(){
  const key = document.getElementById('s-key').value.trim();
  const pwd = document.getElementById('s-pwd').value.trim();
  if(!key||!pwd) return;
  document.getElementById('setup-btn-txt').textContent = 'Äang xá»­ lÃ½...';
  try {
    CFG.apiKey = key;
    CFG.claudeKey = document.getElementById('s-claude').value.trim();
    CFG.pwdHash = await sha256(pwd);
    CFG.binId = await binCreate({topics:[]});
    saveCFG();
    location.reload();
  } catch(e){ alert('Lá»—i setup: ' + e.message); }
}

// HELPERS
const wKey = (tid,word) => `${tid}||${word}`;
function getCard(tid,word){ return PROGRESS.cards[wKey(tid,word)] || {interval:0,repetition:0,efactor:2.5,dueDate:0,status:'new'}; }
function setCard(tid,word,s){ PROGRESS.cards[wKey(tid,word)]=s; saveProg(); }
function allWords(){ return (CLOUD.topics||[]).flatMap(t=>(t.words||[]).map(w=>({...w, topicId:t.id, ...getCard(t.id,w.word)}))); }
function topicWords(tid){ const t = (CLOUD.topics||[]).find(t=>t.id===tid); return t ? (t.words||[]).map(w=>({...w, topicId:tid, ...getCard(tid,w.word)})) : []; }
function dueWords(){ const now = Date.now(); const pool = activeTopicId ? topicWords(activeTopicId) : allWords(); return pool.filter(w=>w.dueDate<=now); }

// RENDER STUDENT
function renderStudent(){ renderHeader(); renderTopicGrid(); }
function renderHeader(){
  const all = allWords();
  document.getElementById('h-total').textContent = all.length;
  document.getElementById('h-due').textContent = dueWords().length;
  document.getElementById('h-mastered').textContent = all.filter(w=>w.status==='mastered').length;
}
function renderTopicGrid(){
  const el = document.getElementById('topic-grid');
  if(!(CLOUD.topics||[]).length){ el.innerHTML='<p>ChÆ°a cÃ³ dá»¯ liá»‡u.</p>'; return; }
  el.innerHTML = CLOUD.topics.map(t=>{
    const words = topicWords(t.id);
    const mastered = words.filter(w=>w.status==='mastered').length;
    const pct = words.length ? Math.round(mastered/words.length*100) : 0;
    return `<div class="topic-card" onclick="openTopic('${t.id}')" style="border-top:3px solid ${t.color||'#7c6ee0'}">
      <div class="t-emoji">${t.emoji||'ğŸ“š'}</div>
      <div class="t-name">${t.name}</div>
      <div class="t-meta">${words.length} tá»« Â· ${mastered} thuá»™c</div>
      <div class="t-bar"><div class="t-bar-fill" style="width:${pct}%;background:${t.color||'#7c6ee0'}"></div></div>
    </div>`;
  }).join('');
}
function openTopic(tid){
  activeTopicId = tid; const t = CLOUD.topics.find(x=>x.id===tid);
  document.getElementById('det-title').textContent = t.name;
  document.getElementById('det-badge').textContent = (t.words||[]).length + ' tá»«';
  document.getElementById('chip-grid').innerHTML = topicWords(tid).map(w=>`
    <div class="chip ${w.status==='mastered'?'done':''}" onclick="speakWord('${w.word}')">
      <div class="chip-word"><span class="dot s-${w.status}"></span>${w.word}</div>
    </div>`).join('');
  document.getElementById('topic-list-view').style.display='none';
  document.getElementById('topic-detail-view').style.display='block';
}
function backToList(){ document.getElementById('topic-list-view').style.display='block'; document.getElementById('topic-detail-view').style.display='none'; }
function studyThis(){ switchTab('study'); }
function quizThis(){ switchTab('quiz'); }

// STUDY
let queue=[], qIdx=0, flipped=false, spellingStep=false;
function initStudy(){ queue = dueWords().sort(()=>Math.random()-.5); qIdx=0; showCard(); }
function showCard(){
  if(qIdx >= queue.length){
    document.getElementById('study-done').style.display='block';
    document.getElementById('study-main').style.display='none';
    const today = new Date().toISOString().slice(0,10);
    if(!PROGRESS.log.includes(today)) PROGRESS.log.push(today);
    saveProg(); renderProgress(); return;
  }
  document.getElementById('study-done').style.display='none';
  document.getElementById('study-main').style.display='block';
  const w=queue[qIdx]; currentWord = w.word;
  document.getElementById('study-cnt').textContent=`${qIdx+1}/${queue.length}`;
  document.getElementById('study-bar').style.width=`${(qIdx/queue.length)*100}%`;
  if(w.status === 'new') showSpelling(w); else showFlashcard(w);
}

function showSpelling(w){
  spellingStep = true;
  document.getElementById('spelling-screen').style.display='block';
  document.getElementById('card-wrap-main').style.display='none';
  document.getElementById('rating-area').classList.remove('show');
  document.getElementById('spell-ph').textContent = w.phonetic || '';
  const opts = generateSpellingOpts(w.word);
  document.getElementById('spell-opts').innerHTML = opts.map(o=>`<button class="spell-opt" onclick="checkSpell(this,'${o}','${w.word}')">${o}</button>`).join('');
  speakWord(w.word);
}

function generateSpellingOpts(word){
  let distractors = new Set();
  const w = word.toLowerCase();
  while(distractors.size < 3){
    let d = w;
    if(Math.random() > 0.5){ // Swap
      let i = Math.floor(Math.random()*(d.length-1));
      let arr = d.split(''); [arr[i], arr[i+1]] = [arr[i+1], arr[i]];
      d = arr.join('');
    } else { // Vowel change
      const vowels = 'aeiou';
      let i = Math.floor(Math.random()*d.length);
      if(vowels.includes(d[i])){
        let nv = vowels[Math.floor(Math.random()*5)];
        d = d.slice(0,i) + nv + d.slice(i+1);
      }
    }
    if(d !== w) distractors.add(d);
  }
  return [word, ...distractors].sort(()=>Math.random()-.5);
}

function checkSpell(btn, sel, cor){
  if(sel.toLowerCase() === cor.toLowerCase()){
    btn.classList.add('correct');
    setTimeout(()=>showFlashcard(queue[qIdx]), 800);
  } else { btn.classList.add('wrong'); speakWord(cor); }
}

function showFlashcard(w){
  spellingStep = false;
  document.getElementById('spelling-screen').style.display='none';
  document.getElementById('card-wrap-main').style.display='block';
  document.getElementById('cf-word').textContent = w.word;
  document.getElementById('cf-ph').textContent = w.phonetic||'';
  document.getElementById('cf-type').textContent = w.type?`(${w.type})`:'';
  document.getElementById('cb-def').textContent = w.definition||'â€”';
  document.getElementById('cb-vn').textContent = w.vietnamese?`ğŸ‡»ğŸ‡³ ${w.vietnamese}`:'';
  document.getElementById('cb-ex').textContent = w.example?`"${w.example}"`:'';
  document.getElementById('flashcard').classList.remove('flipped');
  flipped = false;
  document.getElementById('rating-area').classList.remove('show');
  speakWord(w.word);
  [0,1,2,3].forEach(q=>{
    const s = sm2Sim(w,q);
    document.getElementById(`nx${q}`).textContent = s.interval===0?'<1d':s.interval+'d';
  });
}

function flipCard(){
  if(spellingStep) return;
  flipped = !flipped;
  document.getElementById('flashcard').classList.toggle('flipped', flipped);
  if(flipped) setTimeout(()=>document.getElementById('rating-area').classList.add('show'), 250);
}

function sm2Sim(w,q){
  let {interval=0,repetition=0,efactor=2.5} = w;
  if(q<1){ repetition=0; interval=0; }
  else{
    if(repetition===0) interval=1;
    else if(repetition===1) interval=6;
    else interval=Math.round(interval*efactor);
    repetition++;
    efactor=Math.max(1.3, efactor+0.1-(3-q)*(0.08+(3-q)*0.02));
  }
  return {interval,repetition,efactor};
}

function rate(q){
  const w = queue[qIdx];
  const cur = getCard(w.topicId, w.word);
  const {interval,repetition,efactor} = sm2Sim({...cur}, q);
  const dueDate = interval===0 ? Date.now()+600000 : Date.now()+interval*86400000;
  const status = interval===0?'learning':interval>=21?'mastered':interval>=4?'review':'learning';
  setCard(w.topicId, w.word, {interval,repetition,efactor,dueDate,status});
  renderHeader(); qIdx++; showCard();
}

// QUIZ
let qC=0, qW=0, qT=0, qType='meaning';
function setQType(t){ qType=t; document.querySelectorAll('.qtype-btn').forEach(b=>b.classList.toggle('active', b.id==='qt-'+t)); nextQ(); }
function initQuiz(){ qC=0; qW=0; qT=0; updateQStats(); nextQ(); }
function nextQ(){
  const words = activeTopicId ? topicWords(activeTopicId) : allWords();
  if(words.length < 4){ document.getElementById('quiz-empty').style.display='block'; document.getElementById('quiz-main').style.display='none'; return; }
  document.getElementById('quiz-empty').style.display='none'; document.getElementById('quiz-main').style.display='block';
  document.getElementById('quiz-next').classList.remove('show');
  
  const correct = words[Math.floor(Math.random()*words.length)];
  let dist = words.filter(x=>x.word!==correct.word).sort(()=>0.5-Math.random()).slice(0,3);
  const opts = [correct, ...dist].sort(()=>0.5-Math.random());
  
  if(qType==='meaning' || (qType==='random'&&Math.random()>0.5)){
    document.getElementById('q-lbl').textContent='Chá»n nghÄ©a Ä‘Ãºng';
    document.getElementById('q-word').style.display='block';
    document.getElementById('q-word').textContent=correct.word;
    document.getElementById('q-sent').style.display='none';
    document.getElementById('quiz-opts').innerHTML = opts.map(o=>`<button class="q-opt" onclick="checkQ(this,'${o.word}','${correct.word}')">${o.definition||o.vietnamese||'â€”'}</button>`).join('');
  } else {
    document.getElementById('q-lbl').textContent='Chá»n tá»« Ä‘iá»n vÃ o cÃ¢u';
    document.getElementById('q-word').style.display='none';
    document.getElementById('q-sent').style.display='block';
    document.getElementById('q-sent').textContent = correct.example ? correct.example.replace(new RegExp(correct.word, 'gi'), '_____') : `(NghÄ©a: ${correct.definition})`;
    document.getElementById('quiz-opts').innerHTML = opts.map(o=>`<button class="q-opt" style="text-align:center" onclick="checkQ(this,'${o.word}','${correct.word}')">${o.word}</button>`).join('');
  }
}
function checkQ(btn, sel, cor){
  document.querySelectorAll('.q-opt').forEach(b=>b.classList.add('disabled'));
  qT++; if(sel===cor){ btn.classList.add('correct'); qC++; } else { btn.classList.add('wrong'); qW++; }
  updateQStats(); document.getElementById('quiz-next').classList.add('show');
}
function updateQStats(){ document.getElementById('qc').textContent=qC; document.getElementById('qw').textContent=qW; document.getElementById('qt').textContent=qT; }

// PROGRESS
function renderProgress(){
  const all = allWords();
  const c = {new:0,learning:0,review:0,mastered:0};
  all.forEach(w=>c[w.status]++);
  document.getElementById('p-new').textContent=c.new;
  document.getElementById('p-learn').textContent=c.learning;
  document.getElementById('p-rev').textContent=c.review;
  document.getElementById('p-master').textContent=c.mastered;
  const p = all.length ? Math.round(c.mastered/all.length*100) : 0;
  document.getElementById('pct').textContent=p+'%';
  const circ = 2*Math.PI*62;
  document.getElementById('donut').setAttribute('stroke-dasharray', `${circ*p/100} ${circ}`);
  const log = new Set(PROGRESS.log);
  const today = new Date(); today.setHours(0,0,0,0);
  let html = '';
  for(let i=29; i>=0; i--){
    const d = new Date(today); d.setDate(d.getDate()-i);
    const k = d.toISOString().slice(0,10);
    html += `<div class="day ${log.has(k)?'ok':''}" title="${k}">${d.getDate()}</div>`;
  }
  document.getElementById('streak').innerHTML = html;
}

// NAVIGATION
function showOnly(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); if(id) document.getElementById(id).classList.add('active'); }
function switchTab(tab){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.toggle('active', b.textContent.includes(tab==='topics'?'Chá»§ Ä‘á»':tab==='study'?'Há»c':tab==='quiz'?'Quiz':'Tiáº¿n Ä‘á»™')));
  showOnly('screen-'+tab);
  if(tab==='topics') renderTopicGrid();
  if(tab==='study') initStudy();
  if(tab==='quiz') initQuiz();
  if(tab==='progress') renderProgress();
}
function toStudent(){ document.getElementById('student-app').style.display='block'; switchTab('topics'); }
function showLoginScreen(){ document.getElementById('student-app').style.display='none'; showOnly('screen-login'); }
async function doLogin(){
  const h = await sha256(document.getElementById('login-pwd').value);
  if(h===CFG.pwdHash){ isAdmin=true; showOnly('screen-admin'); renderAdminTopics(); populateSels(); loadWords(); }
  else { document.getElementById('login-err').style.display='block'; }
}
function doLogout(){ isAdmin=false; toStudent(); }

// ADMIN
function switchATab(tab, el){
  document.querySelectorAll('.a-tab').forEach(b=>b.classList.remove('active')); el.classList.add('active');
  document.querySelectorAll('.a-screen').forEach(s=>s.classList.remove('active')); document.getElementById('a-'+tab).classList.add('active');
}
function renderAdminTopics(){
  document.getElementById('a-topic-list').innerHTML = CLOUD.topics.map(t=>`
    <div class="t-row">
      <div style="font-size:22px">${t.emoji||'ğŸ“š'}</div>
      <div class="t-row-info">
        <div class="t-row-name">${t.name}</div>
        <div class="t-row-count">${(t.words||[]).length} tá»«</div>
      </div>
      <button class="btn btn-d btn-sm" onclick="deleteTopic('${t.id}')">ğŸ—‘</button>
    </div>`).join('');
}
function openTopicForm(){ document.getElementById('topic-form').style.display='block'; }
function closeTopicForm(){ document.getElementById('topic-form').style.display='none'; }
async function saveTopic(){
  const name = document.getElementById('tf-name').value.trim(); if(!name) return;
  CLOUD.topics.push({id:'t'+Date.now(), name, emoji:document.getElementById('tf-emoji').value, color:document.getElementById('tf-color').value, words:[]});
  await syncCloud(); renderAdminTopics(); populateSels(); closeTopicForm();
}
async function deleteTopic(id){ if(confirm('XoÃ¡ chá»§ Ä‘á»?')){ CLOUD.topics=CLOUD.topics.filter(x=>x.id!==id); await syncCloud(); renderAdminTopics(); populateSels(); } }
function populateSels(){
  const h = CLOUD.topics.map(t=>`<option value="${t.id}">${t.name}</option>`).join('');
  document.getElementById('a-topic-sel').innerHTML = h;
  document.getElementById('imp-topic-sel').innerHTML = h;
}
function loadWords(){
  const tid = document.getElementById('a-topic-sel').value;
  const t = CLOUD.topics.find(x=>x.id===tid); if(!t) return;
  document.getElementById('word-count-lbl').textContent = t.words.length + ' tá»«';
  renderWordsTable(t.words);
}
function renderWordsTable(words){
  const tid = document.getElementById('a-topic-sel').value;
  document.getElementById('word-tbody').innerHTML = words.map((w,i)=>`
    <tr>
      <td><strong>${w.word}</strong></td>
      <td>${w.phonetic||''}</td>
      <td>${w.vietnamese||''}</td>
      <td><button class="btn btn-d btn-sm" onclick="deleteWord('${tid}',${i})">ğŸ—‘</button></td>
    </tr>`).join('');
}
function filterAdminWords(){
  const q = document.getElementById('word-search').value.toLowerCase();
  const tid = document.getElementById('a-topic-sel').value;
  const t = CLOUD.topics.find(x=>x.id===tid);
  if(t) renderWordsTable(t.words.filter(w=>w.word.toLowerCase().includes(q) || (w.vietnamese && w.vietnamese.toLowerCase().includes(q))));
}
function openWordForm(){ document.getElementById('word-form').style.display='block'; }
function closeWordForm(){ document.getElementById('word-form').style.display='none'; }
async function saveWord(){
  const word = document.getElementById('wf-word').value.trim(); if(!word) return;
  const tid = document.getElementById('a-topic-sel').value;
  const t = CLOUD.topics.find(x=>x.id===tid);
  t.words.push({word, phonetic:document.getElementById('wf-ph').value, type:document.getElementById('wf-type').value, definition:document.getElementById('wf-def').value, example:document.getElementById('wf-ex').value, vietnamese:document.getElementById('wf-vn').value});
  await syncCloud(); loadWords(); closeWordForm();
}
async function deleteWord(tid, idx){ if(confirm('XoÃ¡ tá»« nÃ y?')){ CLOUD.topics.find(x=>x.id===tid).words.splice(idx,1); await syncCloud(); loadWords(); } }
async function syncCloud(){ await binWrite(CLOUD); showToast('ÄÃ£ Ä‘á»“ng bá»™ Cloud'); }

// AUDIO
function setAccent(a){ currentAccent=a; document.getElementById('acc-us').classList.toggle('active', a==='us'); document.getElementById('acc-uk').classList.toggle('active', a==='uk'); }
function speakWord(w){
  if(!w || !window.speechSynthesis) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(w);
  u.lang = currentAccent==='us' ? 'en-US' : 'en-GB';
  u.rate = 0.8;
  window.speechSynthesis.speak(u);
}
function speakCurrent(){ speakWord(currentWord); }

// TOOLS
function exportData(){
  const blob = new Blob([JSON.stringify(CLOUD, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=`ielts_vocab_backup_${new Date().toISOString().slice(0,10)}.json`; a.click();
}
function importData(input){
  const reader = new FileReader();
  reader.onload = async (e) => {
    try {
      const data = JSON.parse(e.target.result);
      if(data.topics){ CLOUD = data; await syncCloud(); location.reload(); }
    } catch(err){ alert('Lá»—i file JSON'); }
  };
  if(input.files[0]) reader.readAsText(input.files[0]);
}
async function doImport(){
  const tid = document.getElementById('imp-topic-sel').value;
  const file = document.getElementById('csv-file').files[0];
  if(!tid || !file) return;
  const reader = new FileReader();
  reader.onload = async (e) => {
    const lines = e.target.result.split('\n');
    const t = CLOUD.topics.find(x=>x.id===tid);
    lines.forEach(line => {
      const p = line.split(',').map(s=>s.trim().replace(/^"|"$/g, ''));
      if(p[0] && p[0].length > 1) t.words.push({word:p[0], phonetic:p[1], type:p[2], definition:p[3], example:p[4], vietnamese:p[5]});
    });
    await syncCloud(); alert('Import thÃ nh cÃ´ng!');
  };
  reader.readAsText(file);
}

function showToast(m){ const t=document.getElementById('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); }

init();
</script>
</body>
</html>
